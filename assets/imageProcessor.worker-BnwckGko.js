(function(){"use strict";const Mt=N=>{const d=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(N);return d?{r:parseInt(d[1],16),g:parseInt(d[2],16),b:parseInt(d[3],16)}:null},zt=(N,d,R=1)=>{if(d.length===0)return{r:0,g:0,b:0,hex:"#000000",id:"default"};let k=1/0,v=d[0];const{r:nt,g:X,b:E}=N;for(let z=0;z<d.length;z++){const H=d[z];let L=(nt-H.r)**2+(X-H.g)**2+(E-H.b)**2;H.id.startsWith("group-")&&(L*=R*R),L<k&&(k=L,v=H)}return v},Lt=(N,d=1)=>{const{width:R,height:k,data:v}=N,nt=new ImageData(new Uint8ClampedArray(v),R,k),X=nt.data,E=(2*d+1)**2,z=new Uint8Array(E),H=new Uint8Array(E),L=new Uint8Array(E);for(let et=0;et<k;et++)for(let G=0;G<R;G++){let e=0;for(let q=-d;q<=d;q++){const w=et+q;if(w<0||w>=k)continue;const Y=w*R;for(let ot=-d;ot<=d;ot++){const _=G+ot;if(_<0||_>=R)continue;const ht=(Y+_)*4;z[e]=v[ht],H[e]=v[ht+1],L[e]=v[ht+2],e++}}const i=z.subarray(0,e).sort(),W=H.subarray(0,e).sort(),ft=L.subarray(0,e).sort(),O=Math.floor(e/2),o=(et*R+G)*4;X[o]=i[O],X[o+1]=W[O],X[o+2]=ft[O],X[o+3]=v[o+3]}return nt};self.onmessage=async N=>{var G;if(N.data.type!=="process")return;const{imageBitmap:d,parameters:R}=N.data,{upscaleFactor:k,denoiseRadius:v,edgeProtection:nt,vertexInertia:X,disablePostProcessing:E,disableRecoloring:z,disableScaling:H,palette:L,smoothingLevels:et}=R;try{const e=d.width,i=d.height;let W=1;if(!H)if(k==="NS"){const s=Math.max(e,i),a=Math.min(e,i),D=Math.min(535/s,355/a),A=Math.min(568/s,321/a);W=Math.max(D,A)}else W=k;const ft=new OffscreenCanvas(e,i),O=ft.getContext("2d",{willReadFrequently:!0});if(!O)throw new Error("Could not get native context");if(O.drawImage(d,0,0),!E&&v>0){const s=O.getImageData(0,0,e,i),a=Lt(s,v);O.putImageData(a,0,0)}if(z){const s=Math.round(e*W),a=Math.round(i*W),D=new OffscreenCanvas(s,a),A=D.getContext("2d");if(!A)throw new Error("Could not get final context");A.imageSmoothingEnabled=!0,A.imageSmoothingQuality="high",A.drawImage(ft,0,0,s,a);const y=await D.convertToBlob({type:"image/png"});self.postMessage({type:"complete",result:y});return}const o=L,q=O.getImageData(0,0,e,i).data;let w=new Int16Array(e*i);for(let s=0;s<q.length;s+=4){const a={r:q[s],g:q[s+1],b:q[s+2]},D=zt(a,o),A=o.findIndex(y=>y.id===D.id);w[s/4]=A!==-1?A:0}const Y=E?0:nt,ot=E?0:et;if(Y>0){let s=Math.max(1,Math.round(Y/100*3)),a=Math.max(1,Math.round(Y/100*4));Y>66&&(s=3,a=3),Y>85&&(s=5,a=5);const D=new Int16Array(w.length),A=o.length;for(let y=0;y<a;y++){for(let C=0;C<i;C++){const Dt=Math.max(0,C-s),P=Math.min(i-1,C+s);for(let r=0;r<e;r++){const pt=Math.max(0,r-s),wt=Math.min(e-1,r+s),it=C*e+r,V=w[it],I=it*4,B={r:q[I],g:q[I+1],b:q[I+2]},Z=new Map;for(let c=Dt;c<=P;c++)for(let h=pt;h<=wt;h++){const g=w[c*e+h];Z.set(g,(Z.get(g)||0)+1)}const Q=Array.from(Z.entries()).sort((c,h)=>h[1]-c[1]);let S=Q[0][0],m=Q.length>1?Q[1][0]:S,mt=Q.length>2?Q[2][0]:m;if(S!==m&&m!==mt){const c=o[S],h=o[m],g=o[mt],t=Math.sqrt((c.r-g.r)**2+(c.g-g.g)**2+(c.b-g.b)**2),n=Math.sqrt((c.r-h.r)**2+(c.g-h.g)**2+(c.b-h.b)**2),b=Math.sqrt((g.r-h.r)**2+(g.g-h.g)**2+(g.b-h.b)**2);n+b<t*1.1&&(m=mt)}const At=(P-Dt+1)*(wt-pt+1);if((Z.get(m)||0)<At*.1&&(m=S),V!==S&&V!==m){const c=o[V],h=o[S],g=o[m],t=(c.r-h.r)**2+(c.g-h.g)**2+(c.b-h.b)**2,n=(c.r-g.r)**2+(c.g-g.g)**2+(c.b-g.b)**2;D[it]=t<n?S:m;continue}const T=o[S],ct=o[m];let tt=(B.r-T.r)**2+(B.g-T.g)**2+(B.b-T.b)**2,u=(B.r-ct.r)**2+(B.g-ct.g)**2+(B.b-ct.b)**2;const M=1-X/100*.8;V===S&&(tt*=M),V===m&&(u*=M),D[it]=tt<u?S:m}}w.set(D)}}const _=W*4,ht=Math.round(e*_),Qt=Math.round(i*_),Ft=1e7,Tt=ht*Qt>Ft?Math.sqrt(Ft/(e*i)):_,F=Math.round(e*Tt),J=Math.round(i*Tt),Ut=new OffscreenCanvas(F,J),st=Ut.getContext("2d",{willReadFrequently:!0});if(!st)throw new Error("Could not get workspace context");st.imageSmoothingEnabled=!0,st.imageSmoothingQuality="high",st.drawImage(ft,0,0,F,J);const K=st.getImageData(0,0,F,J).data,bt=new Uint8ClampedArray(K.length),$t=F/e,Gt=J/i;for(let s=0;s<J;s++){const a=Math.min(i-1,Math.floor(s/Gt)),D=Math.max(0,a-1),A=Math.min(i-1,a+1);for(let y=0;y<F;y++){const C=Math.min(e-1,Math.floor(y/$t)),P=(s*F+y)*4,r={r:K[P],g:K[P+1],b:K[P+2]},pt=Math.max(0,a-2),wt=Math.min(i-1,a+2),it=Math.max(0,C-2),V=Math.min(e-1,C+2);let I=new Map;for(let t=pt;t<=wt;t++){const n=Math.abs(t-a);for(let b=it;b<=V;b++){const x=Math.abs(b-C),l=w[t*e+b];let p=1;(x>0||n>0)&&(p=.5),(x>1||n>1)&&(p=.2),I.set(l,(I.get(l)||0)+p)}}const B=Array.from(I.keys()),Z=B.filter(t=>{const n=o[t],b=I.get(t)||0;for(const x of B)for(const l of B){if(x===t||l===t||x===l)continue;const p=o[x],$=o[l],Bt=I.get(x)||0,yt=I.get(l)||0,f=Math.sqrt((p.r-$.r)**2+(p.g-$.g)**2+(p.b-$.b)**2),U=Math.sqrt((p.r-n.r)**2+(p.g-n.g)**2+(p.b-n.b)**2),Ct=Math.sqrt(($.r-n.r)**2+($.g-n.g)**2+($.b-n.b)**2);if(U+Ct<f*1.1&&f>10&&Bt>b&&yt>b)return!1}return!0}),Q=new Set,S=Math.max(0,a-1),m=Math.min(i-1,a+1),mt=Math.max(0,C-1),At=Math.min(e-1,C+1);for(let t=S;t<=m;t++)for(let n=mt;n<=At;n++)Q.add(w[t*e+n]);const xt=Z.map(t=>{const n=o[t],b=I.get(t)||0,x=(r.r-n.r)**2+(r.g-n.g)**2+(r.b-n.b)**2,l=Q.has(t)?0:-1e3;return{id:t,score:b*10+l-Math.sqrt(x)}}).sort((t,n)=>n.score-t.score),T=((G=xt[0])==null?void 0:G.id)??B[0],ct=xt.length>1&&xt[1].score>-500?xt[1].id:T,tt=w[a*e+C];let u=tt,M=T;Z.includes(tt)?(u=tt,M=tt===T?ct:T):(u=T,M=ct),(I.get(M)||0)<.3&&(M=u);let g;if(u===M){const t=o[u];g={...t.targetHex?Mt(t.targetHex):{r:t.r,g:t.g,b:t.b},id:t.id}}else if(ot===0){const t=o[u],n=o[M],b=(r.r-t.r)**2+(r.g-t.g)**2+(r.b-t.b)**2,x=(r.r-n.r)**2+(r.g-n.g)**2+(r.b-n.b)**2,l=b<x?t:n;g={...l.targetHex?Mt(l.targetHex):{r:l.r,g:l.g,b:l.b},id:l.id}}else{const t=o[u],n=o[M],b=n.r-t.r,x=n.g-t.g,l=n.b-t.b,p=r.r-t.r,$=r.g-t.g,Bt=r.b-t.b,yt=b*b+x*x+l*l;let f=0;yt>0&&(f=Math.max(0,Math.min(1,(p*b+$*x+Bt*l)/yt)));const U=ot/100;let Ct=!1;if(f>0&&f<1){const It=.4*(1-U*.5);if(f<It||f>1-It){const St=(t.r+n.r)/2,j=(t.g+n.g)/2,lt=(t.b+n.b)/2,Wt=(t.r-St)**2+(t.g-j)**2+(t.b-lt)**2;let ut=!1;const dt=U>.7?3:2;for(let vt=-dt;vt<=dt;vt+=1){for(let qt=-dt;qt<=dt;qt+=1){if(qt===0&&vt===0)continue;const Jt=Math.max(0,Math.min(J-1,s+vt)),Kt=Math.max(0,Math.min(F-1,y+qt)),Ot=(Jt*F+Kt)*4,Vt=K[Ot],Zt=K[Ot+1],tn=K[Ot+2],nn=(Vt-St)**2+(Zt-j)**2+(tn-lt)**2,en=.6+U*.2;if(nn<Wt*en){ut=!0;break}}if(ut)break}ut||(Ct=!0)}}if(Ct&&(f=f<.5?0:1),f>0&&f<.25){const It=r.r,Xt=r.g,St=r.b,j=o[u],lt=o[M],Wt=(It-j.r)**2+(Xt-j.g)**2+(St-j.b)**2,ut=(j.r-lt.r)**2+(j.g-lt.g)**2+(j.b-lt.b)**2,dt=.05*(1-U);Wt<ut*dt&&(f=0)}const jt=.15*(1-U);f<jt&&(f=0),f>1-jt&&(f=1);const Rt=28*(1-U)+8*U,Nt=1/(1+Math.exp(-Rt*-.5)),_t=1/(1+Math.exp(-Rt*.5)),Ht=(1/(1+Math.exp(-Rt*(f-.5)))-Nt)/(_t-Nt),Pt=o[u],kt=o[M],gt=Pt.targetHex?Mt(Pt.targetHex):Pt,Et=kt.targetHex?Mt(kt.targetHex):kt;g={r:Math.round(gt.r+Ht*(Et.r-gt.r)),g:Math.round(gt.g+Ht*(Et.g-gt.g)),b:Math.round(gt.b+Ht*(Et.b-gt.b)),id:`blend-${u}-${M}`}}bt[P]=g.r,bt[P+1]=g.g,bt[P+2]=g.b,bt[P+3]=255}}st.putImageData(new ImageData(bt,F,J),0,0);const at=new OffscreenCanvas(Math.round(e*W),Math.round(i*W)),rt=at.getContext("2d");if(!rt)throw new Error("Could not get final context");rt.fillStyle="#000000",rt.fillRect(0,0,at.width,at.height),rt.imageSmoothingEnabled=!0,rt.imageSmoothingQuality="high",rt.drawImage(Ut,0,0,at.width,at.height);const Yt=await at.convertToBlob({type:"image/png"});self.postMessage({type:"complete",result:Yt})}catch(e){self.postMessage({type:"complete",error:e.message})}}})();
