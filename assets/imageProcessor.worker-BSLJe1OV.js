(function(){"use strict";const Re=(l,o,n)=>{const i=r=>Math.max(0,Math.min(255,Math.round(r))).toString(16).padStart(2,"0");return`#${i(l)}${i(o)}${i(n)}`.toLowerCase()},me=l=>{const o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(l);return o?{r:parseInt(o[1],16),g:parseInt(o[2],16),b:parseInt(o[3],16)}:null},Te=(l,o,n)=>{l/=255,o/=255,n/=255;const i=Math.max(l,o,n),r=Math.min(l,o,n);let f=0,M=0,g=(i+r)/2;if(i!==r){const u=i-r;switch(M=g>.5?u/(2-i-r):u/(i+r),i){case l:f=(o-n)/u+(o<n?6:0);break;case o:f=(n-l)/u+2;break;case n:f=(l-o)/u+4;break}f/=6}return{h:f*360,s:M*100,l:g*100}},Me=(l,o,n)=>{l/=360,o/=100,n/=100;const i=(g,u,I)=>(I<0&&(I+=1),I>1&&(I-=1),I<1/6?g+(u-g)*6*I:I<1/2?u:I<2/3?g+(u-g)*(2/3-I)*6:g);let r,f,M;if(o===0)r=f=M=n;else{const g=n<.5?n*(1+o):n+o-n*o,u=2*n-g;r=i(u,g,l+.3333333333333333),f=i(u,g,l),M=i(u,g,l-.3333333333333333)}return{r:Math.round(r*255),g:Math.round(f*255),b:Math.round(M*255)}},Ge=(l,o)=>{let n=o-l;return n>180&&(n-=360),n<-180&&(n+=360),n},Ee=(l,o)=>{let n=l+o;for(;n<0;)n+=360;for(;n>=360;)n-=360;return n},De=(l,o,n=1)=>{if(o.length===0)return{r:0,g:0,b:0,hex:"#000000",id:"default"};let i=1/0,r=o[0];const{r:f,g:M,b:g}=l;for(let u=0;u<o.length;u++){const I=o[u];let N=(f-I.r)**2+(M-I.g)**2+(g-I.b)**2;I.id.startsWith("group-")&&(N*=n*n),N<i&&(i=N,r=I)}return r},He=(l,o=1)=>{const{width:n,height:i,data:r}=l,f=new ImageData(new Uint8ClampedArray(r),n,i),M=f.data,g=(2*o+1)**2,u=new Uint8Array(g),I=new Uint8Array(g),N=new Uint8Array(g);for(let lt=0;lt<i;lt++)for(let Bt=0;Bt<n;Bt++){let J=0;for(let a=-o;a<=o;a++){const p=lt+a;if(p<0||p>=i)continue;const mt=p*n;for(let jt=-o;jt<=o;jt++){const wt=Bt+jt;if(wt<0||wt>=n)continue;const Dt=(mt+wt)*4;u[J]=r[Dt],I[J]=r[Dt+1],N[J]=r[Dt+2],J++}}const Rt=u.subarray(0,J).sort(),Pt=I.subarray(0,J).sort(),Tt=N.subarray(0,J).sort(),Gt=Math.floor(J/2),Et=(lt*n+Bt)*4;M[Et]=Rt[Gt],M[Et+1]=Pt[Gt],M[Et+2]=Tt[Gt],M[Et+3]=r[Et+3]}return f};function Yt(l,o,n,i,r){const f=Te(l,o,n);if(f.s<5){const Tt=r.lightnessForce/100,Gt=Math.max(0,Math.min(100,f.l+r.lightness*Tt));return Me(f.h,f.s,Gt)}const M=Ge(i,f.h),g=Ee(r.hue,M),u=r.hueForce/100,I=r.saturationForce/100,N=r.lightnessForce/100,lt=u<1?f.h+(g-f.h)*u:g,Bt=r.saturation*I,J=Math.max(0,Math.min(100,f.s+Bt)),Rt=r.lightness*N,Pt=Math.max(0,Math.min(100,f.l+Rt));return Me(lt,J,Pt)}async function qe(l,o,n,i=.5,r=1){let f=null,M=i,g=i,u=r;const I=.01;for(;u-g>I;){const N=(g+u)/2,lt=await l.convertToBlob({type:o,quality:N});lt.size<=n?(f=lt,M=N,g=N):u=N}return{blob:f,quality:M}}async function le(l,o){if(!o)return await l.convertToBlob({type:"image/png"});const i=await l.convertToBlob({type:"image/png"});if(i.size<=153600)return i;let r=i,f="png";try{const M=await l.convertToBlob({type:"image/gif"});M.size<=153600&&(r=M,f="gif")}catch{}if(f==="png"){const M=await qe(l,"image/jpeg",153600,.5,1);M.blob&&M.blob.size<=153600&&(r=M.blob,f="jpeg")}return r}self.onmessage=async l=>{var Gt,Et;if(l.data.type!=="process")return;const{imageBitmap:o,parameters:n}=l.data,{upscaleFactor:i,denoiseRadius:r,edgeProtection:f,vertexInertia:M,disablePostProcessing:g,disableRecoloring:u,disableScaling:I,palette:N,smoothingLevels:lt,alphaSmoothness:Bt,preserveTransparency:J,pixelArtConfig:Rt,recolorMode:Pt,tintOverrides:Tt}=n;try{const a=o.width,p=o.height;if(Rt!=null&&Rt.enabled){const{pixelWidth:t,pixelHeight:s,offsetX:v,offsetY:w}=Rt,T=Math.ceil(a/t),_=Math.ceil(p/s),B=new OffscreenCanvas(a,p).getContext("2d",{willReadFrequently:!0,alpha:!0});if(!B)throw new Error("Could not get source context");B.imageSmoothingEnabled=!1,B.drawImage(o,0,0);const y=B.getImageData(0,0,a,p),S=new OffscreenCanvas(T,_),ft=S.getContext("2d");if(!ft)throw new Error("Could not get pixel context");const et=ft.createImageData(T,_);for(let b=0;b<_;b++)for(let K=0;K<T;K++){const m=new Map,X=Math.max(0,Math.min(K*t+v,a-1)),k=Math.max(0,Math.min(b*s+w,p-1)),dt=Math.max(0,Math.min(X+t,a)),bt=Math.max(0,Math.min(k+s,p));for(let h=k;h<bt;h++)for(let Z=X;Z<dt;Z++){const tt=(h*a+Z)*4,L=y.data[tt],z=y.data[tt+1],x=y.data[tt+2],G=y.data[tt+3],e=`${L},${z},${x},${G}`,c=m.get(e);c?c.count++:m.set(e,{count:1,r:L,g:z,b:x,a:G})}let St=0,$={r:0,g:0,b:0,a:255};for(const h of m.values())h.count>St&&(St=h.count,$=h);let V=$;if(!u&&N.length>0){const h={r:$.r,g:$.g,b:$.b},Z=De(h,N);if(Pt==="tint"&&Tt){const tt=Tt[Z.id];if(tt!==void 0){const L=(Gt=n.colorGroups)==null?void 0:Gt.find(G=>G.id===Z.id),z=(L==null?void 0:L.baseHue)??0;V={...Yt($.r,$.g,$.b,z,tt),a:$.a}}}else if(Z.targetHex){const tt=me(Z.targetHex);tt&&(V={...tt,a:$.a})}else V={r:Z.r,g:Z.g,b:Z.b,a:$.a}}const d=(b*T+K)*4;et.data[d]=V.r,et.data[d+1]=V.g,et.data[d+2]=V.b,et.data[d+3]=J?V.a:255}ft.putImageData(et,0,0);let nt=1;if(!I){let b,K;if(i==="NS"){const k=a>=p;b=k?535:321,K=k?355:568}else{const k=i;b=a*k,K=p*k}const m=Math.floor(b/T),X=Math.floor(K/_);nt=Math.max(1,Math.min(m,X))}const ct=T*nt,ot=_*nt,it=new OffscreenCanvas(ct,ot),Mt=it.getContext("2d");if(!Mt)throw new Error("Could not get final context");Mt.imageSmoothingEnabled=!1,Mt.drawImage(S,0,0,ct,ot);const $t=await le(it,i==="NS");self.postMessage({type:"complete",result:$t});return}let mt=1;I||(i==="NS"?a>=p?mt=Math.min(535/a,355/p):mt=Math.min(321/a,568/p):mt=i);const jt=new OffscreenCanvas(a,p),wt=jt.getContext("2d",{willReadFrequently:!0,alpha:!0});if(!wt)throw new Error("Could not get native context");if(wt.drawImage(o,0,0),!g&&r>0){const t=wt.getImageData(0,0,a,p),s=He(t,r);wt.putImageData(s,0,0)}if(u){const t=Math.round(a*mt),s=Math.round(p*mt),v=new OffscreenCanvas(t,s),w=v.getContext("2d");if(!w)throw new Error("Could not get final context");w.imageSmoothingEnabled=!0,w.imageSmoothingQuality="high",w.drawImage(jt,0,0,t,s);const T=await le(v,i==="NS");self.postMessage({type:"complete",result:T});return}const Dt=N,yt=wt.getImageData(0,0,a,p).data;let Ht=new Int16Array(a*p),Vt=null;if(J){Vt=new Uint8ClampedArray(a*p);for(let t=0;t<yt.length;t+=4)Vt[t/4]=yt[t+3]}const te=new Map,be=new Map,F=Dt.length,D=new Uint8Array(F),H=new Uint8Array(F),q=new Uint8Array(F),Oe=new Array(F);for(let t=0;t<F;t++){const s=Dt[t];be.set(s.id,t),D[t]=s.r,H[t]=s.g,q[t]=s.b,Oe[t]=s.id}if(n.colorGroups)for(let t=0;t<n.colorGroups.length;t++){const s=n.colorGroups[t],v=be.get(s.id);if(v!==void 0)for(let w=0;w<s.members.length;w++)te.set(s.members[w].hex.toLowerCase(),v)}for(let t=0;t<F;t++){const s=Dt[t].hex.toLowerCase();te.has(s)||te.set(s,t)}for(let t=0;t<yt.length;t+=4){const s=yt[t],v=yt[t+1],w=yt[t+2],T=Re(s,v,w);let _=te.get(T);if(_===void 0){let Q=1/0,B=0;for(let y=0;y<F;y++){const S=s-D[y],ft=v-H[y],et=w-q[y],nt=S*S+ft*ft+et*et;nt<Q&&(Q=nt,B=y)}_=B}Ht[t/4]=_}const _t=g?0:f,we=g?0:lt;if(_t>0){let t=Math.max(1,Math.round(_t/100*3)),s=Math.max(1,Math.round(_t/100*4));_t>66&&(t=3,s=3),_t>85&&(t=5,s=5);const v=new Int16Array(Ht.length),w=new Uint32Array(F);for(let T=0;T<s;T++){for(let _=0;_<p;_++){const Q=Math.max(0,_-t),B=Math.min(p-1,_+t),y=_*a;for(let S=0;S<a;S++){const ft=Math.max(0,S-t),et=Math.min(a-1,S+t),nt=y+S,ct=Ht[nt],ot=nt*4,it=yt[ot],Mt=yt[ot+1],$t=yt[ot+2];w.fill(0);for(let x=Q;x<=B;x++){const G=x*a;for(let e=ft;e<=et;e++){const c=Ht[G+e];w[c]++}}let b=0,K=0,m=0,X=0,k=0,dt=0;for(let x=0;x<F;x++){const G=w[x];G>K?(k=m,dt=X,m=b,X=K,b=x,K=G):G>X?(k=m,dt=X,m=x,X=G):G>dt&&(k=x,dt=G)}if(b!==m&&m!==k){const x=D[b],G=H[b],e=q[b],c=D[m],C=H[m],R=q[m],U=D[k],O=H[k],A=q[k],E=Math.sqrt((x-U)**2+(G-O)**2+(e-A)**2),W=Math.sqrt((x-c)**2+(G-C)**2+(e-R)**2),Y=Math.sqrt((U-c)**2+(O-C)**2+(A-R)**2);W+Y<E*1.1&&(m=k,X=dt)}const bt=(B-Q+1)*(et-ft+1);if(X<bt*.1&&(m=b),ct!==b&&ct!==m){const x=D[ct],G=H[ct],e=q[ct],c=D[b],C=H[b],R=q[b],U=D[m],O=H[m],A=q[m],E=(x-c)**2+(G-C)**2+(e-R)**2,W=(x-U)**2+(G-O)**2+(e-A)**2;v[nt]=E<W?b:m;continue}const St=D[b],$=H[b],V=q[b],d=D[m],h=H[m],Z=q[m];let tt=(it-St)**2+(Mt-$)**2+($t-V)**2,L=(it-d)**2+(Mt-h)**2+($t-Z)**2;const z=1-M/100*.8;ct===b&&(tt*=z),ct===m&&(L*=z),v[nt]=tt<L?b:m}}Ht.set(v)}}const fe=mt*4,Fe=Math.round(a*fe),ke=Math.round(p*fe),ye=1e7,Ce=Fe*ke>ye?Math.sqrt(ye/(a*p)):fe,Ct=Math.round(a*Ce),Lt=Math.round(p*Ce),Ie=new OffscreenCanvas(Ct,Lt),Nt=Ie.getContext("2d",{willReadFrequently:!0,alpha:!0});if(!Nt)throw new Error("Could not get workspace context");Nt.imageSmoothingEnabled=!0,Nt.imageSmoothingQuality="high",Nt.drawImage(jt,0,0,Ct,Lt);const qt=Nt.getImageData(0,0,Ct,Lt).data,Zt=new Uint8ClampedArray(qt.length),Ue=Ct/a,je=Lt/p,Ot=new Uint8Array(F),Ft=new Uint8Array(F),kt=new Uint8Array(F),Qt=new Float32Array(F),It=new Array(F).fill(null),Xt=new Uint8Array(F),ee=Pt==="tint"&&Tt;for(let t=0;t<F;t++){const s=Dt[t];if(ee){const v=Tt[s.id];if(v!==void 0){const w=(Et=n.colorGroups)==null?void 0:Et.find(T=>T.id===s.id);Qt[t]=(w==null?void 0:w.baseHue)??0,It[t]=v,Xt[t]=1}else Xt[t]=0;Ot[t]=D[t],Ft[t]=H[t],kt[t]=q[t]}else if(s.targetHex){const v=me(s.targetHex);v?(Ot[t]=v.r,Ft[t]=v.g,kt[t]=v.b):(Ot[t]=D[t],Ft[t]=H[t],kt[t]=q[t])}else Ot[t]=D[t],Ft[t]=H[t],kt[t]=q[t]}const Ut=new Float32Array(F),de=new Uint8Array(F),he=new Float32Array(F);for(let t=0;t<Lt;t++){const s=Math.min(p-1,Math.floor(t/je)),v=s*a;for(let w=0;w<Ct;w++){const T=Math.min(a-1,Math.floor(w/Ue)),Q=(t*Ct+w)*4,B=qt[Q],y=qt[Q+1],S=qt[Q+2],ft=Math.max(0,s-2),et=Math.min(p-1,s+2),nt=Math.max(0,T-2),ct=Math.min(a-1,T+2);Ut.fill(0);for(let e=ft;e<=et;e++){const c=Math.abs(e-s),C=e*a;for(let R=nt;R<=ct;R++){const U=Math.abs(R-T),O=Ht[C+R];let A=1;(U>0||c>0)&&(A=.5),(U>1||c>1)&&(A=.2),Ut[O]+=A}}const ot=[];for(let e=0;e<F;e++)Ut[e]>0&&ot.push(e);const it=[],Mt=ot.length;t:for(let e=0;e<Mt;e++){const c=ot[e],C=D[c],R=H[c],U=q[c],O=Ut[c];for(let A=0;A<Mt;A++){const E=ot[A];if(E!==c)for(let W=0;W<Mt;W++){const Y=ot[W];if(Y===c||E===Y)continue;const At=D[E],ht=H[E],Wt=q[E],j=D[Y],P=H[Y],vt=q[Y],se=Ut[E],Jt=Ut[Y],Kt=Math.sqrt((At-j)**2+(ht-P)**2+(Wt-vt)**2),ge=Math.sqrt((At-C)**2+(ht-R)**2+(Wt-U)**2),Se=Math.sqrt((j-C)**2+(P-R)**2+(vt-U)**2);if(ge+Se<Kt*1.1&&Kt>10&&se>O&&Jt>O)continue t}}it.push(c)}de.fill(0);const $t=Math.max(0,s-1),b=Math.min(p-1,s+1),K=Math.max(0,T-1),m=Math.min(a-1,T+1);for(let e=$t;e<=b;e++){const c=e*a;for(let C=K;C<=m;C++)de[Ht[c+C]]=1}const X=it.length;let k=-1/0,dt=0;for(let e=0;e<X;e++){const c=it[e],C=D[c],R=H[c],U=q[c],O=Ut[c],A=B-C,E=y-R,W=S-U,Y=A*A+E*E+W*W,At=de[c]?0:-1e3,ht=O*10+At-Math.sqrt(Y);he[e]=ht,ht>k&&(k=ht,dt=e)}let bt=X>0?it[dt]:ot[0],St=bt,$=-1/0;for(let e=0;e<X;e++)e!==dt&&he[e]>$&&($=he[e],St=it[e]);$<=-500&&(St=bt);const V=Ht[v+T];let d=V,h=bt,Z=!1;for(let e=0;e<X;e++)if(it[e]===V){Z=!0;break}Z?(d=V,h=V===bt?St:bt):(d=bt,h=St),Ut[h]<.3&&(h=d);let L,z,x;if(d===h)if(ee)if(Xt[d]&&It[d]){const e=Yt(B,y,S,Qt[d],It[d]);L=e.r,z=e.g,x=e.b}else L=B,z=y,x=S;else L=Ot[d],z=Ft[d],x=kt[d];else if(we===0){const e=D[d],c=H[d],C=q[d],R=D[h],U=H[h],O=q[h],A=B-e,E=y-c,W=S-C,Y=B-R,At=y-U,ht=S-O,Wt=A*A+E*E+W*W,j=Y*Y+At*At+ht*ht,P=Wt<j?d:h;if(ee)if(Xt[P]&&It[P]){const vt=Yt(B,y,S,Qt[P],It[P]);L=vt.r,z=vt.g,x=vt.b}else L=B,z=y,x=S;else L=Ot[P],z=Ft[P],x=kt[P]}else{const e=D[d],c=H[d],C=q[d],R=D[h],U=H[h],O=q[h],A=R-e,E=U-c,W=O-C,Y=B-e,At=y-c,ht=S-C,Wt=A*A+E*E+W*W;let j=0;Wt>0&&(j=Math.max(0,Math.min(1,(Y*A+At*E+ht*W)/Wt)));const P=we/100;let vt=!1;if(j>0&&j<1){const st=.4*(1-P*.5);if(j<st||j>1-st){const at=(e+R)/2,ut=(c+U)/2,pt=(C+O)/2,xt=e-at,rt=c-ut,ae=C-pt,ue=xt*xt+rt*rt+ae*ae;let pe=!1;const ce=P>.7?3:2;for(let ie=-ce;ie<=ce;ie+=1){for(let re=-ce;re<=ce;re+=1){if(re===0&&ie===0)continue;const We=Math.max(0,Math.min(Lt-1,t+ie)),Pe=Math.max(0,Math.min(Ct-1,w+re)),xe=(We*Ct+Pe)*4,Ne=qt[xe],Xe=qt[xe+1],$e=qt[xe+2],Ae=Ne-at,ve=Xe-ut,Be=$e-pt,ze=Ae*Ae+ve*ve+Be*Be,Ye=.6+P*.2;if(ze<ue*Ye){pe=!0;break}}if(pe)break}pe||(vt=!0)}}if(vt&&(j=j<.5?0:1),j>0&&j<.25){const st=B-e,gt=y-c,at=S-C,ut=e-R,pt=c-U,xt=C-O,rt=st*st+gt*gt+at*at,ae=ut*ut+pt*pt+xt*xt,ue=.05*(1-P);rt<ae*ue&&(j=0)}const se=.15*(1-P);j<se&&(j=0),j>1-se&&(j=1);const Jt=28*(1-P)+8*P,Kt=1/(1+Math.exp(-Jt*-.5)),ge=1/(1+Math.exp(-Jt*.5)),zt=(1/(1+Math.exp(-Jt*(j-.5)))-Kt)/(ge-Kt);if(ee){let st,gt,at,ut,pt,xt;if(Xt[d]&&It[d]){const rt=Yt(B,y,S,Qt[d],It[d]);st=rt.r,gt=rt.g,at=rt.b}else st=B,gt=y,at=S;if(Xt[h]&&It[h]){const rt=Yt(B,y,S,Qt[h],It[h]);ut=rt.r,pt=rt.g,xt=rt.b}else ut=B,pt=y,xt=S;L=Math.round(st+zt*(ut-st)),z=Math.round(gt+zt*(pt-gt)),x=Math.round(at+zt*(xt-at))}else{const st=Ot[d],gt=Ft[d],at=kt[d],ut=Ot[h],pt=Ft[h],xt=kt[h];L=Math.round(st+zt*(ut-st)),z=Math.round(gt+zt*(pt-gt)),x=Math.round(at+zt*(xt-at))}}let G=255;if(J&&Vt){const e=s*a+T,c=Vt[e],C=qt[Q+3],R=(Bt||0)/100;if(R===0)G=c;else{const U=C/255,O=20*(1-R)+2*R,A=1/(1+Math.exp(-O*-.5)),E=1/(1+Math.exp(-O*.5)),Y=(1/(1+Math.exp(-O*(U-.5)))-A)/(E-A);G=Math.round(Y*255)}}Zt[Q]=L,Zt[Q+1]=z,Zt[Q+2]=x,Zt[Q+3]=G}}Nt.putImageData(new ImageData(Zt,Ct,Lt),0,0);const ne=new OffscreenCanvas(Math.round(a*mt),Math.round(p*mt)),oe=ne.getContext("2d",{alpha:!0});if(!oe)throw new Error("Could not get final context");oe.imageSmoothingEnabled=!0,oe.imageSmoothingQuality="high",oe.drawImage(Ie,0,0,ne.width,ne.height);const Le=await le(ne,i==="NS");self.postMessage({type:"complete",result:Le})}catch(a){self.postMessage({type:"complete",error:a.message})}}})();
