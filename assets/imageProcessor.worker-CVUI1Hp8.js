(function(){"use strict";const vn=(E,f,B)=>{const d=I=>Math.max(0,Math.min(255,Math.round(I))).toString(16).padStart(2,"0");return`#${d(E)}${d(f)}${d(B)}`.toLowerCase()},gn=E=>{const f=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(E);return f?{r:parseInt(f[1],16),g:parseInt(f[2],16),b:parseInt(f[3],16)}:null},Bn=(E,f,B=1)=>{if(f.length===0)return{r:0,g:0,b:0,hex:"#000000",id:"default"};let d=1/0,I=f[0];const{r:L,g:S,b:X}=E;for(let $=0;$<f.length;$++){const z=f[$];let H=(L-z.r)**2+(S-z.g)**2+(X-z.b)**2;z.id.startsWith("group-")&&(H*=B*B),H<d&&(d=H,I=z)}return I},Rn=(E,f=1)=>{const{width:B,height:d,data:I}=E,L=new ImageData(new Uint8ClampedArray(I),B,d),S=L.data,X=(2*f+1)**2,$=new Uint8Array(X),z=new Uint8Array(X),H=new Uint8Array(X);for(let ut=0;ut<d;ut++)for(let Ot=0;Ot<B;Ot++){let K=0;for(let Mt=-f;Mt<=f;Mt++){const Ct=ut+Mt;if(Ct<0||Ct>=d)continue;const at=Ct*B;for(let tt=-f;tt<=f;tt++){const Rt=Ot+tt;if(Rt<0||Rt>=B)continue;const It=(at+Rt)*4;$[K]=I[It],z[K]=I[It+1],H[K]=I[It+2],K++}}const Ut=$.subarray(0,K).sort(),o=z.subarray(0,K).sort(),c=H.subarray(0,K).sort(),V=Math.floor(K/2),mt=(ut*B+Ot)*4;S[mt]=Ut[V],S[mt+1]=o[V],S[mt+2]=c[V],S[mt+3]=I[mt+3]}return L};async function En(E,f,B,d=.5,I=1){let L=null,S=d,X=d,$=I;const z=.01;for(;$-X>z;){const H=(X+$)/2,ut=await E.convertToBlob({type:f,quality:H});ut.size<=B?(L=ut,S=H,X=H):$=H}return{blob:L,quality:S}}async function en(E,f){if(!f)return await E.convertToBlob({type:"image/png"});const d=await E.convertToBlob({type:"image/png"});if(d.size<=153600)return d;let I=d,L="png";try{const S=await E.convertToBlob({type:"image/gif"});S.size<=153600&&(I=S,L="gif")}catch{}if(L==="png"){const S=await En(E,"image/jpeg",153600,.5,1);S.blob&&S.blob.size<=153600&&(I=S.blob,L="jpeg")}return I}self.onmessage=async E=>{if(E.data.type!=="process")return;const{imageBitmap:f,parameters:B}=E.data,{upscaleFactor:d,denoiseRadius:I,edgeProtection:L,vertexInertia:S,disablePostProcessing:X,disableRecoloring:$,disableScaling:z,palette:H,smoothingLevels:ut,alphaSmoothness:Ot,preserveTransparency:K,pixelArtConfig:Ut}=B;try{const o=f.width,c=f.height;if(Ut!=null&&Ut.enabled){const{pixelWidth:t,pixelHeight:e,offsetX:x,offsetY:p}=Ut,u=Math.ceil(o/t),O=Math.ceil(c/e),U=new OffscreenCanvas(o,c).getContext("2d",{willReadFrequently:!0,alpha:!0});if(!U)throw new Error("Could not get source context");U.imageSmoothingEnabled=!1,U.drawImage(f,0,0);const A=U.getImageData(0,0,o,c),T=new OffscreenCanvas(u,O),ct=T.getContext("2d");if(!ct)throw new Error("Could not get pixel context");const Y=ct.createImageData(u,O);for(let r=0;r<O;r++)for(let P=0;P<u;P++){const a=new Map,D=Math.max(0,Math.min(P*t+x,o-1)),y=Math.max(0,Math.min(r*e+p,c-1)),rt=Math.max(0,Math.min(D+t,o)),gt=Math.max(0,Math.min(y+e,c));for(let i=y;i<gt;i++)for(let it=D;it<rt;it++){const lt=(i*o+it)*4,pt=A.data[lt],xt=A.data[lt+1],g=A.data[lt+2],v=A.data[lt+3],F=`${pt},${xt},${g},${v}`,ft=a.get(F);ft?ft.count++:a.set(F,{count:1,r:pt,g:xt,b:g,a:v})}let bt=0,ot={r:0,g:0,b:0,a:255};for(const i of a.values())i.count>bt&&(bt=i.count,ot=i);let st=ot;if(!$&&H.length>0){const i={r:ot.r,g:ot.g,b:ot.b},it=Bn(i,H);if(it.targetHex){const lt=gn(it.targetHex);lt&&(st={...lt,a:ot.a})}}const h=(r*u+P)*4;Y.data[h]=st.r,Y.data[h+1]=st.g,Y.data[h+2]=st.b,Y.data[h+3]=K?st.a:255}ct.putImageData(Y,0,0);let _=1;if(!z){let r,P;if(d==="NS"){const y=o>=c;r=y?535:321,P=y?355:568}else{const y=d;r=o*y,P=c*y}const a=Math.floor(r/u),D=Math.floor(P/O);_=Math.max(1,Math.min(a,D))}const nt=u*_,Z=O*_,et=new OffscreenCanvas(nt,Z),ht=et.getContext("2d");if(!ht)throw new Error("Could not get final context");ht.imageSmoothingEnabled=!1,ht.drawImage(T,0,0,nt,Z);const kt=await en(et,d==="NS");self.postMessage({type:"complete",result:kt});return}let V=1;z||(d==="NS"?o>=c?V=Math.min(535/o,355/c):V=Math.min(321/o,568/c):V=d);const mt=new OffscreenCanvas(o,c),Mt=mt.getContext("2d",{willReadFrequently:!0,alpha:!0});if(!Mt)throw new Error("Could not get native context");if(Mt.drawImage(f,0,0),!X&&I>0){const t=Mt.getImageData(0,0,o,c),e=Rn(t,I);Mt.putImageData(e,0,0)}if($){const t=Math.round(o*V),e=Math.round(c*V),x=new OffscreenCanvas(t,e),p=x.getContext("2d");if(!p)throw new Error("Could not get final context");p.imageSmoothingEnabled=!0,p.imageSmoothingQuality="high",p.drawImage(mt,0,0,t,e);const u=await en(x,d==="NS");self.postMessage({type:"complete",result:u});return}const Ct=H,at=Mt.getImageData(0,0,o,c).data;let tt=new Int16Array(o*c),Rt=null;if(K){Rt=new Uint8ClampedArray(o*c);for(let t=0;t<at.length;t+=4)Rt[t/4]=at[t+3]}const It=new Map,pn=new Map,G=Ct.length,M=new Uint8Array(G),w=new Uint8Array(G),b=new Uint8Array(G),Gn=new Array(G);for(let t=0;t<G;t++){const e=Ct[t];pn.set(e.id,t),M[t]=e.r,w[t]=e.g,b[t]=e.b,Gn[t]=e.id}if(B.colorGroups)for(let t=0;t<B.colorGroups.length;t++){const e=B.colorGroups[t],x=pn.get(e.id);if(x!==void 0)for(let p=0;p<e.members.length;p++)It.set(e.members[p].hex.toLowerCase(),x)}for(let t=0;t<G;t++){const e=Ct[t].hex.toLowerCase();It.has(e)||It.set(e,t)}for(let t=0;t<at.length;t+=4){const e=at[t],x=at[t+1],p=at[t+2],u=vn(e,x,p);let O=It.get(u);if(O===void 0){let W=1/0,U=0;for(let A=0;A<G;A++){const T=e-M[A],ct=x-w[A],Y=p-b[A],_=T*T+ct*ct+Y*Y;_<W&&(W=_,U=A)}O=U}tt[t/4]=O}const Ht=X?0:L,xn=X?0:ut;if(Ht>0){let t=Math.max(1,Math.round(Ht/100*3)),e=Math.max(1,Math.round(Ht/100*4));Ht>66&&(t=3,e=3),Ht>85&&(t=5,e=5);const x=new Int16Array(tt.length),p=new Uint32Array(G);for(let u=0;u<e;u++){for(let O=0;O<c;O++){const W=Math.max(0,O-t),U=Math.min(c-1,O+t),A=O*o;for(let T=0;T<o;T++){const ct=Math.max(0,T-t),Y=Math.min(o-1,T+t),_=A+T,nt=tt[_],Z=_*4,et=at[Z],ht=at[Z+1],kt=at[Z+2];p.fill(0);for(let g=W;g<=U;g++){const v=g*o;for(let F=ct;F<=Y;F++){const ft=tt[v+F];p[ft]++}}let r=0,P=0,a=0,D=0,y=0,rt=0;for(let g=0;g<G;g++){const v=p[g];v>P?(y=a,rt=D,a=r,D=P,r=g,P=v):v>D?(y=a,rt=D,a=g,D=v):v>rt&&(y=g,rt=v)}if(r!==a&&a!==y){const g=M[r],v=w[r],F=b[r],ft=M[a],vt=w[a],Bt=b[a],n=M[y],s=w[y],l=b[y],m=Math.sqrt((g-n)**2+(v-s)**2+(F-l)**2),R=Math.sqrt((g-ft)**2+(v-vt)**2+(F-Bt)**2),j=Math.sqrt((n-ft)**2+(s-vt)**2+(l-Bt)**2);R+j<m*1.1&&(a=y,D=rt)}const gt=(U-W+1)*(Y-ct+1);if(D<gt*.1&&(a=r),nt!==r&&nt!==a){const g=M[nt],v=w[nt],F=b[nt],ft=M[r],vt=w[r],Bt=b[r],n=M[a],s=w[a],l=b[a],m=(g-ft)**2+(v-vt)**2+(F-Bt)**2,R=(g-n)**2+(v-s)**2+(F-l)**2;x[_]=m<R?r:a;continue}const bt=M[r],ot=w[r],st=b[r],h=M[a],i=w[a],it=b[a];let lt=(et-bt)**2+(ht-ot)**2+(kt-st)**2,pt=(et-h)**2+(ht-i)**2+(kt-it)**2;const xt=1-S/100*.8;nt===r&&(lt*=xt),nt===a&&(pt*=xt),x[_]=lt<pt?r:a}}tt.set(x)}}const on=V*4,Tn=Math.round(o*on),Dn=Math.round(c*on),un=1e7,mn=Tn*Dn>un?Math.sqrt(un/(o*c)):on,wt=Math.round(o*mn),Et=Math.round(c*mn),Mn=new OffscreenCanvas(wt,Et),jt=Mn.getContext("2d",{willReadFrequently:!0,alpha:!0});if(!jt)throw new Error("Could not get workspace context");jt.imageSmoothingEnabled=!0,jt.imageSmoothingQuality="high",jt.drawImage(mt,0,0,wt,Et);const St=jt.getImageData(0,0,wt,Et).data,Wt=new Uint8ClampedArray(St.length),qn=wt/o,On=Et/c,Gt=new Uint8Array(G),Tt=new Uint8Array(G),Dt=new Uint8Array(G);for(let t=0;t<G;t++){const e=Ct[t];if(e.targetHex){const x=gn(e.targetHex);x?(Gt[t]=x.r,Tt[t]=x.g,Dt[t]=x.b):(Gt[t]=M[t],Tt[t]=w[t],Dt[t]=b[t])}else Gt[t]=M[t],Tt[t]=w[t],Dt[t]=b[t]}const At=new Float32Array(G),sn=new Uint8Array(G),an=new Float32Array(G);for(let t=0;t<Et;t++){const e=Math.min(c-1,Math.floor(t/On)),x=e*o;for(let p=0;p<wt;p++){const u=Math.min(o-1,Math.floor(p/qn)),W=(t*wt+p)*4,U=St[W],A=St[W+1],T=St[W+2],ct=Math.max(0,e-2),Y=Math.min(c-1,e+2),_=Math.max(0,u-2),nt=Math.min(o-1,u+2);At.fill(0);for(let n=ct;n<=Y;n++){const s=Math.abs(n-e),l=n*o;for(let m=_;m<=nt;m++){const R=Math.abs(m-u),j=tt[l+m];let q=1;(R>0||s>0)&&(q=.5),(R>1||s>1)&&(q=.2),At[j]+=q}}const Z=[];for(let n=0;n<G;n++)At[n]>0&&Z.push(n);const et=[],ht=Z.length;t:for(let n=0;n<ht;n++){const s=Z[n],l=M[s],m=w[s],R=b[s],j=At[s];for(let q=0;q<ht;q++){const k=Z[q];if(k!==s)for(let Q=0;Q<ht;Q++){const J=Z[Q];if(J===s||k===J)continue;const yt=M[k],dt=w[k],qt=b[k],C=M[J],N=w[J],Lt=b[J],Qt=At[k],Pt=At[J],Ft=Math.sqrt((yt-C)**2+(dt-N)**2+(qt-Lt)**2),cn=Math.sqrt((yt-l)**2+(dt-m)**2+(qt-R)**2),wn=Math.sqrt((C-l)**2+(N-m)**2+(Lt-R)**2);if(cn+wn<Ft*1.1&&Ft>10&&Qt>j&&Pt>j)continue t}}et.push(s)}sn.fill(0);const kt=Math.max(0,e-1),r=Math.min(c-1,e+1),P=Math.max(0,u-1),a=Math.min(o-1,u+1);for(let n=kt;n<=r;n++){const s=n*o;for(let l=P;l<=a;l++)sn[tt[s+l]]=1}const D=et.length;let y=-1/0,rt=0;for(let n=0;n<D;n++){const s=et[n],l=M[s],m=w[s],R=b[s],j=At[s],q=U-l,k=A-m,Q=T-R,J=q*q+k*k+Q*Q,yt=sn[s]?0:-1e3,dt=j*10+yt-Math.sqrt(J);an[n]=dt,dt>y&&(y=dt,rt=n)}let gt=D>0?et[rt]:Z[0],bt=gt,ot=-1/0;for(let n=0;n<D;n++)n!==rt&&an[n]>ot&&(ot=an[n],bt=et[n]);ot<=-500&&(bt=gt);const st=tt[x+u];let h=st,i=gt,it=!1;for(let n=0;n<D;n++)if(et[n]===st){it=!0;break}it?(h=st,i=st===gt?bt:gt):(h=gt,i=bt),At[i]<.3&&(i=h);let pt,xt,g;if(h===i)pt=Gt[h],xt=Tt[h],g=Dt[h];else if(xn===0){const n=M[h],s=w[h],l=b[h],m=M[i],R=w[i],j=b[i],q=U-n,k=A-s,Q=T-l,J=U-m,yt=A-R,dt=T-j,qt=q*q+k*k+Q*Q,C=J*J+yt*yt+dt*dt,N=qt<C?h:i;pt=Gt[N],xt=Tt[N],g=Dt[N]}else{const n=M[h],s=w[h],l=b[h],m=M[i],R=w[i],j=b[i],q=m-n,k=R-s,Q=j-l,J=U-n,yt=A-s,dt=T-l,qt=q*q+k*k+Q*Q;let C=0;qt>0&&(C=Math.max(0,Math.min(1,(J*q+yt*k+dt*Q)/qt)));const N=xn/100;let Lt=!1;if(C>0&&C<1){const Nt=.4*(1-N*.5);if(C<Nt||C>1-Nt){const Xt=(n+m)/2,$t=(s+R)/2,zt=(l+j)/2,Yt=n-Xt,Jt=s-$t,Kt=l-zt,fn=Yt*Yt+Jt*Jt+Kt*Kt;let dn=!1;const Vt=N>.7?3:2;for(let tn=-Vt;tn<=Vt;tn+=1){for(let nn=-Vt;nn<=Vt;nn+=1){if(nn===0&&tn===0)continue;const Wn=Math.max(0,Math.min(Et-1,t+tn)),Ln=Math.max(0,Math.min(wt-1,p+nn)),hn=(Wn*wt+Ln)*4,Pn=St[hn],Fn=St[hn+1],Nn=St[hn+2],In=Pn-Xt,Sn=Fn-$t,An=Nn-zt,Xn=In*In+Sn*Sn+An*An,$n=.6+N*.2;if(Xn<fn*$n){dn=!0;break}}if(dn)break}dn||(Lt=!0)}}if(Lt&&(C=C<.5?0:1),C>0&&C<.25){const Nt=U-n,ln=A-s,Xt=T-l,$t=n-m,zt=s-R,Yt=l-j,Jt=Nt*Nt+ln*ln+Xt*Xt,Kt=$t*$t+zt*zt+Yt*Yt,fn=.05*(1-N);Jt<Kt*fn&&(C=0)}const Qt=.15*(1-N);C<Qt&&(C=0),C>1-Qt&&(C=1);const Pt=28*(1-N)+8*N,Ft=1/(1+Math.exp(-Pt*-.5)),cn=1/(1+Math.exp(-Pt*.5)),rn=(1/(1+Math.exp(-Pt*(C-.5)))-Ft)/(cn-Ft),bn=Gt[h],yn=Tt[h],Cn=Dt[h],jn=Gt[i],kn=Tt[i],Hn=Dt[i];pt=Math.round(bn+rn*(jn-bn)),xt=Math.round(yn+rn*(kn-yn)),g=Math.round(Cn+rn*(Hn-Cn))}const v=e*o+u,F=Rt[v],ft=St[W+3];let vt;const Bt=(Ot||0)/100;if(Bt===0)vt=F;else{const n=ft/255,s=20*(1-Bt)+2*Bt,l=1/(1+Math.exp(-s*-.5)),m=1/(1+Math.exp(-s*.5)),j=(1/(1+Math.exp(-s*(n-.5)))-l)/(m-l);vt=Math.round(j*255)}Wt[W]=pt,Wt[W+1]=xt,Wt[W+2]=g,Wt[W+3]=K?vt:255}}jt.putImageData(new ImageData(Wt,wt,Et),0,0);const _t=new OffscreenCanvas(Math.round(o*V),Math.round(c*V)),Zt=_t.getContext("2d",{alpha:!0});if(!Zt)throw new Error("Could not get final context");Zt.imageSmoothingEnabled=!0,Zt.imageSmoothingQuality="high",Zt.drawImage(Mn,0,0,_t.width,_t.height);const Un=await en(_t,d==="NS");self.postMessage({type:"complete",result:Un})}catch(o){self.postMessage({type:"complete",error:o.message})}}})();
