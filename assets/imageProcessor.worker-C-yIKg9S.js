(function(){"use strict";const Z=(n,t,d)=>{const h=x=>Math.max(0,Math.min(255,Math.round(x))).toString(16).padStart(2,"0");return`#${h(n)}${h(t)}${h(d)}`.toLowerCase()},U=n=>{const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(n);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null},ot=(n,t)=>Math.sqrt(Math.pow(n.r-t.r,2)+Math.pow(n.g-t.g,2)+Math.pow(n.b-t.b,2)),tt=(n,t=12)=>1/(1+Math.exp(-t*(n-.5))),et=(n,t,d=1)=>{if(t.length===0)return{r:0,g:0,b:0,hex:"#000000",id:"default"};let h=1/0,x=t[0];const{r:I,g:R,b:B}=n;for(let H=0;H<t.length;H++){const s=t[H];let g=(I-s.r)**2+(R-s.g)**2+(B-s.b)**2;s.id.startsWith("group-")&&(g*=d*d),g<h&&(h=g,x=s)}return x},nt=(n,t,d)=>({r:Math.round(n.r+(t.r-n.r)*d),g:Math.round(n.g+(t.g-n.g)*d),b:Math.round(n.b+(t.b-n.b)*d)}),at=(n,t=1)=>{const{width:d,height:h,data:x}=n,I=new ImageData(new Uint8ClampedArray(x),d,h),R=I.data,B=(2*t+1)**2,H=new Uint8Array(B),s=new Uint8Array(B),g=new Uint8Array(B);for(let b=0;b<h;b++)for(let k=0;k<d;k++){let u=0;for(let J=-t;J<=t;J++){const T=b+J;if(T<0||T>=h)continue;const f=T*d;for(let p=-t;p<=t;p++){const z=k+p;if(z<0||z>=d)continue;const v=(f+z)*4;H[u]=x[v],s[u]=x[v+1],g[u]=x[v+2],u++}}const X=H.subarray(0,u).sort(),G=s.subarray(0,u).sort(),V=g.subarray(0,u).sort(),_=Math.floor(u/2),W=(b*d+k)*4;R[W]=X[_],R[W+1]=G[_],R[W+2]=V[_],R[W+3]=x[W+3]}return I};self.onmessage=async n=>{if(n.data.type!=="process")return;const{imageBitmap:t,parameters:d}=n.data,{upscaleFactor:h,denoiseRadius:x,edgeProtection:I,skipColorCleanup:R,palette:B,smoothingLevels:H}=d;try{const s=t.width,g=t.height;let b=1;if(h==="NS"){const e=Math.max(s,g),l=Math.min(s,g),m=Math.min(535/e,355/l),o=Math.min(568/e,321/l);b=Math.max(m,o)}else b=h;const k=new OffscreenCanvas(s,g),u=k.getContext("2d",{willReadFrequently:!0});if(!u)throw new Error("Could not get native context");u.drawImage(t,0,0);let X=u.getImageData(0,0,s,g);if(x>0&&(X=at(X,x)),u.putImageData(X,0,0),R){const e=Math.round(s*b),l=Math.round(g*b),m=new OffscreenCanvas(e,l),o=m.getContext("2d");if(!o)throw new Error("Could not get final context");o.imageSmoothingEnabled=!0,o.imageSmoothingQuality="high",o.drawImage(k,0,0,e,l);const C=await m.convertToBlob({type:"image/png"});self.postMessage({type:"complete",result:C});return}const G=b*4,V=Math.round(s*G),_=Math.round(g*G),W=1e7,T=V*_>W?Math.sqrt(W/(s*g)):G,f=Math.round(s*T),p=Math.round(g*T),z=new OffscreenCanvas(f,p),v=z.getContext("2d",{willReadFrequently:!0});if(!v)throw new Error("Could not get workspace context");v.imageSmoothingEnabled=!0,v.imageSmoothingQuality="high",v.drawImage(k,0,0,f,p);const $=v.getImageData(0,0,f,p).data,r=B,j=new Uint8ClampedArray($.length);let F=new Int16Array(f*p);for(let e=0;e<$.length;e+=4){const l={r:$[e],g:$[e+1],b:$[e+2]},m=et(l,r),o=r.findIndex(C=>C.id===m.id);F[e/4]=o!==-1?o:0}if(I>0){let e=1,l=1;I>33&&(e=2,l=2),I>66&&(e=3,l=3),I>85&&(e=4,l=5);let m=new Int16Array(F.length);const o=r.length,C=new Int16Array(o);for(let w=0;w<l;w++){for(let E=0;E<p;E++)for(let i=0;i<f;i++){const y=E*f+i;C.fill(0);let S=0,D=F[y];for(let M=-e;M<=e;M++)for(let a=-e;a<=e;a++){const c=E+M,A=i+a;if(c>=0&&c<p&&A>=0&&A<f){const q=F[c*f+A];if(q>=0&&q<o){C[q]++;const O=C[q];O>S&&(S=O,D=q)}}}m[y]=D}F.set(m)}}for(let e=0;e<p;e++)for(let l=0;l<f;l++){const m=e*f+l,o=F[m];let C=new Set;if(H>0)for(let i=-1;i<=1;i++)for(let y=-1;y<=1;y++){if(y===0&&i===0)continue;const S=l+y,D=e+i;if(S>=0&&S<f&&D>=0&&D<p){const M=F[D*f+S];M!==o&&C.add(M)}}let w;if(C.size===0||H===0){const i=r[o];if(i.targetHex){const y=U(i.targetHex);w=y?{...y,hex:i.targetHex,id:i.id}:i}else w=i}else{const i=m*4,y={r:$[i],g:$[i+1],b:$[i+2]},S=[r[o]],D=Math.pow(2,H)-1;C.forEach(a=>{S.push(r[a]);const A=ot(r[o],r[a])>120?18:10,q=r[o].targetHex?U(r[o].targetHex):r[o],O=r[a].targetHex?U(r[a].targetHex):r[a];for(let P=1;P<=D;P++){const Y=tt(P/(D+1),A),Q=nt(r[o],r[a],Y);S.push({...Q,hex:Z(Q.r,Q.g,Q.b),id:`blend-${o}-${a}-${P}`})}});const M=et(y,S,.8);if(M.id.startsWith("blend-")){const a=M.id.split("-"),c=parseInt(a[1]),A=parseInt(a[2]),q=parseInt(a[3]),O=r[c],P=r[A],Y=O.targetHex?U(O.targetHex):O,Q=P.targetHex?U(P.targetHex):P,K=nt(Y,Q,tt(q/(D+1),12));w={...K,hex:Z(K.r,K.g,K.b),id:M.id}}else{const a=r.find(c=>c.id===M.id);if(a)if(a.targetHex){const c=U(a.targetHex);w=c?{...c,hex:a.targetHex,id:a.id}:a}else w=a;else{const c=r[o];if(c.targetHex){const A=U(c.targetHex);w=A?{...A,hex:c.targetHex,id:c.id}:c}else w=c}}}const E=m*4;j[E]=w.r,j[E+1]=w.g,j[E+2]=w.b,j[E+3]=255}v.putImageData(new ImageData(j,f,p),0,0);const L=new OffscreenCanvas(Math.round(s*b),Math.round(g*b)),N=L.getContext("2d");if(!N)throw new Error("Could not get final context");N.fillStyle="#000000",N.fillRect(0,0,L.width,L.height),N.imageSmoothingEnabled=!0,N.imageSmoothingQuality="high",N.drawImage(z,0,0,L.width,L.height);const st=await L.convertToBlob({type:"image/png"});self.postMessage({type:"complete",result:st})}catch(s){self.postMessage({type:"complete",error:s.message})}}})();
