(function(){"use strict";const xn=(q,p,D)=>{const w=G=>Math.max(0,Math.min(255,Math.round(G))).toString(16).padStart(2,"0");return`#${w(q)}${w(p)}${w(D)}`.toLowerCase()},mn=q=>{const p=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(q);return p?{r:parseInt(p[1],16),g:parseInt(p[2],16),b:parseInt(p[3],16)}:null},bn=(q,p=1)=>{const{width:D,height:w,data:G}=q,P=new ImageData(new Uint8ClampedArray(G),D,w),B=P.data,F=(2*p+1)**2,nt=new Uint8Array(F),mt=new Uint8Array(F),X=new Uint8Array(F);for(let $=0;$<w;$++)for(let s=0;s<D;s++){let a=0;for(let k=-p;k<=p;k++){const ot=$+k;if(ot<0||ot>=w)continue;const kt=ot*D;for(let d=-p;d<=p;d++){const i=s+d;if(i<0||i>=D)continue;const r=(kt+i)*4;nt[a]=G[r],mt[a]=G[r+1],X[a]=G[r+2],a++}}const Z=nt.subarray(0,a).sort(),St=mt.subarray(0,a).sort(),ct=X.subarray(0,a).sort(),et=Math.floor(a/2),U=($*D+s)*4;B[U]=Z[et],B[U+1]=St[et],B[U+2]=ct[et],B[U+3]=G[U+3]}return P};async function wn(q,p,D,w=.5,G=1){let P=null,B=w,F=w,nt=G;const mt=.01;for(;nt-F>mt;){const X=(F+nt)/2,$=await q.convertToBlob({type:p,quality:X});$.size<=D?(P=$,B=X,F=X):nt=X}return{blob:P,quality:B}}async function on(q,p){if(!p)return await q.convertToBlob({type:"image/png"});const w=await q.convertToBlob({type:"image/png"});if(w.size<=153600)return w;let G=w,P="png";try{const B=await q.convertToBlob({type:"image/gif"});B.size<=153600&&(G=B,P="gif")}catch{}if(P==="png"){const B=await wn(q,"image/jpeg",153600,.5,1);B.blob&&B.blob.size<=153600&&(G=B.blob,P="jpeg")}return G}self.onmessage=async q=>{if(q.data.type!=="process")return;const{imageBitmap:p,parameters:D}=q.data,{upscaleFactor:w,denoiseRadius:G,edgeProtection:P,vertexInertia:B,disablePostProcessing:F,disableRecoloring:nt,disableScaling:mt,palette:X,smoothingLevels:$}=D;try{const s=p.width,a=p.height;let Z=1;mt||(w==="NS"?s>=a?Z=Math.min(535/s,355/a):Z=Math.min(321/s,568/a):Z=w);const St=new OffscreenCanvas(s,a),ct=St.getContext("2d",{willReadFrequently:!0});if(!ct)throw new Error("Could not get native context");if(ct.drawImage(p,0,0),!F&&G>0){const t=ct.getImageData(0,0,s,a),o=bn(t,G);ct.putImageData(o,0,0)}if(nt){const t=Math.round(s*Z),o=Math.round(a*Z),M=new OffscreenCanvas(t,o),x=M.getContext("2d");if(!x)throw new Error("Could not get final context");x.imageSmoothingEnabled=!0,x.imageSmoothingQuality="high",x.drawImage(St,0,0,t,o);const E=await on(M,w==="NS");self.postMessage({type:"complete",result:E});return}const et=X,U=ct.getImageData(0,0,s,a).data;let k=new Int16Array(s*a);const ot=new Map,kt=new Map,d=et.length,i=new Uint8Array(d),r=new Uint8Array(d),u=new Uint8Array(d),Mn=new Array(d);for(let t=0;t<d;t++){const o=et[t];kt.set(o.id,t),i[t]=o.r,r[t]=o.g,u[t]=o.b,Mn[t]=o.id}if(D.colorGroups)for(let t=0;t<D.colorGroups.length;t++){const o=D.colorGroups[t],M=kt.get(o.id);if(M!==void 0)for(let x=0;x<o.members.length;x++)ot.set(o.members[x].hex.toLowerCase(),M)}for(let t=0;t<d;t++){const o=et[t].hex.toLowerCase();ot.has(o)||ot.set(o,t)}for(let t=0;t<U.length;t+=4){const o=U[t],M=U[t+1],x=U[t+2],E=xn(o,M,x);let gt=ot.get(E);if(gt===void 0){let j=1/0,Q=0;for(let C=0;C<d;C++){const H=o-i[C],ht=M-r[C],J=x-u[C],L=H*H+ht*ht+J*J;L<j&&(j=L,Q=C)}gt=Q}k[t/4]=gt}const Bt=F?0:P,sn=F?0:$;if(Bt>0){let t=Math.max(1,Math.round(Bt/100*3)),o=Math.max(1,Math.round(Bt/100*4));Bt>66&&(t=3,o=3),Bt>85&&(t=5,o=5);const M=new Int16Array(k.length);for(let x=0;x<o;x++){for(let E=0;E<a;E++){const gt=Math.max(0,E-t),j=Math.min(a-1,E+t),Q=E*s;for(let C=0;C<s;C++){const H=Math.max(0,C-t),ht=Math.min(s-1,C+t),J=Q+C,L=k[J],Rt=J*4,K=U[Rt],V=U[Rt+1],yt=U[Rt+2],Lt=new Uint32Array(d);for(let g=gt;g<=j;g++){const n=g*s;for(let e=H;e<=ht;e++){const c=k[n+e];Lt[c]++}}let y=0,vt=0,l=0,W=0,z=0,tt=0;for(let g=0;g<d;g++){const n=Lt[g];n>vt?(z=l,tt=W,l=y,W=vt,y=g,vt=n):n>W?(z=l,tt=W,l=g,W=n):n>tt&&(z=g,tt=n)}if(y!==l&&l!==z){const g=i[y],n=r[y],e=u[y],c=i[l],m=r[l],S=u[l],R=i[z],f=r[z],h=u[z],v=Math.sqrt((g-R)**2+(n-f)**2+(e-h)**2),T=Math.sqrt((g-c)**2+(n-m)**2+(e-S)**2),N=Math.sqrt((R-c)**2+(f-m)**2+(h-S)**2);T+N<v*1.1&&(l=z,W=tt)}const at=(j-gt+1)*(ht-H+1);if(W<at*.1&&(l=y),L!==y&&L!==l){const g=i[L],n=r[L],e=u[L],c=i[y],m=r[y],S=u[y],R=i[l],f=r[l],h=u[l],v=(g-c)**2+(n-m)**2+(e-S)**2,T=(g-R)**2+(n-f)**2+(e-h)**2;M[J]=v<T?y:l;continue}const It=i[y],Tt=r[y],Ct=u[y],I=i[l],A=r[l],Wt=u[l];let Yt=(K-It)**2+(V-Tt)**2+(yt-Ct)**2,pt=(K-I)**2+(V-A)**2+(yt-Wt)**2;const ut=1-B/100*.8;L===y&&(Yt*=ut),L===l&&(pt*=ut),M[J]=Yt<pt?y:l}}k.set(M)}}const Qt=Z*4,yn=Math.round(s*Qt),In=Math.round(a*Qt),an=1e7,cn=yn*In>an?Math.sqrt(an/(s*a)):Qt,Y=Math.round(s*cn),it=Math.round(a*cn),rn=new OffscreenCanvas(Y,it),bt=rn.getContext("2d",{willReadFrequently:!0});if(!bt)throw new Error("Could not get workspace context");bt.imageSmoothingEnabled=!0,bt.imageSmoothingQuality="high",bt.drawImage(St,0,0,Y,it);const rt=bt.getImageData(0,0,Y,it).data,At=new Uint8ClampedArray(rt.length),Cn=Y/s,Sn=it/a,lt=new Uint8Array(d),ft=new Uint8Array(d),dt=new Uint8Array(d);for(let t=0;t<d;t++){const o=et[t];if(o.targetHex){const M=mn(o.targetHex);M?(lt[t]=M.r,ft[t]=M.g,dt[t]=M.b):(lt[t]=i[t],ft[t]=r[t],dt[t]=u[t])}else lt[t]=i[t],ft[t]=r[t],dt[t]=u[t]}const st=new Float32Array(d),Xt=new Uint8Array(d),$t=new Float32Array(d);for(let t=0;t<it;t++){const o=Math.min(a-1,Math.floor(t/Sn)),M=o*s;for(let x=0;x<Y;x++){const E=Math.min(s-1,Math.floor(x/Cn)),j=(t*Y+x)*4,Q=rt[j],C=rt[j+1],H=rt[j+2],ht=Math.max(0,o-2),J=Math.min(a-1,o+2),L=Math.max(0,E-2),Rt=Math.min(s-1,E+2);st.fill(0);for(let n=ht;n<=J;n++){const e=Math.abs(n-o),c=n*s;for(let m=L;m<=Rt;m++){const S=Math.abs(m-E),R=k[c+m];let f=1;(S>0||e>0)&&(f=.5),(S>1||e>1)&&(f=.2),st[R]+=f}}const K=[];for(let n=0;n<d;n++)st[n]>0&&K.push(n);const V=[],yt=K.length;t:for(let n=0;n<yt;n++){const e=K[n],c=i[e],m=r[e],S=u[e],R=st[e];for(let f=0;f<yt;f++){const h=K[f];if(h!==e)for(let v=0;v<yt;v++){const T=K[v];if(T===e||h===T)continue;const N=i[h],_=r[h],xt=u[h],b=i[T],O=r[T],Gt=u[T],Ft=st[h],Et=st[T],qt=Math.sqrt((N-b)**2+(_-O)**2+(xt-Gt)**2),Jt=Math.sqrt((N-c)**2+(_-m)**2+(xt-S)**2),ln=Math.sqrt((b-c)**2+(O-m)**2+(Gt-S)**2);if(Jt+ln<qt*1.1&&qt>10&&Ft>R&&Et>R)continue t}}V.push(e)}Xt.fill(0);const Lt=Math.max(0,o-1),y=Math.min(a-1,o+1),vt=Math.max(0,E-1),l=Math.min(s-1,E+1);for(let n=Lt;n<=y;n++){const e=n*s;for(let c=vt;c<=l;c++)Xt[k[e+c]]=1}const W=V.length;let z=-1/0,tt=0;for(let n=0;n<W;n++){const e=V[n],c=i[e],m=r[e],S=u[e],R=st[e],f=Q-c,h=C-m,v=H-S,T=f*f+h*h+v*v,N=Xt[e]?0:-1e3,_=R*10+N-Math.sqrt(T);$t[n]=_,_>z&&(z=_,tt=n)}let at=W>0?V[tt]:K[0],It=at,Tt=-1/0;for(let n=0;n<W;n++)n!==tt&&$t[n]>Tt&&(Tt=$t[n],It=V[n]);Tt<=-500&&(It=at);const Ct=k[M+E];let I=Ct,A=at,Wt=!1;for(let n=0;n<W;n++)if(V[n]===Ct){Wt=!0;break}Wt?(I=Ct,A=Ct===at?It:at):(I=at,A=It),st[A]<.3&&(A=I);let pt,ut,g;if(I===A)pt=lt[I],ut=ft[I],g=dt[I];else if(sn===0){const n=i[I],e=r[I],c=u[I],m=i[A],S=r[A],R=u[A],f=Q-n,h=C-e,v=H-c,T=Q-m,N=C-S,_=H-R,xt=f*f+h*h+v*v,b=T*T+N*N+_*_,O=xt<b?I:A;pt=lt[O],ut=ft[O],g=dt[O]}else{const n=i[I],e=r[I],c=u[I],m=i[A],S=r[A],R=u[A],f=m-n,h=S-e,v=R-c,T=Q-n,N=C-e,_=H-c,xt=f*f+h*h+v*v;let b=0;xt>0&&(b=Math.max(0,Math.min(1,(T*f+N*h+_*v)/xt)));const O=sn/100;let Gt=!1;if(b>0&&b<1){const Dt=.4*(1-O*.5);if(b<Dt||b>1-Dt){const Ot=(n+m)/2,Ut=(e+S)/2,jt=(c+R)/2,Pt=n-Ot,Ht=e-Ut,zt=c-jt,tn=Pt*Pt+Ht*Ht+zt*zt;let nn=!1;const Nt=O>.7?3:2;for(let _t=-Nt;_t<=Nt;_t+=1){for(let Zt=-Nt;Zt<=Nt;Zt+=1){if(Zt===0&&_t===0)continue;const Tn=Math.max(0,Math.min(it-1,t+_t)),Gn=Math.max(0,Math.min(Y-1,x+Zt)),en=(Tn*Y+Gn)*4,En=rt[en],qn=rt[en+1],Dn=rt[en+2],hn=En-Ot,pn=qn-Ut,un=Dn-jt,On=hn*hn+pn*pn+un*un,Un=.6+O*.2;if(On<tn*Un){nn=!0;break}}if(nn)break}nn||(Gt=!0)}}if(Gt&&(b=b<.5?0:1),b>0&&b<.25){const Dt=Q-n,Vt=C-e,Ot=H-c,Ut=n-m,jt=e-S,Pt=c-R,Ht=Dt*Dt+Vt*Vt+Ot*Ot,zt=Ut*Ut+jt*jt+Pt*Pt,tn=.05*(1-O);Ht<zt*tn&&(b=0)}const Ft=.15*(1-O);b<Ft&&(b=0),b>1-Ft&&(b=1);const Et=28*(1-O)+8*O,qt=1/(1+Math.exp(-Et*-.5)),Jt=1/(1+Math.exp(-Et*.5)),Kt=(1/(1+Math.exp(-Et*(b-.5)))-qt)/(Jt-qt),fn=lt[I],dn=ft[I],gn=dt[I],An=lt[A],Rn=ft[A],vn=dt[A];pt=Math.round(fn+Kt*(An-fn)),ut=Math.round(dn+Kt*(Rn-dn)),g=Math.round(gn+Kt*(vn-gn))}At[j]=pt,At[j+1]=ut,At[j+2]=g,At[j+3]=255}}bt.putImageData(new ImageData(At,Y,it),0,0);const wt=new OffscreenCanvas(Math.round(s*Z),Math.round(a*Z)),Mt=wt.getContext("2d");if(!Mt)throw new Error("Could not get final context");Mt.fillStyle="#000000",Mt.fillRect(0,0,wt.width,wt.height),Mt.imageSmoothingEnabled=!0,Mt.imageSmoothingQuality="high",Mt.drawImage(rn,0,0,wt.width,wt.height);const Bn=await on(wt,w==="NS");self.postMessage({type:"complete",result:Bn})}catch(s){self.postMessage({type:"complete",error:s.message})}}})();
