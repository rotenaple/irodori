(function(){"use strict";const J=(n,t,r)=>{const d=g=>Math.max(0,Math.min(255,Math.round(g))).toString(16).padStart(2,"0");return`#${d(n)}${d(t)}${d(r)}`.toLowerCase()},Z=(n,t)=>Math.sqrt(Math.pow(n.r-t.r,2)+Math.pow(n.g-t.g,2)+Math.pow(n.b-t.b,2)),K=(n,t=12)=>1/(1+Math.exp(-t*(n-.5))),V=(n,t,r=1)=>{if(t.length===0)return{r:0,g:0,b:0,hex:"#000000",id:"default"};let d=1/0,g=t[0];const{r:M,g:W,b:$}=n;for(let C=0;C<t.length;C++){const o=t[C];let i=(M-o.r)**2+(W-o.g)**2+($-o.b)**2;o.id.startsWith("group-")&&(i*=r*r),i<d&&(d=i,g=o)}return g},Y=(n,t,r)=>({r:Math.round(n.r+(t.r-n.r)*r),g:Math.round(n.g+(t.g-n.g)*r),b:Math.round(n.b+(t.b-n.b)*r)}),tt=(n,t=1)=>{const{width:r,height:d,data:g}=n,M=new ImageData(new Uint8ClampedArray(g),r,d),W=M.data,$=(2*t+1)**2,C=new Uint8Array($),o=new Uint8Array($),i=new Uint8Array($);for(let m=0;m<d;m++)for(let q=0;q<r;q++){let h=0;for(let G=-t;G<=t;G++){const O=m+G;if(O<0||O>=d)continue;const c=O*r;for(let f=-t;f<=t;f++){const R=q+f;if(R<0||R>=r)continue;const I=(c+R)*4;C[h]=g[I],o[h]=g[I+1],i[h]=g[I+2],h++}}const L=C.subarray(0,h).sort(),N=o.subarray(0,h).sort(),j=i.subarray(0,h).sort(),Q=Math.floor(h/2),H=(m*r+q)*4;W[H]=L[Q],W[H+1]=N[Q],W[H+2]=j[Q],W[H+3]=g[H+3]}return M};self.onmessage=async n=>{if(n.data.type!=="process")return;const{imageBitmap:t,parameters:r}=n.data,{upscaleFactor:d,denoiseRadius:g,edgeProtection:M,skipColorCleanup:W,palette:$,smoothingLevels:C}=r;try{const o=t.width,i=t.height;let m=1;if(d==="NS"){const e=Math.max(o,i),s=Math.min(o,i),u=Math.min(535/e,355/s),a=Math.min(568/e,321/s);m=Math.max(u,a)}else m=d;const q=new OffscreenCanvas(o,i),h=q.getContext("2d",{willReadFrequently:!0});if(!h)throw new Error("Could not get native context");h.drawImage(t,0,0);let L=h.getImageData(0,0,o,i);if(g>0&&(L=tt(L,g)),h.putImageData(L,0,0),W){const e=Math.round(o*m),s=Math.round(i*m),u=new OffscreenCanvas(e,s),a=u.getContext("2d");if(!a)throw new Error("Could not get final context");a.imageSmoothingEnabled=!0,a.imageSmoothingQuality="high",a.drawImage(q,0,0,e,s);const y=await u.convertToBlob({type:"image/png"});self.postMessage({type:"complete",result:y});return}const N=m*4,j=Math.round(o*N),Q=Math.round(i*N),H=1e7,O=j*Q>H?Math.sqrt(H/(o*i)):N,c=Math.round(o*O),f=Math.round(i*O),R=new OffscreenCanvas(c,f),I=R.getContext("2d",{willReadFrequently:!0});if(!I)throw new Error("Could not get workspace context");I.imageSmoothingEnabled=!0,I.imageSmoothingQuality="high",I.drawImage(q,0,0,c,f);const P=I.getImageData(0,0,c,f).data,l=$,X=new Uint8ClampedArray(P.length);let B=new Int16Array(c*f);for(let e=0;e<P.length;e+=4){const s={r:P[e],g:P[e+1],b:P[e+2]},u=V(s,l),a=l.findIndex(y=>y.id===u.id);B[e/4]=a!==-1?a:0}if(M>0){let e=1,s=1;M>33&&(e=2,s=2),M>66&&(e=3,s=3),M>85&&(e=4,s=5);let u=new Int16Array(B.length);const a=l.length,y=new Int16Array(a);for(let D=0;D<s;D++){for(let A=0;A<f;A++)for(let p=0;p<c;p++){const E=A*c+p;y.fill(0);let v=0,S=B[E];for(let b=-e;b<=e;b++)for(let x=-e;x<=e;x++){const U=A+b,F=p+x;if(U>=0&&U<f&&F>=0&&F<c){const w=B[U*c+F];if(w>=0&&w<a){y[w]++;const k=y[w];k>v&&(v=k,S=w)}}}u[E]=S}B.set(u)}}for(let e=0;e<f;e++)for(let s=0;s<c;s++){const u=e*c+s,a=B[u];let y=new Set;if(C>0)for(let p=-1;p<=1;p++)for(let E=-1;E<=1;E++){if(E===0&&p===0)continue;const v=s+E,S=e+p;if(v>=0&&v<c&&S>=0&&S<f){const b=B[S*c+v];b!==a&&y.add(b)}}let D;if(y.size===0||C===0)D=l[a];else{const p=u*4,E={r:P[p],g:P[p+1],b:P[p+2]},v=[l[a]],S=Math.pow(2,C)-1;y.forEach(x=>{v.push(l[x]);const F=Z(l[a],l[x])>120?18:10;for(let w=1;w<=S;w++){const k=K(w/(S+1),F),_=Y(l[a],l[x],k);v.push({..._,hex:J(_.r,_.g,_.b),id:`blend-${a}-${x}-${w}`})}});const b=V(E,v,.8);if(b.id.startsWith("blend-")){const x=b.id.split("-"),U=parseInt(x[1]),F=parseInt(x[2]),w=parseInt(x[3]),k=Y(l[U],l[F],K(w/(S+1),12));D={...k,hex:J(k.r,k.g,k.b),id:b.id}}else D=l.find(U=>U.id===b.id)||l[a]}const A=u*4;X[A]=D.r,X[A+1]=D.g,X[A+2]=D.b,X[A+3]=255}I.putImageData(new ImageData(X,c,f),0,0);const T=new OffscreenCanvas(Math.round(o*m),Math.round(i*m)),z=T.getContext("2d");if(!z)throw new Error("Could not get final context");z.fillStyle="#000000",z.fillRect(0,0,T.width,T.height),z.imageSmoothingEnabled=!0,z.imageSmoothingQuality="high",z.drawImage(R,0,0,T.width,T.height);const et=await T.convertToBlob({type:"image/png"});self.postMessage({type:"complete",result:et})}catch(o){self.postMessage({type:"complete",error:o.message})}}})();
