(function(){"use strict";const zt=h=>{const a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(h);return a?{r:parseInt(a[1],16),g:parseInt(a[2],16),b:parseInt(a[3],16)}:null},Qt=(h,a,n)=>{h/=255,a/=255,n/=255;const p=Math.max(h,a,n),i=Math.min(h,a,n);let A=0,d=0,l=(p+i)/2;if(p!==i){const m=p-i;switch(d=l>.5?m/(2-p-i):m/(p+i),p){case h:A=(a-n)/m+(a<n?6:0);break;case a:A=(n-h)/m+2;break;case n:A=(h-a)/m+4;break}A/=6}return{h:A*360,s:d*100,l:l*100}},$t=(h,a,n)=>{h/=360,a/=100,n/=100;const p=(l,m,R)=>(R<0&&(R+=1),R>1&&(R-=1),R<1/6?l+(m-l)*6*R:R<1/2?m:R<2/3?l+(m-l)*(2/3-R)*6:l);let i,A,d;if(a===0)i=A=d=n;else{const l=n<.5?n*(1+a):n+a-n*a,m=2*n-l;i=p(m,l,h+.3333333333333333),A=p(m,l,h),d=p(m,l,h-.3333333333333333)}return{r:Math.round(i*255),g:Math.round(A*255),b:Math.round(d*255)}},Vt=(h,a)=>{let n=a-h;return n>180&&(n-=360),n<-180&&(n+=360),n},te=(h,a)=>{let n=h+a;for(;n<0;)n+=360;for(;n>=360;)n-=360;return n},ee=(h,a=1)=>{const{width:n,height:p,data:i}=h,A=new ImageData(new Uint8ClampedArray(i),n,p),d=A.data,l=(2*a+1)**2,m=new Uint8Array(l),R=new Uint8Array(l),bt=new Uint8Array(l);for(let j=0;j<p;j++)for(let st=0;st<n;st++){let Z=0;for(let M=-a;M<=a;M++){const _=j+M;if(_<0||_>=p)continue;const dt=_*n;for(let Q=-a;Q<=a;Q++){const mt=st+Q;if(mt<0||mt>=n)continue;const E=(dt+mt)*4;m[Z]=i[E],R[Z]=i[E+1],bt[Z]=i[E+2],Z++}}const Et=m.subarray(0,Z).sort(),qt=R.subarray(0,Z).sort(),et=bt.subarray(0,Z).sort(),rt=Math.floor(Z/2),s=(j*n+st)*4;d[s]=Et[rt],d[s+1]=qt[rt],d[s+2]=et[rt],d[s+3]=i[s+3]}return A},Dt=(h,a,n)=>h<<16|a<<8|n;function ne(h,a,n,p,i){const A=Qt(h,a,n);let{h:d,s:l,l:m}=A;if(l<5)return $t(d,l,Math.max(0,Math.min(100,m+i.lightness*(i.lightnessForce/100))));const R=te(i.hue,Vt(p,d));return d=i.hueForce<100?d+(R-d)*(i.hueForce/100):R,l=Math.max(0,Math.min(100,l+i.saturation*(i.saturationForce/100))),m=Math.max(0,Math.min(100,m+i.lightness*(i.lightnessForce/100))),$t(d,l,m)}async function jt(h,a){const p=await h.convertToBlob({type:"image/png"});if(!a||p.size<=153600)return p;try{const l=await h.convertToBlob({type:"image/gif"});if(l.size<=153600)return l}catch{}let i=.5,A=1,d=p;for(let l=0;l<6;l++){const m=(i+A)/2,R=await h.convertToBlob({type:"image/jpeg",quality:m});R.size<=153600?(d=R,i=m):A=m}return d}self.onmessage=async h=>{var rt;if(h.data.type!=="process")return;const a=performance.now(),{imageBitmap:n,parameters:p}=h.data,{upscaleFactor:i,denoiseRadius:A,edgeProtection:d,vertexInertia:l,disablePostProcessing:m,disableRecoloring:R,disableScaling:bt,palette:j,smoothingLevels:st,alphaSmoothness:Z,preserveTransparency:Et,recolorMode:qt,tintOverrides:et}=p;try{const s=n.width,M=n.height;let _=1;bt||(_=i==="NS"?s>=M?Math.min(535/s,355/M):Math.min(321/s,568/M):i);const dt=new OffscreenCanvas(s,M),Q=dt.getContext("2d",{willReadFrequently:!0,alpha:!0});if(Q.drawImage(n,0,0),!m&&A>0){const t=performance.now();Q.putImageData(ee(Q.getImageData(0,0,s,M),A),0,0),console.log(`[WORKER] Denoise: ${Math.round(performance.now()-t)}ms`)}if(R){const t=Math.round(s*_),r=Math.round(M*_),S=new OffscreenCanvas(t,r);S.getContext("2d").drawImage(dt,0,0,t,r),self.postMessage({type:"complete",result:await jt(S,i==="NS")});return}const mt=performance.now(),E=Q.getImageData(0,0,s,M).data,G=new Int16Array(s*M),q=j.length,w=new Uint8Array(q),x=new Uint8Array(q),y=new Uint8Array(q),It=new Map,Kt=new Map;for(let t=0;t<q;t++)w[t]=j[t].r,x[t]=j[t].g,y[t]=j[t].b,Kt.set(j[t].id,t),It.set(Dt(w[t],x[t],y[t]),t);if(p.colorGroups)for(const t of p.colorGroups){const r=Kt.get(t.id);if(r!==void 0)for(const S of t.members){const b=zt(S.hex);b&&It.set(Dt(b.r,b.g,b.b),r)}}let ct=null;Et&&(ct=new Uint8ClampedArray(s*M));for(let t=0;t<E.length;t+=4){const r=E[t],S=E[t+1],b=E[t+2],C=Dt(r,S,b);let c=It.get(C);if(c===void 0){let V=1/0;for(let K=0;K<q;K++){const k=(r-w[K])**2+(S-x[K])**2+(b-y[K])**2;k<V&&(V=k,c=K)}It.set(C,c)}const B=t>>2;G[B]=c,ct&&(ct[B]=E[t+3])}if(console.log(`[WORKER] Phase 1: ${Math.round(performance.now()-mt)}ms`),d>0&&!m){const t=performance.now(),r=new Int16Array(G.length),S=new Uint8Array(G.length),b=new Uint32Array(q),C=new Uint16Array(q),c=1-l/100*.8,B=d>85?5:d>66?3:Math.max(1,Math.round(d/100*3)),V=d>85?5:d>66?3:Math.max(1,Math.round(d/100*4));for(let K=0;K<V;K++){for(let k=1;k<M-1;k++){const pt=k*s;for(let W=1;W<s-1;W++){const v=pt+W,U=G[v];U!==G[v-1]||U!==G[v+1]||U!==G[v-s]||U!==G[v+s]?S[v]=1:(S[v]=0,r[v]=U)}}for(let k=0;k<M;k++){const pt=k*s,W=Math.max(0,k-B),v=Math.min(M-1,k+B);for(let U=0;U<s;U++){const J=pt+U;if(S[J]===0)continue;const St=Math.max(0,U-B),Ct=Math.min(s-1,U+B);let Tt=0;for(let e=W;e<=v;e++){const f=e*s;for(let g=St;g<=Ct;g++){const O=G[f+g];b[O]===0&&(C[Tt++]=O),b[O]++}}let D=0,ht=0,u=0,L=0,F=0,tt=0;for(let e=0;e<Tt;e++){const f=C[e],g=b[f];g>ht?(F=u,tt=L,u=D,L=ht,D=f,ht=g):g>L?(F=u,tt=L,u=f,L=g):g>tt&&(F=f,tt=g),b[f]=0}if(D!==u&&u!==F){const e=(w[D]-w[F])**2+(x[D]-x[F])**2+(y[D]-y[F])**2,f=(w[D]-w[u])**2+(x[D]-x[u])**2+(y[D]-y[u])**2,g=(w[F]-w[u])**2+(x[F]-x[u])**2+(y[F]-y[u])**2;f+g+2*Math.sqrt(f*g)<e*1.21&&(u=F,L=tt)}L<(v-W+1)*(Ct-St+1)*.1&&(u=D);const Mt=G[J],I=J<<2;let T=(E[I]-w[D])**2+(E[I+1]-x[D])**2+(E[I+2]-y[D])**2,o=(E[I]-w[u])**2+(E[I+1]-x[u])**2+(E[I+2]-y[u])**2;Mt===D?T*=c:Mt===u&&(o*=c),r[J]=T<o?D:u}}G.set(r)}console.log(`[WORKER] Phase 2: ${Math.round(performance.now()-t)}ms`)}const oe=performance.now(),Ft=_*4,Lt=s*Ft*M*Ft>1e7?Math.sqrt(1e7/(s*M)):Ft,Y=Math.round(s*Lt),nt=Math.round(M*Lt),Zt=new OffscreenCanvas(Y,nt),Gt=Zt.getContext("2d",{willReadFrequently:!0});Gt.drawImage(dt,0,0,Y,nt);const N=Gt.getImageData(0,0,Y,nt).data,$=new Uint8ClampedArray(N.length),it=new Uint8Array(q),lt=new Uint8Array(q),ft=new Uint8Array(q),ae=qt==="tint"&&et;for(let t=0;t<q;t++){const r=j[t];let S=r.r,b=r.g,C=r.b;if(ae&&(et==null?void 0:et[r.id])!==void 0){const c=(rt=p.colorGroups)==null?void 0:rt.find(V=>V.id===r.id),B=ne(S,b,C,(c==null?void 0:c.baseHue)??0,et[r.id]);S=B.r,b=B.g,C=B.b}else if(r.targetHex){const c=zt(r.targetHex);c&&(S=c.r,b=c.g,C=c.b)}it[t]=S,lt[t]=b,ft[t]=C}const ot=(m?0:st)/100,kt=28*(1-ot)+8*ot,_t=.15*(1-ot),Nt=new Float32Array(1025),Xt=1/(1+Math.exp(-kt*-.5)),se=1/(1+Math.exp(-kt*.5));for(let t=0;t<=1024;t++){let r=t/1024;r<_t?r=0:r>1-_t&&(r=1),Nt[t]=(1/(1+Math.exp(-kt*(r-.5)))-Xt)/(se-Xt)}const Ot=(Z||0)/100,Ht=new Float32Array(256),Wt=20*(1-Ot)+2*Ot,Yt=1/(1+Math.exp(-Wt*-.5)),re=1/(1+Math.exp(-Wt*.5));for(let t=0;t<256;t++){const r=t/255;Ht[t]=(1/(1+Math.exp(-Wt*(r-.5)))-Yt)/(re-Yt)}const X=new Float32Array(q),At=new Uint8Array(q),ut=new Uint16Array(q),gt=new Uint16Array(q),ce=Y/s,ie=nt/M;for(let t=0;t<nt;t++){const r=Math.min(M-1,t/ie|0),S=r*s;for(let b=0;b<Y;b++){const C=Math.min(s-1,b/ce|0),c=t*Y+b<<2;X.fill(0);let B=0;const V=Math.max(0,r-2),K=Math.min(M-1,r+2),k=Math.max(0,C-2),pt=Math.min(s-1,C+2);for(let o=V;o<=K;o++){const e=Math.abs(o-r),f=o*s;for(let g=k;g<=pt;g++){const O=G[f+g];X[O]===0&&(ut[B++]=O),X[O]+=Math.abs(g-C)>1||e>1?.2:Math.abs(g-C)>0||e>0?.5:1}}if(B===1){const o=ut[0];$[c]=it[o],$[c+1]=lt[o],$[c+2]=ft[o],$[c+3]=ct?Ot===0?ct[S+C]:Ht[N[c+3]]*255|0:255;continue}const W=N[c],v=N[c+1],U=N[c+2];let J=0;t:for(let o=0;o<B;o++){const e=ut[o],f=w[e],g=x[e],O=y[e];for(let at=0;at<B;at++){const P=ut[at];if(P!==e)for(let H=0;H<B;H++){const z=ut[H];if(z===e||P===z)continue;const wt=(w[P]-w[z])**2+(x[P]-x[z])**2+(y[P]-y[z])**2,xt=(w[P]-f)**2+(x[P]-g)**2+(y[P]-O)**2,yt=(w[z]-f)**2+(x[z]-g)**2+(y[z]-O)**2;if(xt+yt+2*Math.sqrt(xt*yt)<wt*1.21&&wt>100&&X[P]>X[e]&&X[z]>X[e])continue t}}gt[J++]=e}At.fill(0);const St=Math.max(0,r-1),Ct=Math.min(M-1,r+1),Tt=Math.max(0,C-1),D=Math.min(s-1,C+1);for(let o=St;o<=Ct;o++){const e=o*s;for(let f=Tt;f<=D;f++)At[G[e+f]]=1}let ht=-1/0,u=gt[0];for(let o=0;o<J;o++){const e=gt[o],f=X[e]*10+(At[e]?0:-1e3)-((W-w[e])**2+(v-x[e])**2+(U-y[e])**2);f>ht&&(ht=f,u=e)}let L=u,F=-1/0;for(let o=0;o<J;o++){const e=gt[o];if(e===u)continue;const f=X[e]*10+(At[e]?0:-1e3)-((W-w[e])**2+(v-x[e])**2+(U-y[e])**2);f>F&&(F=f,L=e)}F<=-500&&(L=u);const tt=G[S+C];let Mt=!1;for(let o=0;o<J;o++)if(gt[o]===tt){Mt=!0;break}let I=Mt?tt:u,T=I===u?L:u;if(X[T]<.3&&(T=I),I===T||ot===0){const o=(W-w[I])**2+(v-x[I])**2+(U-y[I])**2<(W-w[T])**2+(v-x[T])**2+(U-y[T])**2?I:T;$[c]=it[o],$[c+1]=lt[o],$[c+2]=ft[o]}else{const o=w[I],e=x[I],f=y[I],g=w[T]-o,O=x[T]-e,at=y[T]-f,P=g*g+O*O+at*at;let H=P>0?Math.max(0,Math.min(1,((W-o)*g+(v-e)*O+(U-f)*at)/P)):0;if(H>0&&H<1&&(H<.4||H>.6)){const wt=(o+w[T])/2,xt=(e+x[T])/2,yt=(f+y[T])/2,le=(o-wt)**2+(e-xt)**2+(f-yt)**2;let Jt=!1,vt=ot>.7?3:2;t:for(let Ut=-vt;Ut<=vt;Ut++)for(let Bt=-vt;Bt<=vt;Bt++){if(Bt===0&&Ut===0)continue;const fe=Math.max(0,Math.min(nt-1,t+Ut)),he=Math.max(0,Math.min(Y-1,b+Bt)),Pt=fe*Y+he<<2;if((N[Pt]-wt)**2+(N[Pt+1]-xt)**2+(N[Pt+2]-yt)**2<le*(.6+ot*.2)){Jt=!0;break t}}Jt||(H=H<.5?0:1)}H>0&&H<.25&&(W-o)**2+(v-e)**2+(U-f)**2<P*(.05*(1-ot))&&(H=0);const z=Nt[H*1024|0];$[c]=it[I]+z*(it[T]-it[I])|0,$[c+1]=lt[I]+z*(lt[T]-lt[I])|0,$[c+2]=ft[I]+z*(ft[T]-ft[I])|0}$[c+3]=ct&&N[c+3]<255?Ht[N[c+3]]*255|0:255}}console.log(`[WORKER] Phase 3: ${Math.round(performance.now()-oe)}ms`),Gt.putImageData(new ImageData($,Y,nt),0,0);const Rt=new OffscreenCanvas(Math.round(s*_),Math.round(M*_));Rt.getContext("2d").drawImage(Zt,0,0,Rt.width,Rt.height),console.log(`[WORKER] Total: ${Math.round(performance.now()-a)}ms`),self.postMessage({type:"complete",result:await jt(Rt,i==="NS")})}catch(s){self.postMessage({type:"complete",error:s.message})}}})();
