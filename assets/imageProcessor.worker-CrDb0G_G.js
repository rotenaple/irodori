(function(){"use strict";const Nt=(P,i,p)=>{const w=y=>Math.max(0,Math.min(255,Math.round(y))).toString(16).padStart(2,"0");return`#${w(P)}${w(i)}${w(p)}`.toLowerCase()},Mt=P=>{const i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(P);return i?{r:parseInt(i[1],16),g:parseInt(i[2],16),b:parseInt(i[3],16)}:null},Xt=(P,i,p=1)=>{if(i.length===0)return{r:0,g:0,b:0,hex:"#000000",id:"default"};let w=1/0,y=i[0];const{r:Y,g:G,b:W}=P;for(let N=0;N<i.length;N++){const k=i[N];let X=(Y-k.r)**2+(G-k.g)**2+(W-k.b)**2;k.id.startsWith("group-")&&(X*=p*p),X<w&&(w=X,y=k)}return y},zt=(P,i=1)=>{const{width:p,height:w,data:y}=P,Y=new ImageData(new Uint8ClampedArray(y),p,w),G=Y.data,W=(2*i+1)**2,N=new Uint8Array(W),k=new Uint8Array(W),X=new Uint8Array(W);for(let et=0;et<w;et++)for(let _=0;_<p;_++){let o=0;for(let H=-i;H<=i;H++){const v=et+H;if(v<0||v>=w)continue;const ot=v*p;for(let J=-i;J<=i;J++){const F=_+J;if(F<0||F>=p)continue;const st=(ot+F)*4;N[o]=y[st],k[o]=y[st+1],X[o]=y[st+2],o++}}const c=N.subarray(0,o).sort(),O=k.subarray(0,o).sort(),ft=X.subarray(0,o).sort(),T=Math.floor(o/2),s=(et*p+_)*4;G[s]=c[T],G[s+1]=O[T],G[s+2]=ft[T],G[s+3]=y[s+3]}return Y};self.onmessage=async P=>{var _;if(P.data.type!=="process")return;const{imageBitmap:i,parameters:p}=P.data,{upscaleFactor:w,denoiseRadius:y,edgeProtection:Y,vertexInertia:G,disablePostProcessing:W,disableRecoloring:N,disableScaling:k,palette:X,smoothingLevels:et}=p;try{const o=i.width,c=i.height;let O=1;if(!k)if(w==="NS"){const e=Math.max(o,c),a=Math.min(o,c),f=Math.min(535/e,355/a),B=Math.min(568/e,321/a);O=Math.max(f,B)}else O=w;const ft=new OffscreenCanvas(o,c),T=ft.getContext("2d",{willReadFrequently:!0});if(!T)throw new Error("Could not get native context");if(T.drawImage(i,0,0),!W&&y>0){const e=T.getImageData(0,0,o,c),a=zt(e,y);T.putImageData(a,0,0)}if(N){const e=Math.round(o*O),a=Math.round(c*O),f=new OffscreenCanvas(e,a),B=f.getContext("2d");if(!B)throw new Error("Could not get final context");B.imageSmoothingEnabled=!0,B.imageSmoothingQuality="high",B.drawImage(ft,0,0,e,a);const q=await f.convertToBlob({type:"image/png"});self.postMessage({type:"complete",result:q});return}const s=X,H=T.getImageData(0,0,o,c).data;let v=new Int16Array(o*c);const ot=new Map,J=new Map;s.forEach((e,a)=>J.set(e.id,a)),p.colorGroups&&p.colorGroups.forEach(e=>{const a=J.get(e.id);a!==void 0&&e.members.forEach(f=>{ot.set(f.hex.toLowerCase(),a)})}),s.forEach((e,a)=>{const f=e.hex.toLowerCase();ot.has(f)||ot.set(f,a)});for(let e=0;e<H.length;e+=4){const a=H[e],f=H[e+1],B=H[e+2],q=Nt(a,f,B);let m=ot.get(q);if(m===void 0){const D=Xt({r:a,g:f,b:B},s),r=J.get(D.id);m=r!==void 0?r:0}v[e/4]=m}const F=W?0:Y,st=W?0:et;if(F>0){let e=Math.max(1,Math.round(F/100*3)),a=Math.max(1,Math.round(F/100*4));F>66&&(e=3,a=3),F>85&&(e=5,a=5);const f=new Int16Array(v.length),B=s.length;for(let q=0;q<a;q++){for(let m=0;m<c;m++){const pt=Math.max(0,m-e),D=Math.min(c-1,m+e);for(let r=0;r<o;r++){const wt=Math.max(0,r-e),yt=Math.min(o-1,r+e),ct=m*o+r,Z=v[ct],A=ct*4,R={r:H[A],g:H[A+1],b:H[A+2]},tt=new Map;for(let l=pt;l<=D;l++)for(let x=wt;x<=yt;x++){const g=v[l*o+x];tt.set(g,(tt.get(g)||0)+1)}const z=Array.from(tt.entries()).sort((l,x)=>x[1]-l[1]);let E=z[0][0],u=z.length>1?z[1][0]:E,bt=z.length>2?z[2][0]:u;if(E!==u&&u!==bt){const l=s[E],x=s[u],g=s[bt],t=Math.sqrt((l.r-g.r)**2+(l.g-g.g)**2+(l.b-g.b)**2),n=Math.sqrt((l.r-x.r)**2+(l.g-x.g)**2+(l.b-x.b)**2),b=Math.sqrt((g.r-x.r)**2+(g.g-x.g)**2+(g.b-x.b)**2);n+b<t*1.1&&(u=bt)}const Et=(D-pt+1)*(yt-wt+1);if((tt.get(u)||0)<Et*.1&&(u=E),Z!==E&&Z!==u){const l=s[Z],x=s[E],g=s[u],t=(l.r-x.r)**2+(l.g-x.g)**2+(l.b-x.b)**2,n=(l.r-g.r)**2+(l.g-g.g)**2+(l.b-g.b)**2;f[ct]=t<n?E:u;continue}const U=s[E],lt=s[u];let nt=(R.r-U.r)**2+(R.g-U.g)**2+(R.b-U.b)**2,C=(R.r-lt.r)**2+(R.g-lt.g)**2+(R.b-lt.b)**2;const I=1-G/100*.8;Z===E&&(nt*=I),Z===u&&(C*=I),f[ct]=nt<C?E:u}}v.set(f)}}const At=O*4,Qt=Math.round(o*At),Yt=Math.round(c*At),Ft=1e7,Lt=Qt*Yt>Ft?Math.sqrt(Ft/(o*c)):At,L=Math.round(o*Lt),K=Math.round(c*Lt),Ut=new OffscreenCanvas(L,K),at=Ut.getContext("2d",{willReadFrequently:!0});if(!at)throw new Error("Could not get workspace context");at.imageSmoothingEnabled=!0,at.imageSmoothingQuality="high",at.drawImage(ft,0,0,L,K);const V=at.getImageData(0,0,L,K).data,xt=new Uint8ClampedArray(V.length),_t=L/o,Jt=K/c;for(let e=0;e<K;e++){const a=Math.min(c-1,Math.floor(e/Jt)),f=Math.max(0,a-1),B=Math.min(c-1,a+1);for(let q=0;q<L;q++){const m=Math.min(o-1,Math.floor(q/_t)),D=(e*L+q)*4,r={r:V[D],g:V[D+1],b:V[D+2]},wt=Math.max(0,a-2),yt=Math.min(c-1,a+2),ct=Math.max(0,m-2),Z=Math.min(o-1,m+2);let A=new Map;for(let t=wt;t<=yt;t++){const n=Math.abs(t-a);for(let b=ct;b<=Z;b++){const M=Math.abs(b-m),d=v[t*o+b];let S=1;(M>0||n>0)&&(S=.5),(M>1||n>1)&&(S=.2),A.set(d,(A.get(d)||0)+S)}}const R=Array.from(A.keys()),tt=R.filter(t=>{const n=s[t],b=A.get(t)||0;for(const M of R)for(const d of R){if(M===t||d===t||M===d)continue;const S=s[M],Q=s[d],Ht=A.get(M)||0,Ct=A.get(d)||0,h=Math.sqrt((S.r-Q.r)**2+(S.g-Q.g)**2+(S.b-Q.b)**2),$=Math.sqrt((S.r-n.r)**2+(S.g-n.g)**2+(S.b-n.b)**2),It=Math.sqrt((Q.r-n.r)**2+(Q.g-n.g)**2+(Q.b-n.b)**2);if($+It<h*1.1&&h>10&&Ht>b&&Ct>b)return!1}return!0}),z=new Set,E=Math.max(0,a-1),u=Math.min(c-1,a+1),bt=Math.max(0,m-1),Et=Math.min(o-1,m+1);for(let t=E;t<=u;t++)for(let n=bt;n<=Et;n++)z.add(v[t*o+n]);const mt=tt.map(t=>{const n=s[t],b=A.get(t)||0,M=(r.r-n.r)**2+(r.g-n.g)**2+(r.b-n.b)**2,d=z.has(t)?0:-1e3;return{id:t,score:b*10+d-Math.sqrt(M)}}).sort((t,n)=>n.score-t.score),U=((_=mt[0])==null?void 0:_.id)??R[0],lt=mt.length>1&&mt[1].score>-500?mt[1].id:U,nt=v[a*o+m];let C=nt,I=U;tt.includes(nt)?(C=nt,I=nt===U?lt:U):(C=U,I=lt),(A.get(I)||0)<.3&&(I=C);let g;if(C===I){const t=s[C];g={...t.targetHex?Mt(t.targetHex):{r:t.r,g:t.g,b:t.b},id:t.id}}else if(st===0){const t=s[C],n=s[I],b=(r.r-t.r)**2+(r.g-t.g)**2+(r.b-t.b)**2,M=(r.r-n.r)**2+(r.g-n.g)**2+(r.b-n.b)**2,d=b<M?t:n;g={...d.targetHex?Mt(d.targetHex):{r:d.r,g:d.g,b:d.b},id:d.id}}else{const t=s[C],n=s[I],b=n.r-t.r,M=n.g-t.g,d=n.b-t.b,S=r.r-t.r,Q=r.g-t.g,Ht=r.b-t.b,Ct=b*b+M*M+d*d;let h=0;Ct>0&&(h=Math.max(0,Math.min(1,(S*b+Q*M+Ht*d)/Ct)));const $=st/100;let It=!1;if(h>0&&h<1){const St=.4*(1-$*.5);if(h<St||h>1-St){const vt=(t.r+n.r)/2,j=(t.g+n.g)/2,dt=(t.b+n.b)/2,Ot=(t.r-vt)**2+(t.g-j)**2+(t.b-dt)**2;let ut=!1;const ht=$>.7?3:2;for(let qt=-ht;qt<=ht;qt+=1){for(let Dt=-ht;Dt<=ht;Dt+=1){if(Dt===0&&qt===0)continue;const Zt=Math.max(0,Math.min(K-1,e+qt)),tn=Math.max(0,Math.min(L-1,q+Dt)),Tt=(Zt*L+tn)*4,nn=V[Tt],en=V[Tt+1],on=V[Tt+2],sn=(nn-vt)**2+(en-j)**2+(on-dt)**2,an=.6+$*.2;if(sn<Ot*an){ut=!0;break}}if(ut)break}ut||(It=!0)}}if(It&&(h=h<.5?0:1),h>0&&h<.25){const St=r.r,Gt=r.g,vt=r.b,j=s[C],dt=s[I],Ot=(St-j.r)**2+(Gt-j.g)**2+(vt-j.b)**2,ut=(j.r-dt.r)**2+(j.g-dt.g)**2+(j.b-dt.b)**2,ht=.05*(1-$);Ot<ut*ht&&(h=0)}const $t=.15*(1-$);h<$t&&(h=0),h>1-$t&&(h=1);const Bt=28*(1-$)+8*$,jt=1/(1+Math.exp(-Bt*-.5)),Vt=1/(1+Math.exp(-Bt*.5)),Rt=(1/(1+Math.exp(-Bt*(h-.5)))-jt)/(Vt-jt),Pt=s[C],kt=s[I],gt=Pt.targetHex?Mt(Pt.targetHex):Pt,Wt=kt.targetHex?Mt(kt.targetHex):kt;g={r:Math.round(gt.r+Rt*(Wt.r-gt.r)),g:Math.round(gt.g+Rt*(Wt.g-gt.g)),b:Math.round(gt.b+Rt*(Wt.b-gt.b)),id:`blend-${C}-${I}`}}xt[D]=g.r,xt[D+1]=g.g,xt[D+2]=g.b,xt[D+3]=255}}at.putImageData(new ImageData(xt,L,K),0,0);const rt=new OffscreenCanvas(Math.round(o*O),Math.round(c*O)),it=rt.getContext("2d");if(!it)throw new Error("Could not get final context");it.fillStyle="#000000",it.fillRect(0,0,rt.width,rt.height),it.imageSmoothingEnabled=!0,it.imageSmoothingQuality="high",it.drawImage(Ut,0,0,rt.width,rt.height);const Kt=await rt.convertToBlob({type:"image/png"});self.postMessage({type:"complete",result:Kt})}catch(o){self.postMessage({type:"complete",error:o.message})}}})();
