(function(){"use strict";const $t=(x,r,p)=>{const c=h=>Math.max(0,Math.min(255,Math.round(h))).toString(16).padStart(2,"0");return`#${c(x)}${c(r)}${c(p)}`.toLowerCase()},mt=x=>{const r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(x);return r?{r:parseInt(r[1],16),g:parseInt(r[2],16),b:parseInt(r[3],16)}:null},Zt=(x,r,p=1)=>{if(r.length===0)return{r:0,g:0,b:0,hex:"#000000",id:"default"};let c=1/0,h=r[0];const{r:S,g:b,b:v}=x;for(let B=0;B<r.length;B++){const R=r[B];let E=(S-R.r)**2+(b-R.g)**2+(v-R.b)**2;R.id.startsWith("group-")&&(E*=p*p),E<c&&(c=E,h=R)}return h},Nt=(x,r=1)=>{const{width:p,height:c,data:h}=x,S=new ImageData(new Uint8ClampedArray(h),p,c),b=S.data,v=(2*r+1)**2,B=new Uint8Array(v),R=new Uint8Array(v),E=new Uint8Array(v);for(let L=0;L<c;L++)for(let Y=0;Y<p;Y++){let n=0;for(let O=-r;O<=r;O++){const D=L+O;if(D<0||D>=c)continue;const ot=D*p;for(let J=-r;J<=r;J++){const F=Y+J;if(F<0||F>=p)continue;const st=(ot+F)*4;B[n]=h[st],R[n]=h[st+1],E[n]=h[st+2],n++}}const l=B.subarray(0,n).sort(),j=R.subarray(0,n).sort(),ht=E.subarray(0,n).sort(),z=Math.floor(n/2),s=(L*p+Y)*4;b[s]=l[z],b[s+1]=j[z],b[s+2]=ht[z],b[s+3]=h[s+3]}return S};async function Qt(x,r,p,c=.5,h=1){let S=null,b=c,v=c,B=h;const R=.01;for(;B-v>R;){const E=(v+B)/2,L=await x.convertToBlob({type:r,quality:E});L.size<=p?(S=L,b=E,v=E):B=E}return{blob:S,quality:b}}async function Wt(x,r){if(!r)return await x.convertToBlob({type:"image/png"});const c=await x.convertToBlob({type:"image/png"});if(c.size<=153600)return c;let h=c,S="png";try{const b=await x.convertToBlob({type:"image/gif"});b.size<=153600&&(h=b,S="gif")}catch{}if(S==="png"){const b=await Qt(x,"image/jpeg",153600,.5,1);b.blob&&b.blob.size<=153600&&(h=b.blob,S="jpeg")}return h}self.onmessage=async x=>{var Y;if(x.data.type!=="process")return;const{imageBitmap:r,parameters:p}=x.data,{upscaleFactor:c,denoiseRadius:h,edgeProtection:S,vertexInertia:b,disablePostProcessing:v,disableRecoloring:B,disableScaling:R,palette:E,smoothingLevels:L}=p;try{const n=r.width,l=r.height;let j=1;R||(c==="NS"?n>=l?j=Math.min(535/n,355/l):j=Math.min(321/n,568/l):j=c);const ht=new OffscreenCanvas(n,l),z=ht.getContext("2d",{willReadFrequently:!0});if(!z)throw new Error("Could not get native context");if(z.drawImage(r,0,0),!v&&h>0){const o=z.getImageData(0,0,n,l),a=Nt(o,h);z.putImageData(a,0,0)}if(B){const o=Math.round(n*j),a=Math.round(l*j),y=new OffscreenCanvas(o,a),_=y.getContext("2d");if(!_)throw new Error("Could not get final context");_.imageSmoothingEnabled=!0,_.imageSmoothingQuality="high",_.drawImage(ht,0,0,o,a);const H=await Wt(y,c==="NS");self.postMessage({type:"complete",result:H});return}const s=E,O=z.getImageData(0,0,n,l).data;let D=new Int16Array(n*l);const ot=new Map,J=new Map;s.forEach((o,a)=>J.set(o.id,a)),p.colorGroups&&p.colorGroups.forEach(o=>{const a=J.get(o.id);a!==void 0&&o.members.forEach(y=>{ot.set(y.hex.toLowerCase(),a)})}),s.forEach((o,a)=>{const y=o.hex.toLowerCase();ot.has(y)||ot.set(y,a)});for(let o=0;o<O.length;o+=4){const a=O[o],y=O[o+1],_=O[o+2],H=$t(a,y,_);let w=ot.get(H);if(w===void 0){const P=Zt({r:a,g:y,b:_},s),i=J.get(P.id);w=i!==void 0?i:0}D[o/4]=w}const F=v?0:S,st=v?0:L;if(F>0){let o=Math.max(1,Math.round(F/100*3)),a=Math.max(1,Math.round(F/100*4));F>66&&(o=3,a=3),F>85&&(o=5,a=5);const y=new Int16Array(D.length),_=s.length;for(let H=0;H<a;H++){for(let w=0;w<l;w++){const Mt=Math.max(0,w-o),P=Math.min(l-1,w+o);for(let i=0;i<n;i++){const wt=Math.max(0,i-o),yt=Math.min(n-1,i+o),ct=w*n+i,tt=D[ct],k=ct*4,W={r:O[k],g:O[k+1],b:O[k+2]},et=new Map;for(let g=Mt;g<=P;g++)for(let m=wt;m<=yt;m++){const d=D[g*n+m];et.set(d,(et.get(d)||0)+1)}const Q=Array.from(et.entries()).sort((g,m)=>m[1]-g[1]);let G=Q[0][0],C=Q.length>1?Q[1][0]:G,ut=Q.length>2?Q[2][0]:C;if(G!==C&&C!==ut){const g=s[G],m=s[C],d=s[ut],t=Math.sqrt((g.r-d.r)**2+(g.g-d.g)**2+(g.b-d.b)**2),e=Math.sqrt((g.r-m.r)**2+(g.g-m.g)**2+(g.b-m.b)**2),M=Math.sqrt((d.r-m.r)**2+(d.g-m.g)**2+(d.b-m.b)**2);e+M<t*1.1&&(C=ut)}const At=(P-Mt+1)*(yt-wt+1);if((et.get(C)||0)<At*.1&&(C=G),tt!==G&&tt!==C){const g=s[tt],m=s[G],d=s[C],t=(g.r-m.r)**2+(g.g-m.g)**2+(g.b-m.b)**2,e=(g.r-d.r)**2+(g.g-d.g)**2+(g.b-d.b)**2;y[ct]=t<e?G:C;continue}const $=s[G],lt=s[C];let nt=(W.r-$.r)**2+(W.g-$.g)**2+(W.b-$.b)**2,T=(W.r-lt.r)**2+(W.g-lt.g)**2+(W.b-lt.b)**2;const q=1-b/100*.8;tt===G&&(nt*=q),tt===C&&(T*=q),y[ct]=nt<T?G:C}}D.set(y)}}const qt=j*4,Xt=Math.round(n*qt),Yt=Math.round(l*qt),jt=1e7,Lt=Xt*Yt>jt?Math.sqrt(jt/(n*l)):qt,U=Math.round(n*Lt),K=Math.round(l*Lt),zt=new OffscreenCanvas(U,K),at=zt.getContext("2d",{willReadFrequently:!0});if(!at)throw new Error("Could not get workspace context");at.imageSmoothingEnabled=!0,at.imageSmoothingQuality="high",at.drawImage(ht,0,0,U,K);const V=at.getImageData(0,0,U,K).data,bt=new Uint8ClampedArray(V.length),Jt=U/n,Kt=K/l;for(let o=0;o<K;o++){const a=Math.min(l-1,Math.floor(o/Kt)),y=Math.max(0,a-1),_=Math.min(l-1,a+1);for(let H=0;H<U;H++){const w=Math.min(n-1,Math.floor(H/Jt)),P=(o*U+H)*4,i={r:V[P],g:V[P+1],b:V[P+2]},wt=Math.max(0,a-2),yt=Math.min(l-1,a+2),ct=Math.max(0,w-2),tt=Math.min(n-1,w+2);let k=new Map;for(let t=wt;t<=yt;t++){const e=Math.abs(t-a);for(let M=ct;M<=tt;M++){const I=Math.abs(M-w),f=D[t*n+M];let A=1;(I>0||e>0)&&(A=.5),(I>1||e>1)&&(A=.2),k.set(f,(k.get(f)||0)+A)}}const W=Array.from(k.keys()),et=W.filter(t=>{const e=s[t],M=k.get(t)||0;for(const I of W)for(const f of W){if(I===t||f===t||I===f)continue;const A=s[I],X=s[f],Bt=k.get(I)||0,Ct=k.get(f)||0,u=Math.sqrt((A.r-X.r)**2+(A.g-X.g)**2+(A.b-X.b)**2),Z=Math.sqrt((A.r-e.r)**2+(A.g-e.g)**2+(A.b-e.b)**2),It=Math.sqrt((X.r-e.r)**2+(X.g-e.g)**2+(X.b-e.b)**2);if(Z+It<u*1.1&&u>10&&Bt>M&&Ct>M)return!1}return!0}),Q=new Set,G=Math.max(0,a-1),C=Math.min(l-1,a+1),ut=Math.max(0,w-1),At=Math.min(n-1,w+1);for(let t=G;t<=C;t++)for(let e=ut;e<=At;e++)Q.add(D[t*n+e]);const xt=et.map(t=>{const e=s[t],M=k.get(t)||0,I=(i.r-e.r)**2+(i.g-e.g)**2+(i.b-e.b)**2,f=Q.has(t)?0:-1e3;return{id:t,score:M*10+f-Math.sqrt(I)}}).sort((t,e)=>e.score-t.score),$=((Y=xt[0])==null?void 0:Y.id)??W[0],lt=xt.length>1&&xt[1].score>-500?xt[1].id:$,nt=D[a*n+w];let T=nt,q=$;et.includes(nt)?(T=nt,q=nt===$?lt:$):(T=$,q=lt),(k.get(q)||0)<.3&&(q=T);let d;if(T===q){const t=s[T];d={...t.targetHex?mt(t.targetHex):{r:t.r,g:t.g,b:t.b},id:t.id}}else if(st===0){const t=s[T],e=s[q],M=(i.r-t.r)**2+(i.g-t.g)**2+(i.b-t.b)**2,I=(i.r-e.r)**2+(i.g-e.g)**2+(i.b-e.b)**2,f=M<I?t:e;d={...f.targetHex?mt(f.targetHex):{r:f.r,g:f.g,b:f.b},id:f.id}}else{const t=s[T],e=s[q],M=e.r-t.r,I=e.g-t.g,f=e.b-t.b,A=i.r-t.r,X=i.g-t.g,Bt=i.b-t.b,Ct=M*M+I*I+f*f;let u=0;Ct>0&&(u=Math.max(0,Math.min(1,(A*M+X*I+Bt*f)/Ct)));const Z=st/100;let It=!1;if(u>0&&u<1){const St=.4*(1-Z*.5);if(u<St||u>1-St){const vt=(t.r+e.r)/2,N=(t.g+e.g)/2,dt=(t.b+e.b)/2,Gt=(t.r-vt)**2+(t.g-N)**2+(t.b-dt)**2;let pt=!1;const ft=Z>.7?3:2;for(let Et=-ft;Et<=ft;Et+=1){for(let Tt=-ft;Tt<=ft;Tt+=1){if(Tt===0&&Et===0)continue;const ee=Math.max(0,Math.min(K-1,o+Et)),ne=Math.max(0,Math.min(U-1,H+Tt)),Ot=(ee*U+ne)*4,oe=V[Ot],se=V[Ot+1],ae=V[Ot+2],re=(oe-vt)**2+(se-N)**2+(ae-dt)**2,ie=.6+Z*.2;if(re<Gt*ie){pt=!0;break}}if(pt)break}pt||(It=!0)}}if(It&&(u=u<.5?0:1),u>0&&u<.25){const St=i.r,_t=i.g,vt=i.b,N=s[T],dt=s[q],Gt=(St-N.r)**2+(_t-N.g)**2+(vt-N.b)**2,pt=(N.r-dt.r)**2+(N.g-dt.g)**2+(N.b-dt.b)**2,ft=.05*(1-Z);Gt<pt*ft&&(u=0)}const Ft=.15*(1-Z);u<Ft&&(u=0),u>1-Ft&&(u=1);const Rt=28*(1-Z)+8*Z,Ut=1/(1+Math.exp(-Rt*-.5)),te=1/(1+Math.exp(-Rt*.5)),Dt=(1/(1+Math.exp(-Rt*(u-.5)))-Ut)/(te-Ut),Ht=s[T],Pt=s[q],gt=Ht.targetHex?mt(Ht.targetHex):Ht,kt=Pt.targetHex?mt(Pt.targetHex):Pt;d={r:Math.round(gt.r+Dt*(kt.r-gt.r)),g:Math.round(gt.g+Dt*(kt.g-gt.g)),b:Math.round(gt.b+Dt*(kt.b-gt.b)),id:`blend-${T}-${q}`}}bt[P]=d.r,bt[P+1]=d.g,bt[P+2]=d.b,bt[P+3]=255}}at.putImageData(new ImageData(bt,U,K),0,0);const rt=new OffscreenCanvas(Math.round(n*j),Math.round(l*j)),it=rt.getContext("2d");if(!it)throw new Error("Could not get final context");it.fillStyle="#000000",it.fillRect(0,0,rt.width,rt.height),it.imageSmoothingEnabled=!0,it.imageSmoothingQuality="high",it.drawImage(zt,0,0,rt.width,rt.height);const Vt=await Wt(rt,c==="NS");self.postMessage({type:"complete",result:Vt})}catch(n){self.postMessage({type:"complete",error:n.message})}}})();
