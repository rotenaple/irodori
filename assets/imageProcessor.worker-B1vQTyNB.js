(function(){"use strict";const Gt=(P,i,w)=>{const C=S=>Math.max(0,Math.min(255,Math.round(S))).toString(16).padStart(2,"0");return`#${C(P)}${C(i)}${C(w)}`.toLowerCase()},Mt=P=>{const i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(P);return i?{r:parseInt(i[1],16),g:parseInt(i[2],16),b:parseInt(i[3],16)}:null},Nt=(P,i,w=1)=>{if(i.length===0)return{r:0,g:0,b:0,hex:"#000000",id:"default"};let C=1/0,S=i[0];const{r:Y,g:G,b:W}=P;for(let N=0;N<i.length;N++){const k=i[N];let X=(Y-k.r)**2+(G-k.g)**2+(W-k.b)**2;k.id.startsWith("group-")&&(X*=w*w),X<C&&(C=X,S=k)}return S},Xt=(P,i=1)=>{const{width:w,height:C,data:S}=P,Y=new ImageData(new Uint8ClampedArray(S),w,C),G=Y.data,W=(2*i+1)**2,N=new Uint8Array(W),k=new Uint8Array(W),X=new Uint8Array(W);for(let et=0;et<C;et++)for(let _=0;_<w;_++){let e=0;for(let E=-i;E<=i;E++){const D=et+E;if(D<0||D>=C)continue;const ft=D*w;for(let F=-i;F<=i;F++){const ot=_+F;if(ot<0||ot>=w)continue;const J=(ft+ot)*4;N[e]=S[J],k[e]=S[J+1],X[e]=S[J+2],e++}}const c=N.subarray(0,e).sort(),O=k.subarray(0,e).sort(),ht=X.subarray(0,e).sort(),T=Math.floor(e/2),o=(et*w+_)*4;G[o]=c[T],G[o+1]=O[T],G[o+2]=ht[T],G[o+3]=S[o+3]}return Y};self.onmessage=async P=>{var _;if(P.data.type!=="process")return;const{imageBitmap:i,parameters:w}=P.data,{upscaleFactor:C,denoiseRadius:S,edgeProtection:Y,vertexInertia:G,disablePostProcessing:W,disableRecoloring:N,disableScaling:k,palette:X,smoothingLevels:et}=w;try{const e=i.width,c=i.height;let O=1;if(!k)if(C==="NS"){const s=Math.max(e,c),a=Math.min(e,c),u=Math.min(535/s,355/a),y=Math.min(568/s,321/a);O=Math.max(u,y)}else O=C;const ht=new OffscreenCanvas(e,c),T=ht.getContext("2d",{willReadFrequently:!0});if(!T)throw new Error("Could not get native context");if(T.drawImage(i,0,0),!W&&S>0){const s=T.getImageData(0,0,e,c),a=Xt(s,S);T.putImageData(a,0,0)}if(N){const s=Math.round(e*O),a=Math.round(c*O),u=new OffscreenCanvas(s,a),y=u.getContext("2d");if(!y)throw new Error("Could not get final context");y.imageSmoothingEnabled=!0,y.imageSmoothingQuality="high",y.drawImage(ht,0,0,s,a);const m=await u.convertToBlob({type:"image/png"});self.postMessage({type:"complete",result:m});return}const o=X,E=T.getImageData(0,0,e,c).data;let D=new Int16Array(e*c);const ft=new Map;w.palette.forEach((s,a)=>{var y;const u=(y=w.colorGroups)==null?void 0:y.find(m=>m.id===s.id);u?u.members.forEach(m=>{ft.set(m.hex.toLowerCase(),a)}):ft.set(s.hex.toLowerCase(),a)});for(let s=0;s<E.length;s+=4){const a=E[s],u=E[s+1],y=E[s+2],m=Gt(a,u,y);let f=ft.get(m);if(f===void 0){const A=Nt({r:a,g:u,b:y},o);f=o.findIndex(r=>r.id===A.id)}D[s/4]=f!==-1?f:0}const F=W?0:Y,ot=W?0:et;if(F>0){let s=Math.max(1,Math.round(F/100*3)),a=Math.max(1,Math.round(F/100*4));F>66&&(s=3,a=3),F>85&&(s=5,a=5);const u=new Int16Array(D.length),y=o.length;for(let m=0;m<a;m++){for(let f=0;f<c;f++){const pt=Math.max(0,f-s),A=Math.min(c-1,f+s);for(let r=0;r<e;r++){const wt=Math.max(0,r-s),yt=Math.min(e-1,r+s),it=f*e+r,Z=D[it],H=it*4,R={r:E[H],g:E[H+1],b:E[H+2]},tt=new Map;for(let l=pt;l<=A;l++)for(let x=wt;x<=yt;x++){const g=D[l*e+x];tt.set(g,(tt.get(g)||0)+1)}const z=Array.from(tt.entries()).sort((l,x)=>x[1]-l[1]);let B=z[0][0],M=z.length>1?z[1][0]:B,bt=z.length>2?z[2][0]:M;if(B!==M&&M!==bt){const l=o[B],x=o[M],g=o[bt],t=Math.sqrt((l.r-g.r)**2+(l.g-g.g)**2+(l.b-g.b)**2),n=Math.sqrt((l.r-x.r)**2+(l.g-x.g)**2+(l.b-x.b)**2),b=Math.sqrt((g.r-x.r)**2+(g.g-x.g)**2+(g.b-x.b)**2);n+b<t*1.1&&(M=bt)}const At=(A-pt+1)*(yt-wt+1);if((tt.get(M)||0)<At*.1&&(M=B),Z!==B&&Z!==M){const l=o[Z],x=o[B],g=o[M],t=(l.r-x.r)**2+(l.g-x.g)**2+(l.b-x.b)**2,n=(l.r-g.r)**2+(l.g-g.g)**2+(l.b-g.b)**2;u[it]=t<n?B:M;continue}const U=o[B],ct=o[M];let nt=(R.r-U.r)**2+(R.g-U.g)**2+(R.b-U.b)**2,I=(R.r-ct.r)**2+(R.g-ct.g)**2+(R.b-ct.b)**2;const v=1-G/100*.8;Z===B&&(nt*=v),Z===M&&(I*=v),u[it]=nt<I?B:M}}D.set(u)}}const J=O*4,zt=Math.round(e*J),Qt=Math.round(c*J),Tt=1e7,Ft=zt*Qt>Tt?Math.sqrt(Tt/(e*c)):J,L=Math.round(e*Ft),K=Math.round(c*Ft),Lt=new OffscreenCanvas(L,K),st=Lt.getContext("2d",{willReadFrequently:!0});if(!st)throw new Error("Could not get workspace context");st.imageSmoothingEnabled=!0,st.imageSmoothingQuality="high",st.drawImage(ht,0,0,L,K);const V=st.getImageData(0,0,L,K).data,xt=new Uint8ClampedArray(V.length),Yt=L/e,_t=K/c;for(let s=0;s<K;s++){const a=Math.min(c-1,Math.floor(s/_t)),u=Math.max(0,a-1),y=Math.min(c-1,a+1);for(let m=0;m<L;m++){const f=Math.min(e-1,Math.floor(m/Yt)),A=(s*L+m)*4,r={r:V[A],g:V[A+1],b:V[A+2]},wt=Math.max(0,a-2),yt=Math.min(c-1,a+2),it=Math.max(0,f-2),Z=Math.min(e-1,f+2);let H=new Map;for(let t=wt;t<=yt;t++){const n=Math.abs(t-a);for(let b=it;b<=Z;b++){const p=Math.abs(b-f),d=D[t*e+b];let q=1;(p>0||n>0)&&(q=.5),(p>1||n>1)&&(q=.2),H.set(d,(H.get(d)||0)+q)}}const R=Array.from(H.keys()),tt=R.filter(t=>{const n=o[t],b=H.get(t)||0;for(const p of R)for(const d of R){if(p===t||d===t||p===d)continue;const q=o[p],Q=o[d],Ht=H.get(p)||0,Ct=H.get(d)||0,h=Math.sqrt((q.r-Q.r)**2+(q.g-Q.g)**2+(q.b-Q.b)**2),$=Math.sqrt((q.r-n.r)**2+(q.g-n.g)**2+(q.b-n.b)**2),St=Math.sqrt((Q.r-n.r)**2+(Q.g-n.g)**2+(Q.b-n.b)**2);if($+St<h*1.1&&h>10&&Ht>b&&Ct>b)return!1}return!0}),z=new Set,B=Math.max(0,a-1),M=Math.min(c-1,a+1),bt=Math.max(0,f-1),At=Math.min(e-1,f+1);for(let t=B;t<=M;t++)for(let n=bt;n<=At;n++)z.add(D[t*e+n]);const mt=tt.map(t=>{const n=o[t],b=H.get(t)||0,p=(r.r-n.r)**2+(r.g-n.g)**2+(r.b-n.b)**2,d=z.has(t)?0:-1e3;return{id:t,score:b*10+d-Math.sqrt(p)}}).sort((t,n)=>n.score-t.score),U=((_=mt[0])==null?void 0:_.id)??R[0],ct=mt.length>1&&mt[1].score>-500?mt[1].id:U,nt=D[a*e+f];let I=nt,v=U;tt.includes(nt)?(I=nt,v=nt===U?ct:U):(I=U,v=ct),(H.get(v)||0)<.3&&(v=I);let g;if(I===v){const t=o[I];g={...t.targetHex?Mt(t.targetHex):{r:t.r,g:t.g,b:t.b},id:t.id}}else if(ot===0){const t=o[I],n=o[v],b=(r.r-t.r)**2+(r.g-t.g)**2+(r.b-t.b)**2,p=(r.r-n.r)**2+(r.g-n.g)**2+(r.b-n.b)**2,d=b<p?t:n;g={...d.targetHex?Mt(d.targetHex):{r:d.r,g:d.g,b:d.b},id:d.id}}else{const t=o[I],n=o[v],b=n.r-t.r,p=n.g-t.g,d=n.b-t.b,q=r.r-t.r,Q=r.g-t.g,Ht=r.b-t.b,Ct=b*b+p*p+d*d;let h=0;Ct>0&&(h=Math.max(0,Math.min(1,(q*b+Q*p+Ht*d)/Ct)));const $=ot/100;let St=!1;if(h>0&&h<1){const It=.4*(1-$*.5);if(h<It||h>1-It){const vt=(t.r+n.r)/2,j=(t.g+n.g)/2,gt=(t.b+n.b)/2,Wt=(t.r-vt)**2+(t.g-j)**2+(t.b-gt)**2;let ut=!1;const dt=$>.7?3:2;for(let qt=-dt;qt<=dt;qt+=1){for(let Dt=-dt;Dt<=dt;Dt+=1){if(Dt===0&&qt===0)continue;const Vt=Math.max(0,Math.min(K-1,s+qt)),Zt=Math.max(0,Math.min(L-1,m+Dt)),Ot=(Vt*L+Zt)*4,tn=V[Ot],nn=V[Ot+1],en=V[Ot+2],on=(tn-vt)**2+(nn-j)**2+(en-gt)**2,sn=.6+$*.2;if(on<Wt*sn){ut=!0;break}}if(ut)break}ut||(St=!0)}}if(St&&(h=h<.5?0:1),h>0&&h<.25){const It=r.r,jt=r.g,vt=r.b,j=o[I],gt=o[v],Wt=(It-j.r)**2+(jt-j.g)**2+(vt-j.b)**2,ut=(j.r-gt.r)**2+(j.g-gt.g)**2+(j.b-gt.b)**2,dt=.05*(1-$);Wt<ut*dt&&(h=0)}const Ut=.15*(1-$);h<Ut&&(h=0),h>1-Ut&&(h=1);const Bt=28*(1-$)+8*$,$t=1/(1+Math.exp(-Bt*-.5)),Kt=1/(1+Math.exp(-Bt*.5)),Et=(1/(1+Math.exp(-Bt*(h-.5)))-$t)/(Kt-$t),Rt=o[I],Pt=o[v],lt=Rt.targetHex?Mt(Rt.targetHex):Rt,kt=Pt.targetHex?Mt(Pt.targetHex):Pt;g={r:Math.round(lt.r+Et*(kt.r-lt.r)),g:Math.round(lt.g+Et*(kt.g-lt.g)),b:Math.round(lt.b+Et*(kt.b-lt.b)),id:`blend-${I}-${v}`}}xt[A]=g.r,xt[A+1]=g.g,xt[A+2]=g.b,xt[A+3]=255}}st.putImageData(new ImageData(xt,L,K),0,0);const at=new OffscreenCanvas(Math.round(e*O),Math.round(c*O)),rt=at.getContext("2d");if(!rt)throw new Error("Could not get final context");rt.fillStyle="#000000",rt.fillRect(0,0,at.width,at.height),rt.imageSmoothingEnabled=!0,rt.imageSmoothingQuality="high",rt.drawImage(Lt,0,0,at.width,at.height);const Jt=await at.convertToBlob({type:"image/png"});self.postMessage({type:"complete",result:Jt})}catch(e){self.postMessage({type:"complete",error:e.message})}}})();
