(function(){"use strict";const Rn=(a,o,e)=>{const c=r=>Math.max(0,Math.min(255,Math.round(r))).toString(16).padStart(2,"0");return`#${c(a)}${c(o)}${c(e)}`.toLowerCase()},gn=a=>{const o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);return o?{r:parseInt(o[1],16),g:parseInt(o[2],16),b:parseInt(o[3],16)}:null},Tn=(a,o,e)=>{a/=255,o/=255,e/=255;const c=Math.max(a,o,e),r=Math.min(a,o,e);let f=0,g=0,d=(c+r)/2;if(c!==r){const u=c-r;switch(g=d>.5?u/(2-c-r):u/(c+r),c){case a:f=(o-e)/u+(o<e?6:0);break;case o:f=(e-a)/u+2;break;case e:f=(a-o)/u+4;break}f/=6}return{h:f*360,s:g*100,l:d*100}},un=(a,o,e)=>{a/=360,o/=100,e/=100;const c=(d,u,y)=>(y<0&&(y+=1),y>1&&(y-=1),y<1/6?d+(u-d)*6*y:y<1/2?u:y<2/3?d+(u-d)*(2/3-y)*6:d);let r,f,g;if(o===0)r=f=g=e;else{const d=e<.5?e*(1+o):e+o-e*o,u=2*e-d;r=c(u,d,a+.3333333333333333),f=c(u,d,a),g=c(u,d,a-.3333333333333333)}return{r:Math.round(r*255),g:Math.round(f*255),b:Math.round(g*255)}},Gn=(a,o)=>{let e=o-a;return e>180&&(e-=360),e<-180&&(e+=360),e},En=(a,o)=>{let e=a+o;for(;e<0;)e+=360;for(;e>=360;)e-=360;return e},Dn=(a,o,e=1)=>{if(o.length===0)return{r:0,g:0,b:0,hex:"#000000",id:"default"};let c=1/0,r=o[0];const{r:f,g,b:d}=a;for(let u=0;u<o.length;u++){const y=o[u];let N=(f-y.r)**2+(g-y.g)**2+(d-y.b)**2;y.id.startsWith("group-")&&(N*=e*e),N<c&&(c=N,r=y)}return r},Hn=(a,o=1)=>{const{width:e,height:c,data:r}=a,f=new ImageData(new Uint8ClampedArray(r),e,c),g=f.data,d=(2*o+1)**2,u=new Uint8Array(d),y=new Uint8Array(d),N=new Uint8Array(d);for(let ct=0;ct<c;ct++)for(let bt=0;bt<e;bt++){let _=0;for(let i=-o;i<=o;i++){const h=ct+i;if(h<0||h>=c)continue;const dt=h*e;for(let At=-o;At<=o;At++){const ut=bt+At;if(ut<0||ut>=e)continue;const Ct=(dt+ut)*4;u[_]=r[Ct],y[_]=r[Ct+1],N[_]=r[Ct+2],_++}}const wt=u.subarray(0,_).sort(),$t=y.subarray(0,_).sort(),ft=N.subarray(0,_).sort(),Tt=Math.floor(_/2),yt=(ct*e+bt)*4;g[yt]=wt[Tt],g[yt+1]=$t[Tt],g[yt+2]=ft[Tt],g[yt+3]=r[yt+3]}return f};function qn(a,o,e,c,r){if(o<5){const $t=r.lightnessForce/100,ft=Math.max(0,Math.min(100,e+r.lightness*$t));return un(a,o,ft)}const f=Gn(c,a),g=En(r.hue,f),d=r.hueForce/100,u=r.saturationForce/100,y=r.lightnessForce/100,N=d<1?a+(g-a)*d:g,ct=r.saturation*u,bt=Math.max(0,Math.min(100,o+ct)),_=r.lightness*y,wt=Math.max(0,Math.min(100,e+_));return un(N,bt,wt)}function pn(a,o,e,c,r){const f=Tn(a,o,e);return qn(f.h,f.s,f.l,c,r)}async function On(a,o,e,c=.5,r=1){let f=null,g=c,d=c,u=r;const y=.01;for(;u-d>y;){const N=(d+u)/2,ct=await a.convertToBlob({type:o,quality:N});ct.size<=e?(f=ct,g=N,d=N):u=N}return{blob:f,quality:g}}async function en(a,o){if(!o)return await a.convertToBlob({type:"image/png"});const c=await a.convertToBlob({type:"image/png"});if(c.size<=153600)return c;let r=c,f="png";try{const g=await a.convertToBlob({type:"image/gif"});g.size<=153600&&(r=g,f="gif")}catch{}if(f==="png"){const g=await On(a,"image/jpeg",153600,.5,1);g.blob&&g.blob.size<=153600&&(r=g.blob,f="jpeg")}return r}self.onmessage=async a=>{var Tt,yt;if(a.data.type!=="process")return;const{imageBitmap:o,parameters:e}=a.data,{upscaleFactor:c,denoiseRadius:r,edgeProtection:f,vertexInertia:g,disablePostProcessing:d,disableRecoloring:u,disableScaling:y,palette:N,smoothingLevels:ct,alphaSmoothness:bt,preserveTransparency:_,pixelArtConfig:wt,recolorMode:$t,tintOverrides:ft}=e;try{const i=o.width,h=o.height;if(wt!=null&&wt.enabled){const{pixelWidth:t,pixelHeight:s,offsetX:G,offsetY:x}=wt,b=Math.ceil(i/t),A=Math.ceil(h/s),j=new OffscreenCanvas(i,h).getContext("2d",{willReadFrequently:!0,alpha:!0});if(!j)throw new Error("Could not get source context");j.imageSmoothingEnabled=!1,j.drawImage(o,0,0);const B=j.getImageData(0,0,i,h),F=new OffscreenCanvas(b,A),rt=F.getContext("2d");if(!rt)throw new Error("Could not get pixel context");const K=rt.createImageData(b,A);for(let m=0;m<A;m++)for(let Z=0;Z<b;Z++){const p=new Map,$=Math.max(0,Math.min(Z*t+G,i-1)),D=Math.max(0,Math.min(m*s+x,h-1)),it=Math.max(0,Math.min($+t,i)),gt=Math.max(0,Math.min(D+s,h));for(let M=D;M<gt;M++)for(let z=$;z<it;z++){const et=(M*i+z)*4,Q=B.data[et],at=B.data[et+1],C=B.data[et+2],R=B.data[et+3],n=`${Q},${at},${C},${R}`,l=p.get(n);l?l.count++:p.set(n,{count:1,r:Q,g:at,b:C,a:R})}let mt=0,nt={r:0,g:0,b:0,a:255};for(const M of p.values())M.count>mt&&(mt=M.count,nt=M);let W=nt;if(!u&&N.length>0){const M={r:nt.r,g:nt.g,b:nt.b},z=Dn(M,N);if(z.targetHex){const et=gn(z.targetHex);et&&(W={...et,a:nt.a})}else W={r:z.r,g:z.g,b:z.b,a:nt.a};if(ft&&ft[z.id]!==void 0){const et=ft[z.id],Q=(Tt=e.colorGroups)==null?void 0:Tt.find(R=>R.id===z.id),at=(Q==null?void 0:Q.baseHue)??0;W={...pn(W.r,W.g,W.b,at,et),a:W.a}}}const S=(m*b+Z)*4;K.data[S]=W.r,K.data[S+1]=W.g,K.data[S+2]=W.b,K.data[S+3]=_?W.a:255}rt.putImageData(K,0,0);let V=1;if(!y){let m,Z;if(c==="NS"){const D=i>=h;m=D?535:321,Z=D?355:568}else{const D=c;m=i*D,Z=h*D}const p=Math.floor(m/b),$=Math.floor(Z/A);V=Math.max(1,Math.min(p,$))}const ot=b*V,tt=A*V,st=new OffscreenCanvas(ot,tt),ht=st.getContext("2d");if(!ht)throw new Error("Could not get final context");ht.imageSmoothingEnabled=!1,ht.drawImage(F,0,0,ot,tt);const Et=await en(st,c==="NS");self.postMessage({type:"complete",result:Et});return}let dt=1;y||(c==="NS"?i>=h?dt=Math.min(535/i,355/h):dt=Math.min(321/i,568/h):dt=c);const At=new OffscreenCanvas(i,h),ut=At.getContext("2d",{willReadFrequently:!0,alpha:!0});if(!ut)throw new Error("Could not get native context");if(ut.drawImage(o,0,0),!d&&r>0){const t=ut.getImageData(0,0,i,h),s=Hn(t,r);ut.putImageData(s,0,0)}if(u){const t=Math.round(i*dt),s=Math.round(h*dt),G=new OffscreenCanvas(t,s),x=G.getContext("2d");if(!x)throw new Error("Could not get final context");x.imageSmoothingEnabled=!0,x.imageSmoothingQuality="high",x.drawImage(At,0,0,t,s);const b=await en(G,c==="NS");self.postMessage({type:"complete",result:b});return}const Ct=N,pt=ut.getImageData(0,0,i,h).data;let It=new Int16Array(i*h),zt=null;if(_){zt=new Uint8ClampedArray(i*h);for(let t=0;t<pt.length;t+=4)zt[t/4]=pt[t+3]}const Yt=new Map,xn=new Map,X=Ct.length,k=new Uint8Array(X),L=new Uint8Array(X),U=new Uint8Array(X),Fn=new Array(X);for(let t=0;t<X;t++){const s=Ct[t];xn.set(s.id,t),k[t]=s.r,L[t]=s.g,U[t]=s.b,Fn[t]=s.id}if(e.colorGroups)for(let t=0;t<e.colorGroups.length;t++){const s=e.colorGroups[t],G=xn.get(s.id);if(G!==void 0)for(let x=0;x<s.members.length;x++)Yt.set(s.members[x].hex.toLowerCase(),G)}for(let t=0;t<X;t++){const s=Ct[t].hex.toLowerCase();Yt.has(s)||Yt.set(s,t)}for(let t=0;t<pt.length;t+=4){const s=pt[t],G=pt[t+1],x=pt[t+2],b=Rn(s,G,x);let A=Yt.get(b);if(A===void 0){let O=1/0,j=0;for(let B=0;B<X;B++){const F=s-k[B],rt=G-L[B],K=x-U[B],V=F*F+rt*rt+K*K;V<O&&(O=V,j=B)}A=j}It[t/4]=A}const Dt=d?0:f,mn=d?0:ct;if(Dt>0){let t=Math.max(1,Math.round(Dt/100*3)),s=Math.max(1,Math.round(Dt/100*4));Dt>66&&(t=3,s=3),Dt>85&&(t=5,s=5);const G=new Int16Array(It.length),x=new Uint32Array(X);for(let b=0;b<s;b++){for(let A=0;A<h;A++){const O=Math.max(0,A-t),j=Math.min(h-1,A+t),B=A*i;for(let F=0;F<i;F++){const rt=Math.max(0,F-t),K=Math.min(i-1,F+t),V=B+F,ot=It[V],tt=V*4,st=pt[tt],ht=pt[tt+1],Et=pt[tt+2];x.fill(0);for(let C=O;C<=j;C++){const R=C*i;for(let n=rt;n<=K;n++){const l=It[R+n];x[l]++}}let m=0,Z=0,p=0,$=0,D=0,it=0;for(let C=0;C<X;C++){const R=x[C];R>Z?(D=p,it=$,p=m,$=Z,m=C,Z=R):R>$?(D=p,it=$,p=C,$=R):R>it&&(D=C,it=R)}if(m!==p&&p!==D){const C=k[m],R=L[m],n=U[m],l=k[p],w=L[p],v=U[p],H=k[D],E=L[D],I=U[D],T=Math.sqrt((C-H)**2+(R-E)**2+(n-I)**2),P=Math.sqrt((C-l)**2+(R-w)**2+(n-v)**2),Y=Math.sqrt((H-l)**2+(E-w)**2+(I-v)**2);P+Y<T*1.1&&(p=D,$=it)}const gt=(j-O+1)*(K-rt+1);if($<gt*.1&&(p=m),ot!==m&&ot!==p){const C=k[ot],R=L[ot],n=U[ot],l=k[m],w=L[m],v=U[m],H=k[p],E=L[p],I=U[p],T=(C-l)**2+(R-w)**2+(n-v)**2,P=(C-H)**2+(R-E)**2+(n-I)**2;G[V]=T<P?m:p;continue}const mt=k[m],nt=L[m],W=U[m],S=k[p],M=L[p],z=U[p];let et=(st-mt)**2+(ht-nt)**2+(Et-W)**2,Q=(st-S)**2+(ht-M)**2+(Et-z)**2;const at=1-g/100*.8;ot===m&&(et*=at),ot===p&&(Q*=at),G[V]=et<Q?m:p}}It.set(G)}}const on=dt*4,kn=Math.round(i*on),Ln=Math.round(h*on),Mn=1e7,bn=kn*Ln>Mn?Math.sqrt(Mn/(i*h)):on,xt=Math.round(i*bn),Bt=Math.round(h*bn),wn=new OffscreenCanvas(xt,Bt),Gt=wn.getContext("2d",{willReadFrequently:!0,alpha:!0});if(!Gt)throw new Error("Could not get workspace context");Gt.imageSmoothingEnabled=!0,Gt.imageSmoothingQuality="high",Gt.drawImage(At,0,0,xt,Bt);const St=Gt.getImageData(0,0,xt,Bt).data,Ht=new Uint8ClampedArray(St.length),Un=xt/i,jn=Bt/h,qt=new Uint8Array(X),Ot=new Uint8Array(X),Ft=new Uint8Array(X);for(let t=0;t<X;t++){const s=Ct[t];let G=s.r,x=s.g,b=s.b;if(s.targetHex){const A=gn(s.targetHex);A&&(G=A.r,x=A.g,b=A.b)}if(ft&&ft[s.id]!==void 0){const A=ft[s.id],O=(yt=e.colorGroups)==null?void 0:yt.find(F=>F.id===s.id),j=(O==null?void 0:O.baseHue)??0,B=pn(G,x,b,j,A);G=B.r,x=B.g,b=B.b}qt[t]=G,Ot[t]=x,Ft[t]=b}const vt=new Float32Array(X),sn=new Uint8Array(X),an=new Float32Array(X);for(let t=0;t<Bt;t++){const s=Math.min(h-1,Math.floor(t/jn)),G=s*i;for(let x=0;x<xt;x++){const b=Math.min(i-1,Math.floor(x/Un)),O=(t*xt+x)*4,j=St[O],B=St[O+1],F=St[O+2],rt=Math.max(0,s-2),K=Math.min(h-1,s+2),V=Math.max(0,b-2),ot=Math.min(i-1,b+2);vt.fill(0);for(let n=rt;n<=K;n++){const l=Math.abs(n-s),w=n*i;for(let v=V;v<=ot;v++){const H=Math.abs(v-b),E=It[w+v];let I=1;(H>0||l>0)&&(I=.5),(H>1||l>1)&&(I=.2),vt[E]+=I}}const tt=[];for(let n=0;n<X;n++)vt[n]>0&&tt.push(n);const st=[],ht=tt.length;t:for(let n=0;n<ht;n++){const l=tt[n],w=k[l],v=L[l],H=U[l],E=vt[l];for(let I=0;I<ht;I++){const T=tt[I];if(T!==l)for(let P=0;P<ht;P++){const Y=tt[P];if(Y===l||T===Y)continue;const Mt=k[T],lt=L[T],Rt=U[T],q=k[Y],J=L[Y],kt=U[Y],Qt=vt[T],Lt=vt[Y],Ut=Math.sqrt((Mt-q)**2+(lt-J)**2+(Rt-kt)**2),cn=Math.sqrt((Mt-w)**2+(lt-v)**2+(Rt-H)**2),yn=Math.sqrt((q-w)**2+(J-v)**2+(kt-H)**2);if(cn+yn<Ut*1.1&&Ut>10&&Qt>E&&Lt>E)continue t}}st.push(l)}sn.fill(0);const Et=Math.max(0,s-1),m=Math.min(h-1,s+1),Z=Math.max(0,b-1),p=Math.min(i-1,b+1);for(let n=Et;n<=m;n++){const l=n*i;for(let w=Z;w<=p;w++)sn[It[l+w]]=1}const $=st.length;let D=-1/0,it=0;for(let n=0;n<$;n++){const l=st[n],w=k[l],v=L[l],H=U[l],E=vt[l],I=j-w,T=B-v,P=F-H,Y=I*I+T*T+P*P,Mt=sn[l]?0:-1e3,lt=E*10+Mt-Math.sqrt(Y);an[n]=lt,lt>D&&(D=lt,it=n)}let gt=$>0?st[it]:tt[0],mt=gt,nt=-1/0;for(let n=0;n<$;n++)n!==it&&an[n]>nt&&(nt=an[n],mt=st[n]);nt<=-500&&(mt=gt);const W=It[G+b];let S=W,M=gt,z=!1;for(let n=0;n<$;n++)if(st[n]===W){z=!0;break}z?(S=W,M=W===gt?mt:gt):(S=gt,M=mt),vt[M]<.3&&(M=S);let Q,at,C;if(S===M)Q=qt[S],at=Ot[S],C=Ft[S];else if(mn===0){const n=k[S],l=L[S],w=U[S],v=k[M],H=L[M],E=U[M],I=j-n,T=B-l,P=F-w,Y=j-v,Mt=B-H,lt=F-E,Rt=I*I+T*T+P*P,q=Y*Y+Mt*Mt+lt*lt,J=Rt<q?S:M;Q=qt[J],at=Ot[J],C=Ft[J]}else{const n=k[S],l=L[S],w=U[S],v=k[M],H=L[M],E=U[M],I=v-n,T=H-l,P=E-w,Y=j-n,Mt=B-l,lt=F-w,Rt=I*I+T*T+P*P;let q=0;Rt>0&&(q=Math.max(0,Math.min(1,(Y*I+Mt*T+lt*P)/Rt)));const J=mn/100;let kt=!1;if(q>0&&q<1){const jt=.4*(1-J*.5);if(q<jt||q>1-jt){const Wt=(n+v)/2,Pt=(l+H)/2,Nt=(w+E)/2,Xt=n-Wt,Jt=l-Pt,Kt=w-Nt,fn=Xt*Xt+Jt*Jt+Kt*Kt;let dn=!1;const Vt=J>.7?3:2;for(let tn=-Vt;tn<=Vt;tn+=1){for(let nn=-Vt;nn<=Vt;nn+=1){if(nn===0&&tn===0)continue;const $n=Math.max(0,Math.min(Bt-1,t+tn)),zn=Math.max(0,Math.min(xt-1,x+nn)),hn=($n*xt+zn)*4,Yn=St[hn],_n=St[hn+1],Zn=St[hn+2],vn=Yn-Wt,An=_n-Pt,Bn=Zn-Nt,Qn=vn*vn+An*An+Bn*Bn,Jn=.6+J*.2;if(Qn<fn*Jn){dn=!0;break}}if(dn)break}dn||(kt=!0)}}if(kt&&(q=q<.5?0:1),q>0&&q<.25){const jt=j-n,ln=B-l,Wt=F-w,Pt=n-v,Nt=l-H,Xt=w-E,Jt=jt*jt+ln*ln+Wt*Wt,Kt=Pt*Pt+Nt*Nt+Xt*Xt,fn=.05*(1-J);Jt<Kt*fn&&(q=0)}const Qt=.15*(1-J);q<Qt&&(q=0),q>1-Qt&&(q=1);const Lt=28*(1-J)+8*J,Ut=1/(1+Math.exp(-Lt*-.5)),cn=1/(1+Math.exp(-Lt*.5)),rn=(1/(1+Math.exp(-Lt*(q-.5)))-Ut)/(cn-Ut),Cn=qt[S],In=Ot[S],Sn=Ft[S],Pn=qt[M],Nn=Ot[M],Xn=Ft[M];Q=Math.round(Cn+rn*(Pn-Cn)),at=Math.round(In+rn*(Nn-In)),C=Math.round(Sn+rn*(Xn-Sn))}let R=255;if(_&&zt){const n=s*i+b,l=zt[n],w=St[O+3],v=(bt||0)/100;if(v===0)R=l;else{const H=w/255,E=20*(1-v)+2*v,I=1/(1+Math.exp(-E*-.5)),T=1/(1+Math.exp(-E*.5)),Y=(1/(1+Math.exp(-E*(H-.5)))-I)/(T-I);R=Math.round(Y*255)}}Ht[O]=Q,Ht[O+1]=at,Ht[O+2]=C,Ht[O+3]=R}}Gt.putImageData(new ImageData(Ht,xt,Bt),0,0);const _t=new OffscreenCanvas(Math.round(i*dt),Math.round(h*dt)),Zt=_t.getContext("2d",{alpha:!0});if(!Zt)throw new Error("Could not get final context");Zt.imageSmoothingEnabled=!0,Zt.imageSmoothingQuality="high",Zt.drawImage(wn,0,0,_t.width,_t.height);const Wn=await en(_t,c==="NS");self.postMessage({type:"complete",result:Wn})}catch(i){self.postMessage({type:"complete",error:i.message})}}})();
