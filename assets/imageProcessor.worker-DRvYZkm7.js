(function(){"use strict";const X="Operation requires compiling with --exportTable",z="Operation requires compiling with --exportRuntime",p=()=>{throw Error(z)},K=typeof BigUint64Array<"u",B=Symbol(),Q=192,d=1024,J=new TextDecoder("utf-16le",{fatal:!0});Object.hasOwn=Object.hasOwn||function(t,u){return Object.prototype.hasOwnProperty.call(t,u)};function j(t,u){let o=new Uint32Array(t)[u+-4>>>2]>>>1;const e=new Uint16Array(t,u,o);if(o<=Q)return String.fromCharCode(...e);try{return J.decode(e)}catch{let s="",i=0;for(;o-i>d;)s+=String.fromCharCode(...e.subarray(i,i+=d));return s+String.fromCharCode(...e.subarray(i))}}function H(t){const u={};function o(s,i){return s?j(s.buffer,i):"<yet unknown>"}const e=t.env=t.env||{};return e.abort=e.abort||function(i,f,l,R){const _=u.memory||e.memory;throw Error(`abort: ${o(_,i)} at ${o(_,f)}:${l}:${R}`)},e.trace=e.trace||function(i,f,...l){const R=u.memory||e.memory;console.log(`trace: ${o(R,i)}${f?" ":""}${l.slice(0,f).join(", ")}`)},e.seed=e.seed||Date.now,t.Math=t.Math||Math,t.Date=t.Date||Date,u}function $(t,u){const o=u.exports,e=o.memory,s=o.table,i=o.__new||p,f=o.__pin||p,l=o.__unpin||p,R=o.__collect||p,_=o.__rtti_base,w=_?n=>n[_>>>2]:p;t.__new=i,t.__pin=f,t.__unpin=l,t.__collect=R;function g(n){const r=new Uint32Array(e.buffer);if((n>>>=0)>=w(r))throw Error(`invalid id: ${n}`);return r[(_+4>>>2)+n]}function y(n){const r=g(n);if(!(r&7))throw Error(`not an array: ${n}, flags=${r}`);return r}function F(n){return 31-Math.clz32(n>>>6&31)}function Y(n){if(n==null)return 0;const r=n.length,c=i(r<<1,2),a=new Uint16Array(e.buffer);for(let A=0,E=c>>>1;A<r;++A)a[E+A]=n.charCodeAt(A);return c}t.__newString=Y;function L(n){if(n==null)return 0;const r=new Uint8Array(n),c=i(r.length,1);return new Uint8Array(e.buffer).set(r,c),c}t.__newArrayBuffer=L;function S(n){if(!n)return null;const r=e.buffer;if(new Uint32Array(r)[n+-8>>>2]!==2)throw Error(`not a string: ${n}`);return j(r,n)}t.__getString=S;function h(n,r,c){const a=e.buffer;if(c)switch(n){case 2:return new Float32Array(a);case 3:return new Float64Array(a)}else switch(n){case 0:return new(r?Int8Array:Uint8Array)(a);case 1:return new(r?Int16Array:Uint16Array)(a);case 2:return new(r?Int32Array:Uint32Array)(a);case 3:return new(r?BigInt64Array:BigUint64Array)(a)}throw Error(`unsupported align: ${n}`)}function b(n,r=0){const c=r,a=y(n),A=F(a),E=typeof c!="number",U=E?c.length:c,O=i(U<<A,a&4?n:1);let G;if(a&4)G=O;else{f(O);const m=i(a&2?16:12,n);l(O);const I=new Uint32Array(e.buffer);I[m+0>>>2]=O,I[m+4>>>2]=O,I[m+8>>>2]=U<<A,a&2&&(I[m+12>>>2]=U),G=m}if(E){const m=h(A,a&2048,a&4096),I=O>>>A;if(a&16384)for(let W=0;W<U;++W)m[I+W]=c[W];else m.set(c,I)}return G}t.__newArray=b;function N(n){const r=new Uint32Array(e.buffer),c=r[n+-8>>>2],a=y(c),A=F(a);let E=a&4?n:r[n+4>>>2];const U=a&2?r[n+12>>>2]:r[E+-4>>>2]>>>A;return h(A,a&2048,a&4096).subarray(E>>>=A,E+U)}t.__getArrayView=N;function T(n){const r=N(n),c=r.length,a=new Array(c);for(let A=0;A<c;A++)a[A]=r[A];return a}t.__getArray=T;function V(n){const r=e.buffer,c=new Uint32Array(r)[n+-4>>>2];return r.slice(n,n+c)}t.__getArrayBuffer=V;function D(n){if(!s)throw Error(X);const r=new Uint32Array(e.buffer)[n>>>2];return s.get(r)}t.__getFunction=D;function C(n,r,c){return new n(M(n,r,c))}function M(n,r,c){const a=e.buffer,A=new Uint32Array(a);return new n(a,A[c+4>>>2],A[c+8>>>2]>>>r)}function P(n,r,c){t[`__get${r}`]=C.bind(null,n,c),t[`__get${r}View`]=M.bind(null,n,c)}return[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array].forEach(n=>{P(n,n.name,31-Math.clz32(n.BYTES_PER_ELEMENT))}),K&&[BigUint64Array,BigInt64Array].forEach(n=>{P(n,n.name.slice(3),3)}),t.memory=t.memory||e,t.table=t.table||s,nt(o,t)}function Z(t){return typeof Response<"u"&&t instanceof Response}function x(t){return t instanceof WebAssembly.Module}async function q(t,u={}){if(Z(t=await t))return tt(t,u);const o=x(t)?t:await WebAssembly.compile(t),e=H(u),s=await WebAssembly.instantiate(o,u),i=$(e,s);return{module:o,instance:s,exports:i}}async function tt(t,u={}){if(!WebAssembly.instantiateStreaming)return q(Z(t=await t)?t.arrayBuffer():t,u);const o=H(u),e=await WebAssembly.instantiateStreaming(t,u),s=$(o,e.instance);return{...e,exports:s}}function nt(t,u={}){const o=t.__argumentsLength?e=>{t.__argumentsLength.value=e}:t.__setArgumentsLength||t.__setargc||(()=>{});for(let e of Object.keys(t)){const s=t[e];let i=e.split("."),f=u;for(;i.length>1;){let _=i.shift();Object.hasOwn(f,_)||(f[_]={}),f=f[_]}let l=i[0],R=l.indexOf("#");if(R>=0){const _=l.substring(0,R),w=f[_];if(typeof w>"u"||!w.prototype){const g=function(...y){return g.wrap(g.prototype.constructor(0,...y))};g.prototype={valueOf(){return this[B]}},g.wrap=function(y){return Object.create(g.prototype,{[B]:{value:y,writable:!1}})},w&&Object.getOwnPropertyNames(w).forEach(y=>Object.defineProperty(g,y,Object.getOwnPropertyDescriptor(w,y))),f[_]=g}if(l=l.substring(R+1),f=f[_].prototype,/^(get|set):/.test(l)){if(!Object.hasOwn(f,l=l.substring(4))){let g=t[e.replace("set:","get:")],y=t[e.replace("get:","set:")];Object.defineProperty(f,l,{get(){return g(this[B])},set(F){y(this[B],F)},enumerable:!0})}}else l==="constructor"?(f[l]=function(...g){return o(g.length),s(...g)}).original=s:(f[l]=function(...g){return o(g.length),s(this[B],...g)}).original=s}else/^(get|set):/.test(l)?Object.hasOwn(f,l=l.substring(4))||Object.defineProperty(f,l,{get:t[e.replace("set:","get:")],set:t[e.replace("get:","set:")],enumerable:!0}):typeof s=="function"&&s!==o?(f[l]=(..._)=>(o(_.length),s(..._))).original=s:f[l]=s}return u}let v=null;async function et(){if(v)return v;const t=await fetch("/imageProcessor.wasm");return v=(await q(t,{env:{abort:(o,e,s,i)=>console.error(`AS Abort at ${s}:${i}`)}})).exports}function k(t){if(!t||!t.startsWith("#"))return{r:0,g:0,b:0};const u=parseInt(t.replace("#",""),16);return{r:u>>16&255,g:u>>8&255,b:u&255}}self.onmessage=async t=>{if(t.data.type!=="process")return;const{imageBitmap:u,parameters:o}=t.data;try{const e=await et(),{width:s,height:i}=u,f=new OffscreenCanvas(s,i),l=f.getContext("2d",{willReadFrequently:!0});l.drawImage(u,0,0);const R=l.getImageData(0,0,s,i).data,_=o.palette.length,w=new Uint8Array(_*3),g=new Uint8Array(_*3);o.palette.forEach((r,c)=>{const a=r.hex?k(r.hex):{r:r.r,g:r.g,b:r.b},A=r.targetHex?k(r.targetHex):a;w.set([a.r,a.g,a.b],c*3),g.set([A.r,A.g,A.b],c*3)});const y=e.allocate(R.length);new Uint8Array(e.memory.buffer).set(R,y);const F=e.allocate(w.length);new Uint8Array(e.memory.buffer).set(w,F);const Y=e.allocate(g.length);new Uint8Array(e.memory.buffer).set(g,Y);const L=e.processLowRes(y,s,i,F,_,o.edgeProtection,o.vertexInertia);e.free(y);let S=1;if(!o.disableScaling)if(o.upscaleFactor==="NS"){const r=Math.max(s,i),c=Math.min(s,i),a=Math.min(535/r,355/c),A=Math.min(568/r,321/c);S=Math.max(a,A)}else S=o.upscaleFactor;const h=Math.round(s*S),b=Math.round(i*S),N=new OffscreenCanvas(h,b),T=N.getContext("2d",{willReadFrequently:!0});T.imageSmoothingEnabled=!0,T.imageSmoothingQuality="high",T.drawImage(f,0,0,h,b);const V=T.getImageData(0,0,h,b).data,D=e.allocate(V.length);new Uint8Array(e.memory.buffer).set(V,D);const C=e.processHighRes(s,i,h,b,D,L,F,Y,_,o.smoothingLevels),M=new Uint8ClampedArray(e.memory.buffer,C,h*b*4),P=new ImageData(new Uint8ClampedArray(M),h,b);[F,Y,L,D,C].forEach(r=>e.free(r)),T.putImageData(P,0,0);const n=await N.convertToBlob({type:"image/png"});self.postMessage({type:"complete",result:n})}catch{}}})();
