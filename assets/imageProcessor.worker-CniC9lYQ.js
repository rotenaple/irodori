(function(){"use strict";const He=(l,o,n)=>{const i=c=>Math.max(0,Math.min(255,Math.round(c))).toString(16).padStart(2,"0");return`#${i(l)}${i(o)}${i(n)}`.toLowerCase()},Ce=l=>{const o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(l);return o?{r:parseInt(o[1],16),g:parseInt(o[2],16),b:parseInt(o[3],16)}:null},qe=(l,o,n)=>{l/=255,o/=255,n/=255;const i=Math.max(l,o,n),c=Math.min(l,o,n);let f=0,b=0,g=(i+c)/2;if(i!==c){const u=i-c;switch(b=g>.5?u/(2-i-c):u/(i+c),i){case l:f=(o-n)/u+(o<n?6:0);break;case o:f=(n-l)/u+2;break;case n:f=(l-o)/u+4;break}f/=6}return{h:f*360,s:b*100,l:g*100}},Ie=(l,o,n)=>{l/=360,o/=100,n/=100;const i=(g,u,I)=>(I<0&&(I+=1),I>1&&(I-=1),I<1/6?g+(u-g)*6*I:I<1/2?u:I<2/3?g+(u-g)*(2/3-I)*6:g);let c,f,b;if(o===0)c=f=b=n;else{const g=n<.5?n*(1+o):n+o-n*o,u=2*n-g;c=i(u,g,l+.3333333333333333),f=i(u,g,l),b=i(u,g,l-.3333333333333333)}return{r:Math.round(c*255),g:Math.round(f*255),b:Math.round(b*255)}},Fe=(l,o)=>{let n=o-l;return n>180&&(n-=360),n<-180&&(n+=360),n},Oe=(l,o)=>{let n=l+o;for(;n<0;)n+=360;for(;n>=360;)n-=360;return n},ke=(l,o,n=1)=>{if(o.length===0)return{r:0,g:0,b:0,hex:"#000000",id:"default"};let i=1/0,c=o[0];const{r:f,g:b,b:g}=l;for(let u=0;u<o.length;u++){const I=o[u];let U=(f-I.r)**2+(b-I.g)**2+(g-I.b)**2;I.id.startsWith("group-")&&(U*=n*n),U<i&&(i=U,c=I)}return c},Ue=(l,o=1)=>{const{width:n,height:i,data:c}=l,f=new ImageData(new Uint8ClampedArray(c),n,i),b=f.data,g=(2*o+1)**2,u=new Uint8Array(g),I=new Uint8Array(g),U=new Uint8Array(g);for(let ft=0;ft<i;ft++)for(let Dt=0;Dt<n;Dt++){let _=0;for(let a=-o;a<=o;a++){const p=ft+a;if(p<0||p>=i)continue;const wt=p*n;for(let Nt=-o;Nt<=o;Nt++){const It=Dt+Nt;if(It<0||It>=n)continue;const kt=(wt+It)*4;u[_]=c[kt],I[_]=c[kt+1],U[_]=c[kt+2],_++}}const Ht=u.subarray(0,_).sort(),_t=I.subarray(0,_).sort(),qt=U.subarray(0,_).sort(),Ft=Math.floor(_/2),Ot=(ft*n+Dt)*4;b[Ot]=Ht[Ft],b[Ot+1]=_t[Ft],b[Ot+2]=qt[Ft],b[Ot+3]=c[Ot+3]}return f};function Yt(l,o,n,i,c){const f=qe(l,o,n);if(f.s<5){const qt=c.lightnessForce/100,Ft=Math.max(0,Math.min(100,f.l+c.lightness*qt));return Ie(f.h,f.s,Ft)}const b=Fe(i,f.h),g=Oe(c.hue,b),u=c.hueForce/100,I=c.saturationForce/100,U=c.lightnessForce/100,ft=u<1?f.h+(g-f.h)*u:g,Dt=c.saturation*I,_=Math.max(0,Math.min(100,f.s+Dt)),Ht=c.lightness*U,_t=Math.max(0,Math.min(100,f.l+Ht));return Ie(ft,_,_t)}async function je(l,o,n,i=.5,c=1){let f=null,b=i,g=i,u=c;const I=.01;for(;u-g>I;){const U=(g+u)/2,ft=await l.convertToBlob({type:o,quality:U});ft.size<=n?(f=ft,b=U,g=U):u=U}return{blob:f,quality:b}}async function ge(l,o){if(!o)return await l.convertToBlob({type:"image/png"});const i=await l.convertToBlob({type:"image/png"});if(i.size<=153600)return i;let c=i,f="png";try{const b=await l.convertToBlob({type:"image/gif"});b.size<=153600&&(c=b,f="gif")}catch{}if(f==="png"){const b=await je(l,"image/jpeg",153600,.5,1);b.blob&&b.blob.size<=153600&&(c=b.blob,f="jpeg")}return c}self.onmessage=async l=>{var Ft,Ot;if(l.data.type!=="process")return;const{imageBitmap:o,parameters:n}=l.data,{upscaleFactor:i,denoiseRadius:c,edgeProtection:f,vertexInertia:b,disablePostProcessing:g,disableRecoloring:u,disableScaling:I,palette:U,smoothingLevels:ft,alphaSmoothness:Dt,preserveTransparency:_,pixelArtConfig:Ht,recolorMode:_t,tintOverrides:qt}=n;try{const a=o.width,p=o.height;if(Ht!=null&&Ht.enabled){const{pixelWidth:t,pixelHeight:s,offsetX:A,offsetY:y}=Ht,R=Math.ceil(a/t),N=Math.ceil(p/s),v=new OffscreenCanvas(a,p).getContext("2d",{willReadFrequently:!0,alpha:!0});if(!v)throw new Error("Could not get source context");v.imageSmoothingEnabled=!1,v.drawImage(o,0,0);const C=v.getImageData(0,0,a,p),S=new OffscreenCanvas(R,N),ht=S.getContext("2d");if(!ht)throw new Error("Could not get pixel context");const tt=ht.createImageData(R,N);for(let w=0;w<N;w++)for(let Z=0;Z<R;Z++){const m=new Map,j=Math.max(0,Math.min(Z*t+A,a-1)),H=Math.max(0,Math.min(w*s+y,p-1)),gt=Math.max(0,Math.min(j+t,a)),Ct=Math.max(0,Math.min(H+s,p));for(let h=H;h<Ct;h++)for(let X=j;X<gt;X++){const J=(h*a+X)*4,O=C.data[J],W=C.data[J+1],x=C.data[J+2],q=C.data[J+3],K=`${O},${W},${x},${q}`,ut=m.get(K);ut?ut.count++:m.set(K,{count:1,r:O,g:W,b:x,a:q})}let Tt=0,L={r:0,g:0,b:0,a:255};for(const h of m.values())h.count>Tt&&(Tt=h.count,L=h);let Q=L;if(!u&&U.length>0){const h={r:L.r,g:L.g,b:L.b},X=ke(h,U);if(_t==="tint"&&qt){const J=qt[X.id];if(J!==void 0){const O=(Ft=n.colorGroups)==null?void 0:Ft.find(q=>q.id===X.id),W=(O==null?void 0:O.baseHue)??0;Q={...Yt(L.r,L.g,L.b,W,J),a:L.a}}}else if(X.targetHex){const J=Ce(X.targetHex);J&&(Q={...J,a:L.a})}else Q={r:X.r,g:X.g,b:X.b,a:L.a}}const d=(w*R+Z)*4;tt.data[d]=Q.r,tt.data[d+1]=Q.g,tt.data[d+2]=Q.b,tt.data[d+3]=_?Q.a:255}ht.putImageData(tt,0,0);let et=1;if(!I){let w,Z;if(i==="NS"){const H=a>=p;w=H?535:321,Z=H?355:568}else{const H=i;w=a*H,Z=p*H}const m=Math.floor(w/R),j=Math.floor(Z/N);et=Math.max(1,Math.min(m,j))}const it=R*et,nt=N*et,ct=new OffscreenCanvas(it,nt),yt=ct.getContext("2d");if(!yt)throw new Error("Could not get final context");yt.imageSmoothingEnabled=!1,yt.drawImage(S,0,0,it,nt);const Jt=await ge(ct,i==="NS");self.postMessage({type:"complete",result:Jt});return}let wt=1;I||(i==="NS"?a>=p?wt=Math.min(535/a,355/p):wt=Math.min(321/a,568/p):wt=i);const Nt=new OffscreenCanvas(a,p),It=Nt.getContext("2d",{willReadFrequently:!0,alpha:!0});if(!It)throw new Error("Could not get native context");if(It.drawImage(o,0,0),!g&&c>0){const t=It.getImageData(0,0,a,p),s=Ue(t,c);It.putImageData(s,0,0)}if(u){const t=Math.round(a*wt),s=Math.round(p*wt),A=new OffscreenCanvas(t,s),y=A.getContext("2d");if(!y)throw new Error("Could not get final context");y.imageSmoothingEnabled=!0,y.imageSmoothingQuality="high",y.drawImage(Nt,0,0,t,s);const R=await ge(A,i==="NS");self.postMessage({type:"complete",result:R});return}const kt=U,St=It.getImageData(0,0,a,p).data;let Ut=new Int16Array(a*p),ue=null;if(_){ue=new Uint8ClampedArray(a*p);for(let t=0;t<St.length;t+=4)ue[t/4]=St[t+3]}const ae=new Map,Se=new Map,D=kt.length,T=new Uint8Array(D),G=new Uint8Array(D),E=new Uint8Array(D),Le=new Array(D);for(let t=0;t<D;t++){const s=kt[t];Se.set(s.id,t),T[t]=s.r,G[t]=s.g,E[t]=s.b,Le[t]=s.id}if(n.colorGroups)for(let t=0;t<n.colorGroups.length;t++){const s=n.colorGroups[t],A=Se.get(s.id);if(A!==void 0)for(let y=0;y<s.members.length;y++)ae.set(s.members[y].hex.toLowerCase(),A)}for(let t=0;t<D;t++){const s=kt[t].hex.toLowerCase();ae.has(s)||ae.set(s,t)}for(let t=0;t<St.length;t+=4){const s=St[t],A=St[t+1],y=St[t+2],R=He(s,A,y);let N=ae.get(R);if(N===void 0){let Y=1/0,v=0;for(let C=0;C<D;C++){const S=s-T[C],ht=A-G[C],tt=y-E[C],et=S*S+ht*ht+tt*tt;et<Y&&(Y=et,v=C)}N=v}Ut[t/4]=N}const te=g?0:f,Ae=g?0:ft;if(te>0){let t=Math.max(1,Math.round(te/100*3)),s=Math.max(1,Math.round(te/100*4));te>66&&(t=3,s=3),te>85&&(t=5,s=5);const A=new Int16Array(Ut.length),y=new Uint32Array(D);for(let R=0;R<s;R++){for(let N=0;N<p;N++){const Y=Math.max(0,N-t),v=Math.min(p-1,N+t),C=N*a;for(let S=0;S<a;S++){const ht=Math.max(0,S-t),tt=Math.min(a-1,S+t),et=C+S,it=Ut[et],nt=et*4,ct=St[nt],yt=St[nt+1],Jt=St[nt+2];y.fill(0);for(let x=Y;x<=v;x++){const q=x*a;for(let K=ht;K<=tt;K++){const ut=Ut[q+K];y[ut]++}}let w=0,Z=0,m=0,j=0,H=0,gt=0;for(let x=0;x<D;x++){const q=y[x];q>Z?(H=m,gt=j,m=w,j=Z,w=x,Z=q):q>j?(H=m,gt=j,m=x,j=q):q>gt&&(H=x,gt=q)}if(w!==m&&m!==H){const x=T[w],q=G[w],K=E[w],ut=T[m],Kt=G[m],Wt=E[m],Pt=T[H],e=G[H],r=E[H],M=Math.sqrt((x-Pt)**2+(q-e)**2+(K-r)**2),B=Math.sqrt((x-ut)**2+(q-Kt)**2+(K-Wt)**2),$=Math.sqrt((Pt-ut)**2+(e-Kt)**2+(r-Wt)**2);B+$<M*1.1&&(m=H,j=gt)}const Ct=(v-Y+1)*(tt-ht+1);if(j<Ct*.1&&(m=w),it!==w&&it!==m){const x=T[it],q=G[it],K=E[it],ut=T[w],Kt=G[w],Wt=E[w],Pt=T[m],e=G[m],r=E[m],M=(x-ut)**2+(q-Kt)**2+(K-Wt)**2,B=(x-Pt)**2+(q-e)**2+(K-r)**2;A[et]=M<B?w:m;continue}const Tt=T[w],L=G[w],Q=E[w],d=T[m],h=G[m],X=E[m];let J=(ct-Tt)**2+(yt-L)**2+(Jt-Q)**2,O=(ct-d)**2+(yt-h)**2+(Jt-X)**2;const W=1-b/100*.8;it===w&&(J*=W),it===m&&(O*=W),A[et]=J<O?w:m}}Ut.set(A)}}const pe=wt*4,We=Math.round(a*pe),Pe=Math.round(p*pe),ve=1e7,Be=We*Pe>ve?Math.sqrt(ve/(a*p)):pe,At=Math.round(a*Be),Xt=Math.round(p*Be),Re=new OffscreenCanvas(At,Xt),Zt=Re.getContext("2d",{willReadFrequently:!0,alpha:!0});if(!Zt)throw new Error("Could not get workspace context");Zt.imageSmoothingEnabled=!0,Zt.imageSmoothingQuality="high",Zt.drawImage(Nt,0,0,At,Xt);const jt=Zt.getImageData(0,0,At,Xt).data,ee=new Uint8ClampedArray(jt.length),Ne=At/a,Xe=Xt/p,vt=new Uint8Array(D),Bt=new Uint8Array(D),Rt=new Uint8Array(D),Qt=new Float32Array(D),dt=new Array(D).fill(null),$t=new Uint8Array(D),ne=_t==="tint"&&qt;for(let t=0;t<D;t++){const s=kt[t];if(ne){const A=qt[s.id];if(A!==void 0){const y=(Ot=n.colorGroups)==null?void 0:Ot.find(R=>R.id===s.id);Qt[t]=(y==null?void 0:y.baseHue)??0,dt[t]=A,$t[t]=1}else $t[t]=0;vt[t]=T[t],Bt[t]=G[t],Rt[t]=E[t]}else if(s.targetHex){const A=Ce(s.targetHex);A?(vt[t]=A.r,Bt[t]=A.g,Rt[t]=A.b):(vt[t]=T[t],Bt[t]=G[t],Rt[t]=E[t])}else vt[t]=T[t],Bt[t]=G[t],Rt[t]=E[t]}const Lt=new Float32Array(D),xe=new Uint8Array(D),me=new Float32Array(D);for(let t=0;t<Xt;t++){const s=Math.min(p-1,Math.floor(t/Xe)),A=s*a;for(let y=0;y<At;y++){const R=Math.min(a-1,Math.floor(y/Ne)),Y=(t*At+y)*4,v=jt[Y],C=jt[Y+1],S=jt[Y+2],ht=Math.max(0,s-2),tt=Math.min(p-1,s+2),et=Math.max(0,R-2),it=Math.min(a-1,R+2);Lt.fill(0);for(let e=ht;e<=tt;e++){const r=Math.abs(e-s),M=e*a;for(let B=et;B<=it;B++){const $=Math.abs(B-R),V=Ut[M+B];let P=1;($>0||r>0)&&(P=.5),($>1||r>1)&&(P=.2),Lt[V]+=P}}const nt=[];for(let e=0;e<D;e++)Lt[e]>0&&nt.push(e);const ct=[],yt=nt.length;t:for(let e=0;e<yt;e++){const r=nt[e],M=T[r],B=G[r],$=E[r],V=Lt[r];for(let P=0;P<yt;P++){const z=nt[P];if(z!==r)for(let ot=0;ot<yt;ot++){const st=nt[ot];if(st===r||z===st)continue;const Gt=T[z],pt=G[z],zt=E[z],F=T[st],k=G[st],Et=E[st],ce=Lt[z],oe=Lt[st],se=Math.sqrt((Gt-F)**2+(pt-k)**2+(zt-Et)**2),Me=Math.sqrt((Gt-M)**2+(pt-B)**2+(zt-$)**2),Te=Math.sqrt((F-M)**2+(k-B)**2+(Et-$)**2);if(Me+Te<se*1.1&&se>10&&ce>V&&oe>V)continue t}}ct.push(r)}xe.fill(0);const Jt=Math.max(0,s-1),w=Math.min(p-1,s+1),Z=Math.max(0,R-1),m=Math.min(a-1,R+1);for(let e=Jt;e<=w;e++){const r=e*a;for(let M=Z;M<=m;M++)xe[Ut[r+M]]=1}const j=ct.length;let H=-1/0,gt=0;for(let e=0;e<j;e++){const r=ct[e],M=T[r],B=G[r],$=E[r],V=Lt[r],P=v-M,z=C-B,ot=S-$,st=P*P+z*z+ot*ot,Gt=xe[r]?0:-1e3,pt=V*10+Gt-Math.sqrt(st);me[e]=pt,pt>H&&(H=pt,gt=e)}let Ct=j>0?ct[gt]:nt[0],Tt=Ct,L=-1/0;for(let e=0;e<j;e++)e!==gt&&me[e]>L&&(L=me[e],Tt=ct[e]);L<=-500&&(Tt=Ct);const Q=Ut[A+R];let d=Q,h=Ct,X=!1;for(let e=0;e<j;e++)if(ct[e]===Q){X=!0;break}X?(d=Q,h=Q===Ct?Tt:Ct):(d=Ct,h=Tt),Lt[h]<.3&&(h=d);let O,W,x;const q=(e,r,M,B)=>ne?$t[e]&&dt[e]?Yt(r,M,B,Qt[e],dt[e]):{r,g:M,b:B}:{r:vt[e],g:Bt[e],b:Rt[e]};if(d===h)if(ne)if($t[d]&&dt[d]){const e=Yt(v,C,S,Qt[d],dt[d]);O=e.r,W=e.g,x=e.b}else O=v,W=C,x=S;else O=vt[d],W=Bt[d],x=Rt[d];else if(Ae===0){const e=T[d],r=G[d],M=E[d],B=T[h],$=G[h],V=E[h],P=v-e,z=C-r,ot=S-M,st=v-B,Gt=C-$,pt=S-V,zt=P*P+z*z+ot*ot,F=st*st+Gt*Gt+pt*pt,k=zt<F?d:h;if(ne)if($t[k]&&dt[k]){const Et=Yt(v,C,S,Qt[k],dt[k]);O=Et.r,W=Et.g,x=Et.b}else O=v,W=C,x=S;else O=vt[k],W=Bt[k],x=Rt[k]}else{const e=T[d],r=G[d],M=E[d],B=T[h],$=G[h],V=E[h],P=B-e,z=$-r,ot=V-M,st=v-e,Gt=C-r,pt=S-M,zt=P*P+z*z+ot*ot;let F=0;zt>0&&(F=Math.max(0,Math.min(1,(st*P+Gt*z+pt*ot)/zt)));const k=Ae/100;let Et=!1;if(F>0&&F<1){const at=.4*(1-k*.5);if(F<at||F>1-at){const rt=(e+B)/2,mt=(r+$)/2,Mt=(M+V)/2,bt=e-rt,lt=r-mt,le=M-Mt,be=bt*bt+lt*lt+le*le;let we=!1;const fe=k>.7?3:2;for(let de=-fe;de<=fe;de+=1){for(let he=-fe;he<=fe;he+=1){if(he===0&&de===0)continue;const ze=Math.max(0,Math.min(Xt-1,t+de)),Ye=Math.max(0,Math.min(At-1,y+he)),ye=(ze*At+Ye)*4,_e=jt[ye],Ze=jt[ye+1],Qe=jt[ye+2],Ge=_e-rt,Ee=Ze-mt,De=Qe-Mt,Je=Ge*Ge+Ee*Ee+De*De,Ke=.6+k*.2;if(Je<be*Ke){we=!0;break}}if(we)break}we||(Et=!0)}}if(Et&&(F=F<.5?0:1),F>0&&F<.25){const at=v-e,xt=C-r,rt=S-M,mt=e-B,Mt=r-$,bt=M-V,lt=at*at+xt*xt+rt*rt,le=mt*mt+Mt*Mt+bt*bt,be=.05*(1-k);lt<le*be&&(F=0)}const ce=.15*(1-k);F<ce&&(F=0),F>1-ce&&(F=1);const oe=28*(1-k)+8*k,se=1/(1+Math.exp(-oe*-.5)),Me=1/(1+Math.exp(-oe*.5)),Vt=(1/(1+Math.exp(-oe*(F-.5)))-se)/(Me-se);if(ne){let at,xt,rt,mt,Mt,bt;if($t[d]&&dt[d]){const lt=Yt(v,C,S,Qt[d],dt[d]);at=lt.r,xt=lt.g,rt=lt.b}else at=v,xt=C,rt=S;if($t[h]&&dt[h]){const lt=Yt(v,C,S,Qt[h],dt[h]);mt=lt.r,Mt=lt.g,bt=lt.b}else mt=v,Mt=C,bt=S;O=Math.round(at+Vt*(mt-at)),W=Math.round(xt+Vt*(Mt-xt)),x=Math.round(rt+Vt*(bt-rt))}else{const at=vt[d],xt=Bt[d],rt=Rt[d],mt=vt[h],Mt=Bt[h],bt=Rt[h];O=Math.round(at+Vt*(mt-at)),W=Math.round(xt+Vt*(Mt-xt)),x=Math.round(rt+Vt*(bt-rt))}}const K=s*a+R,ut=ue[K],Kt=jt[Y+3];let Wt;const Pt=(Dt||0)/100;if(Pt===0)Wt=ut;else{const e=Kt/255,r=20*(1-Pt)+2*Pt,M=1/(1+Math.exp(-r*-.5)),B=1/(1+Math.exp(-r*.5)),V=(1/(1+Math.exp(-r*(e-.5)))-M)/(B-M);Wt=Math.round(V*255)}ee[Y]=O,ee[Y+1]=W,ee[Y+2]=x,ee[Y+3]=_?Wt:255}}Zt.putImageData(new ImageData(ee,At,Xt),0,0);const re=new OffscreenCanvas(Math.round(a*wt),Math.round(p*wt)),ie=re.getContext("2d",{alpha:!0});if(!ie)throw new Error("Could not get final context");ie.imageSmoothingEnabled=!0,ie.imageSmoothingQuality="high",ie.drawImage(Re,0,0,re.width,re.height);const $e=await ge(re,i==="NS");self.postMessage({type:"complete",result:$e})}catch(a){self.postMessage({type:"complete",error:a.message})}}})();
