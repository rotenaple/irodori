(function(){"use strict";const St=m=>{const r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(m);return r?{r:parseInt(r[1],16),g:parseInt(r[2],16),b:parseInt(r[3],16)}:null},ee=(m,r,o)=>{m/=255,r/=255,o/=255;const x=Math.max(m,r,o),d=Math.min(m,r,o);let E=0,p=0,g=(x+d)/2;if(x!==d){const u=x-d;switch(p=g>.5?u/(2-x-d):u/(x+d),x){case m:E=(r-o)/u+(r<o?6:0);break;case r:E=(o-m)/u+2;break;case o:E=(m-r)/u+4;break}E/=6}return{h:E*360,s:p*100,l:g*100}},Lt=(m,r,o)=>{m/=360,r/=100,o/=100;const x=(g,u,D)=>(D<0&&(D+=1),D>1&&(D-=1),D<1/6?g+(u-g)*6*D:D<1/2?u:D<2/3?g+(u-g)*(2/3-D)*6:g);let d,E,p;if(r===0)d=E=p=o;else{const g=o<.5?o*(1+r):o+r-o*r,u=2*o-g;d=x(u,g,m+.3333333333333333),E=x(u,g,m),p=x(u,g,m-.3333333333333333)}return{r:Math.round(d*255),g:Math.round(E*255),b:Math.round(p*255)}},ne=(m,r)=>{let o=r-m;return o>180&&(o-=360),o<-180&&(o+=360),o},oe=(m,r)=>{let o=m+r;for(;o<0;)o+=360;for(;o>=360;)o-=360;return o},se=(m,r=1)=>{const{width:o,height:x,data:d}=m,E=new ImageData(new Uint8ClampedArray(d),o,x),p=E.data,g=(2*r+1)**2,u=new Uint8Array(g),D=new Uint8Array(g),vt=new Uint8Array(g);for(let Y=0;Y<x;Y++)for(let wt=0;wt<o;wt++){let et=0;for(let Mt=-r;Mt<=r;Mt++){const i=Y+Mt;if(i<0||i>=x)continue;const A=i*o;for(let _=-r;_<=r;_++){const ct=wt+_;if(ct<0||ct>=o)continue;const lt=(A+ct)*4;u[et]=d[lt],D[et]=d[lt+1],vt[et]=d[lt+2],et++}}const kt=u.subarray(0,et).sort(),Tt=D.subarray(0,et).sort(),Z=vt.subarray(0,et).sort(),nt=Math.floor(et/2),it=(Y*o+wt)*4;p[it]=kt[nt],p[it+1]=Tt[nt],p[it+2]=Z[nt],p[it+3]=d[it+3]}return E},xt=(m,r,o)=>m<<16|r<<8|o;function Xt(m,r,o,x,d){const E=ee(m,r,o);let{h:p,s:g,l:u}=E;if(g<5)return Lt(p,g,Math.max(0,Math.min(100,u+d.lightness*(d.lightnessForce/100))));const D=oe(d.hue,ne(x,p));return p=d.hueForce<100?p+(D-p)*(d.hueForce/100):D,g=Math.max(0,Math.min(100,g+d.saturation*(d.saturationForce/100))),u=Math.max(0,Math.min(100,u+d.lightness*(d.lightnessForce/100))),Lt(p,g,u)}async function qt(m,r){const x=await m.convertToBlob({type:"image/png"});if(!r||x.size<=153600)return x;try{const g=await m.convertToBlob({type:"image/gif"});if(g.size<=153600)return g}catch{}let d=.5,E=1,p=x;for(let g=0;g<6;g++){const u=(d+E)/2,D=await m.convertToBlob({type:"image/jpeg",quality:u});D.size<=153600?(p=D,d=u):E=u}return p}self.onmessage=async m=>{var it,Mt;if(m.data.type!=="process")return;const r=performance.now(),{imageBitmap:o,parameters:x}=m.data,{upscaleFactor:d,denoiseRadius:E,edgeProtection:p,vertexInertia:g,disablePostProcessing:u,disableRecoloring:D,disableScaling:vt,palette:Y,smoothingLevels:wt,alphaSmoothness:et,preserveTransparency:kt,recolorMode:Tt,tintOverrides:Z,pixelArtConfig:nt}=x;try{const i=o.width,A=o.height;let _=1;vt||(_=d==="NS"?i>=A?Math.min(535/i,355/A):Math.min(321/i,568/A):d);const ct=new OffscreenCanvas(i,A),lt=ct.getContext("2d",{willReadFrequently:!0,alpha:!0});if(lt.drawImage(o,0,0),nt&&nt.enabled){const t=Math.max(1,nt.pixelWidth),s=Math.max(1,nt.pixelHeight),v=nt.offsetX||0,M=nt.offsetY||0,B=i-v,c=A-M,I=Math.floor(B/t),P=Math.floor(c/s);if(I<=0||P<=0){self.postMessage({type:"complete",error:"Pixel Art settings resulted in invalid image size."});return}const L=new OffscreenCanvas(I,P),O=L.getContext("2d",{willReadFrequently:!0,alpha:!0});O.imageSmoothingEnabled=!1;const gt=I*t,$=P*s;if(O.drawImage(ct,v,M,gt,$,0,0,I,P),!D){const rt=O.getImageData(0,0,I,P),l=rt.data,k=Y.length,z=new Uint8Array(k),tt=new Uint8Array(k),ft=new Uint8Array(k),y=new Uint8Array(k),T=new Uint8Array(k),n=new Uint8Array(k),e=new Map,f=new Map,w=Tt==="tint"&&Z;for(let a=0;a<k;a++){const h=Y[a];z[a]=h.r,tt[a]=h.g,ft[a]=h.b,f.set(h.id,a),e.set(xt(h.r,h.g,h.b),a);let U=h.r,b=h.g,F=h.b;if(h.targetHex){const H=St(h.targetHex);H&&(U=H.r,b=H.g,F=H.b)}else if(w&&(Z==null?void 0:Z[h.id])!==void 0){const H=(it=x.colorGroups)==null?void 0:it.find(X=>X.id===h.id),Q=Xt(h.r,h.g,h.b,(H==null?void 0:H.baseHue)??0,Z[h.id]);U=Q.r,b=Q.g,F=Q.b}y[a]=U,T[a]=b,n[a]=F}if(x.colorGroups)for(const a of x.colorGroups){const h=f.get(a.id);if(h!==void 0)for(const U of a.members){const b=St(U.hex);b&&e.set(xt(b.r,b.g,b.b),h)}}for(let a=0;a<l.length;a+=4){if(l[a+3]===0)continue;const h=l[a],U=l[a+1],b=l[a+2],F=xt(h,U,b);let H=e.get(F);if(H===void 0){let Q=1/0;for(let X=0;X<k;X++){const Bt=(h-z[X])**2+(U-tt[X])**2+(b-ft[X])**2;Bt<Q&&(Q=Bt,H=X)}e.set(F,H)}H!==void 0&&(l[a]=y[H],l[a+1]=T[H],l[a+2]=n[H])}O.putImageData(rt,0,0)}const G=i*_,W=A*_,J=Math.max(1,Math.floor(Math.min(G/I,W/P))),mt=I*J,pt=P*J,ut=new OffscreenCanvas(mt,pt),q=ut.getContext("2d");q.imageSmoothingEnabled=!1,q.drawImage(L,0,0,mt,pt),self.postMessage({type:"complete",result:await qt(ut,!1)});return}if(!u&&E>0){const t=performance.now();lt.putImageData(se(lt.getImageData(0,0,i,A),E),0,0),console.log(`[WORKER] Denoise: ${Math.round(performance.now()-t)}ms`)}if(D){const t=Math.round(i*_),s=Math.round(A*_),v=new OffscreenCanvas(t,s);v.getContext("2d").drawImage(ct,0,0,t,s),self.postMessage({type:"complete",result:await qt(v,d==="NS")});return}const ae=performance.now(),V=lt.getImageData(0,0,i,A).data,K=new Int16Array(i*A),j=Y.length,C=new Uint8Array(j),R=new Uint8Array(j),S=new Uint8Array(j),Ut=new Map,Yt=new Map;for(let t=0;t<j;t++)C[t]=Y[t].r,R[t]=Y[t].g,S[t]=Y[t].b,Yt.set(Y[t].id,t),Ut.set(xt(C[t],R[t],S[t]),t);if(x.colorGroups)for(const t of x.colorGroups){const s=Yt.get(t.id);if(s!==void 0)for(const v of t.members){const M=St(v.hex);M&&Ut.set(xt(M.r,M.g,M.b),s)}}let yt=null;kt&&(yt=new Uint8ClampedArray(i*A));for(let t=0;t<V.length;t+=4){const s=V[t],v=V[t+1],M=V[t+2],B=xt(s,v,M);let c=Ut.get(B);if(c===void 0){let P=1/0;for(let L=0;L<j;L++){const O=(s-C[L])**2+(v-R[L])**2+(M-S[L])**2;O<P&&(P=O,c=L)}Ut.set(B,c)}const I=t>>2;K[I]=c,yt&&(yt[I]=V[t+3])}if(console.log(`[WORKER] Phase 1: ${Math.round(performance.now()-ae)}ms`),p>0&&!u){const t=performance.now(),s=new Int16Array(K.length),v=new Uint8Array(K.length),M=new Uint32Array(j),B=new Uint16Array(j),c=1-g/100*.8,I=p>85?5:p>66?3:Math.max(1,Math.round(p/100*3)),P=p>85?5:p>66?3:Math.max(1,Math.round(p/100*4));for(let L=0;L<P;L++){for(let O=1;O<A-1;O++){const gt=O*i;for(let $=1;$<i-1;$++){const G=gt+$,W=K[G];W!==K[G-1]||W!==K[G+1]||W!==K[G-i]||W!==K[G+i]?v[G]=1:(v[G]=0,s[G]=W)}}for(let O=0;O<A;O++){const gt=O*i,$=Math.max(0,O-I),G=Math.min(A-1,O+I);for(let W=0;W<i;W++){const J=gt+W;if(v[J]===0)continue;const mt=Math.max(0,W-I),pt=Math.min(i-1,W+I);let ut=0;for(let e=$;e<=G;e++){const f=e*i;for(let w=mt;w<=pt;w++){const a=K[f+w];M[a]===0&&(B[ut++]=a),M[a]++}}let q=0,rt=0,l=0,k=0,z=0,tt=0;for(let e=0;e<ut;e++){const f=B[e],w=M[f];w>rt?(z=l,tt=k,l=q,k=rt,q=f,rt=w):w>k?(z=l,tt=k,l=f,k=w):w>tt&&(z=f,tt=w),M[f]=0}if(q!==l&&l!==z){const e=(C[q]-C[z])**2+(R[q]-R[z])**2+(S[q]-S[z])**2,f=(C[q]-C[l])**2+(R[q]-R[l])**2+(S[q]-S[l])**2,w=(C[z]-C[l])**2+(R[z]-R[l])**2+(S[z]-S[l])**2;f+w+2*Math.sqrt(f*w)<e*1.21&&(l=z,k=tt)}k<(G-$+1)*(pt-mt+1)*.1&&(l=q);const ft=K[J],y=J<<2;let T=(V[y]-C[q])**2+(V[y+1]-R[q])**2+(V[y+2]-S[q])**2,n=(V[y]-C[l])**2+(V[y+1]-R[l])**2+(V[y+2]-S[l])**2;ft===q?T*=c:ft===l&&(n*=c),s[J]=T<n?q:l}}K.set(s)}console.log(`[WORKER] Phase 2: ${Math.round(performance.now()-t)}ms`)}const re=performance.now(),Ft=_*4,Zt=i*Ft*A*Ft>1e7?Math.sqrt(1e7/(i*A)):Ft,at=Math.round(i*Zt),dt=Math.round(A*Zt),_t=new OffscreenCanvas(at,dt),Ot=_t.getContext("2d",{willReadFrequently:!0});Ot.drawImage(ct,0,0,at,dt);const ot=Ot.getImageData(0,0,at,dt).data,N=new Uint8ClampedArray(ot.length),bt=new Uint8Array(j),It=new Uint8Array(j),At=new Uint8Array(j),ie=Tt==="tint"&&Z;for(let t=0;t<j;t++){const s=Y[t];let v=s.r,M=s.g,B=s.b;if(s.targetHex){const c=St(s.targetHex);c&&(v=c.r,M=c.g,B=c.b)}else if(ie&&(Z==null?void 0:Z[s.id])!==void 0){const c=(Mt=x.colorGroups)==null?void 0:Mt.find(P=>P.id===s.id),I=Xt(v,M,B,(c==null?void 0:c.baseHue)??0,Z[s.id]);v=I.r,M=I.g,B=I.b}bt[t]=v,It[t]=M,At[t]=B}const ht=(u?0:wt)/100,zt=28*(1-ht)+8*ht,Nt=.15*(1-ht),Jt=new Float32Array(1025),Qt=1/(1+Math.exp(-zt*-.5)),ce=1/(1+Math.exp(-zt*.5));for(let t=0;t<=1024;t++){let s=t/1024;s<Nt?s=0:s>1-Nt&&(s=1),Jt[t]=(1/(1+Math.exp(-zt*(s-.5)))-Qt)/(ce-Qt)}const Pt=(et||0)/100,jt=new Float32Array(256),$t=20*(1-Pt)+2*Pt,Vt=1/(1+Math.exp(-$t*-.5)),le=1/(1+Math.exp(-$t*.5));for(let t=0;t<256;t++){const s=t/255;jt[t]=(1/(1+Math.exp(-$t*(s-.5)))-Vt)/(le-Vt)}const st=new Float32Array(j),Ht=new Uint8Array(j),Ct=new Uint16Array(j),Rt=new Uint16Array(j),fe=at/i,de=dt/A;for(let t=0;t<dt;t++){const s=Math.min(A-1,t/de|0),v=s*i;for(let M=0;M<at;M++){const B=Math.min(i-1,M/fe|0),c=t*at+M<<2;st.fill(0);let I=0;const P=Math.max(0,s-2),L=Math.min(A-1,s+2),O=Math.max(0,B-2),gt=Math.min(i-1,B+2);for(let n=P;n<=L;n++){const e=Math.abs(n-s),f=n*i;for(let w=O;w<=gt;w++){const a=K[f+w];st[a]===0&&(Ct[I++]=a),st[a]+=Math.abs(w-B)>1||e>1?.2:Math.abs(w-B)>0||e>0?.5:1}}if(I===1){const n=Ct[0];N[c]=bt[n],N[c+1]=It[n],N[c+2]=At[n],N[c+3]=yt?Pt===0?yt[v+B]:jt[ot[c+3]]*255|0:255;continue}const $=ot[c],G=ot[c+1],W=ot[c+2];let J=0;t:for(let n=0;n<I;n++){const e=Ct[n],f=C[e],w=R[e],a=S[e];for(let h=0;h<I;h++){const U=Ct[h];if(U!==e)for(let b=0;b<I;b++){const F=Ct[b];if(F===e||U===F)continue;const H=(C[U]-C[F])**2+(R[U]-R[F])**2+(S[U]-S[F])**2,Q=(C[U]-f)**2+(R[U]-w)**2+(S[U]-a)**2,X=(C[F]-f)**2+(R[F]-w)**2+(S[F]-a)**2;if(Q+X+2*Math.sqrt(Q*X)<H*1.21&&H>100&&st[U]>st[e]&&st[F]>st[e])continue t}}Rt[J++]=e}Ht.fill(0);const mt=Math.max(0,s-1),pt=Math.min(A-1,s+1),ut=Math.max(0,B-1),q=Math.min(i-1,B+1);for(let n=mt;n<=pt;n++){const e=n*i;for(let f=ut;f<=q;f++)Ht[K[e+f]]=1}let rt=-1/0,l=Rt[0];for(let n=0;n<J;n++){const e=Rt[n],f=st[e]*10+(Ht[e]?0:-1e3)-(($-C[e])**2+(G-R[e])**2+(W-S[e])**2);f>rt&&(rt=f,l=e)}let k=l,z=-1/0;for(let n=0;n<J;n++){const e=Rt[n];if(e===l)continue;const f=st[e]*10+(Ht[e]?0:-1e3)-(($-C[e])**2+(G-R[e])**2+(W-S[e])**2);f>z&&(z=f,k=e)}z<=-500&&(k=l);const tt=K[v+B];let ft=!1;for(let n=0;n<J;n++)if(Rt[n]===tt){ft=!0;break}let y=ft?tt:l,T=y===l?k:l;if(st[T]<.3&&(T=y),y===T||ht===0){const n=($-C[y])**2+(G-R[y])**2+(W-S[y])**2<($-C[T])**2+(G-R[T])**2+(W-S[T])**2?y:T;N[c]=bt[n],N[c+1]=It[n],N[c+2]=At[n]}else{const n=C[y],e=R[y],f=S[y],w=C[T]-n,a=R[T]-e,h=S[T]-f,U=w*w+a*a+h*h;let b=U>0?Math.max(0,Math.min(1,(($-n)*w+(G-e)*a+(W-f)*h)/U)):0;if(b>0&&b<1&&(b<.4||b>.6)){const H=(n+C[T])/2,Q=(e+R[T])/2,X=(f+S[T])/2,Bt=(n-H)**2+(e-Q)**2+(f-X)**2;let te=!1,Et=ht>.7?3:2;t:for(let Gt=-Et;Gt<=Et;Gt++)for(let Wt=-Et;Wt<=Et;Wt++){if(Wt===0&&Gt===0)continue;const he=Math.max(0,Math.min(dt-1,t+Gt)),ge=Math.max(0,Math.min(at-1,M+Wt)),Kt=he*at+ge<<2;if((ot[Kt]-H)**2+(ot[Kt+1]-Q)**2+(ot[Kt+2]-X)**2<Bt*(.6+ht*.2)){te=!0;break t}}te||(b=b<.5?0:1)}b>0&&b<.25&&($-n)**2+(G-e)**2+(W-f)**2<U*(.05*(1-ht))&&(b=0);const F=Jt[b*1024|0];N[c]=bt[y]+F*(bt[T]-bt[y])|0,N[c+1]=It[y]+F*(It[T]-It[y])|0,N[c+2]=At[y]+F*(At[T]-At[y])|0}N[c+3]=yt&&ot[c+3]<255?jt[ot[c+3]]*255|0:255}}console.log(`[WORKER] Phase 3: ${Math.round(performance.now()-re)}ms`),Ot.putImageData(new ImageData(N,at,dt),0,0);const Dt=new OffscreenCanvas(Math.round(i*_),Math.round(A*_));Dt.getContext("2d").drawImage(_t,0,0,Dt.width,Dt.height),console.log(`[WORKER] Total: ${Math.round(performance.now()-r)}ms`),self.postMessage({type:"complete",result:await qt(Dt,d==="NS")})}catch(i){self.postMessage({type:"complete",error:i.message})}}})();
