(function(){"use strict";const Be=(a,o,n)=>{const c=r=>Math.max(0,Math.min(255,Math.round(r))).toString(16).padStart(2,"0");return`#${c(a)}${c(o)}${c(n)}`.toLowerCase()},he=a=>{const o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);return o?{r:parseInt(o[1],16),g:parseInt(o[2],16),b:parseInt(o[3],16)}:null},Re=(a,o,n)=>{a/=255,o/=255,n/=255;const c=Math.max(a,o,n),r=Math.min(a,o,n);let f=0,g=0,d=(c+r)/2;if(c!==r){const u=c-r;switch(g=d>.5?u/(2-c-r):u/(c+r),c){case a:f=(o-n)/u+(o<n?6:0);break;case o:f=(n-a)/u+2;break;case n:f=(a-o)/u+4;break}f/=6}return{h:f*360,s:g*100,l:d*100}},ge=(a,o,n)=>{a/=360,o/=100,n/=100;const c=(d,u,w)=>(w<0&&(w+=1),w>1&&(w-=1),w<1/6?d+(u-d)*6*w:w<1/2?u:w<2/3?d+(u-d)*(2/3-w)*6:d);let r,f,g;if(o===0)r=f=g=n;else{const d=n<.5?n*(1+o):n+o-n*o,u=2*n-d;r=c(u,d,a+.3333333333333333),f=c(u,d,a),g=c(u,d,a-.3333333333333333)}return{r:Math.round(r*255),g:Math.round(f*255),b:Math.round(g*255)}},Te=(a,o)=>{let n=o-a;return n>180&&(n-=360),n<-180&&(n+=360),n},Ge=(a,o)=>{let n=a+o;for(;n<0;)n+=360;for(;n>=360;)n-=360;return n},Ee=(a,o,n=1)=>{if(o.length===0)return{r:0,g:0,b:0,hex:"#000000",id:"default"};let c=1/0,r=o[0];const{r:f,g,b:d}=a;for(let u=0;u<o.length;u++){const w=o[u];let U=(f-w.r)**2+(g-w.g)**2+(d-w.b)**2;w.id.startsWith("group-")&&(U*=n*n),U<c&&(c=U,r=w)}return r},De=(a,o=1)=>{const{width:n,height:c,data:r}=a,f=new ImageData(new Uint8ClampedArray(r),n,c),g=f.data,d=(2*o+1)**2,u=new Uint8Array(d),w=new Uint8Array(d),U=new Uint8Array(d);for(let ct=0;ct<c;ct++)for(let yt=0;yt<n;yt++){let _=0;for(let i=-o;i<=o;i++){const h=ct+i;if(h<0||h>=c)continue;const ft=h*n;for(let Tt=-o;Tt<=o;Tt++){const gt=yt+Tt;if(gt<0||gt>=n)continue;const vt=(ft+gt)*4;u[_]=r[vt],w[_]=r[vt+1],U[_]=r[vt+2],_++}}const Ct=u.subarray(0,_).sort(),Dt=w.subarray(0,_).sort(),It=U.subarray(0,_).sort(),Ht=Math.floor(_/2),St=(ct*n+yt)*4;g[St]=Ct[Ht],g[St+1]=Dt[Ht],g[St+2]=It[Ht],g[St+3]=r[St+3]}return f};function He(a,o,n,c,r){if(o<5){const Dt=r.lightnessForce/100,It=Math.max(0,Math.min(100,n+r.lightness*Dt));return ge(a,o,It)}const f=Te(c,a),g=Ge(r.hue,f),d=r.hueForce/100,u=r.saturationForce/100,w=r.lightnessForce/100,U=d<1?a+(g-a)*d:g,ct=r.saturation*u,yt=Math.max(0,Math.min(100,o+ct)),_=r.lightness*w,Ct=Math.max(0,Math.min(100,n+_));return ge(U,yt,Ct)}function ue(a,o,n,c,r){const f=Re(a,o,n);return He(f.h,f.s,f.l,c,r)}async function qe(a,o,n,c=.5,r=1){let f=null,g=c,d=c,u=r;const w=.01;for(;u-d>w;){const U=(d+u)/2,ct=await a.convertToBlob({type:o,quality:U});ct.size<=n?(f=ct,g=U,d=U):u=U}return{blob:f,quality:g}}async function ne(a,o){if(!o)return await a.convertToBlob({type:"image/png"});const c=await a.convertToBlob({type:"image/png"});if(c.size<=153600)return c;let r=c,f="png";try{const g=await a.convertToBlob({type:"image/gif"});g.size<=153600&&(r=g,f="gif")}catch{}if(f==="png"){const g=await qe(a,"image/jpeg",153600,.5,1);g.blob&&g.blob.size<=153600&&(r=g.blob,f="jpeg")}return r}self.onmessage=async a=>{var Ht,St;if(a.data.type!=="process")return;const{imageBitmap:o,parameters:n}=a.data,{upscaleFactor:c,denoiseRadius:r,edgeProtection:f,vertexInertia:g,disablePostProcessing:d,disableRecoloring:u,disableScaling:w,palette:U,smoothingLevels:ct,alphaSmoothness:yt,preserveTransparency:_,pixelArtConfig:Ct,recolorMode:Dt,tintOverrides:It}=n;try{const i=o.width,h=o.height;if(Ct!=null&&Ct.enabled){const{pixelWidth:t,pixelHeight:s,offsetX:I,offsetY:m}=Ct,A=Math.ceil(i/t),H=Math.ceil(h/s),z=new OffscreenCanvas(i,h).getContext("2d",{willReadFrequently:!0,alpha:!0});if(!z)throw new Error("Could not get source context");z.imageSmoothingEnabled=!1,z.drawImage(o,0,0);const k=z.getImageData(0,0,i,h),P=new OffscreenCanvas(A,H),rt=P.getContext("2d");if(!rt)throw new Error("Could not get pixel context");const tt=rt.createImageData(A,H);for(let x=0;x<H;x++)for(let Z=0;Z<A;Z++){const p=new Map,N=Math.max(0,Math.min(Z*t+I,i-1)),q=Math.max(0,Math.min(x*s+m,h-1)),it=Math.max(0,Math.min(N+t,i)),ht=Math.max(0,Math.min(q+s,h));for(let M=q;M<ht;M++)for(let Y=N;Y<it;Y++){const J=(M*i+Y)*4,K=k.data[J],at=k.data[J+1],y=k.data[J+2],B=k.data[J+3],e=`${K},${at},${y},${B}`,l=p.get(e);l?l.count++:p.set(e,{count:1,r:K,g:at,b:y,a:B})}let bt=0,X={r:0,g:0,b:0,a:255};for(const M of p.values())M.count>bt&&(bt=M.count,X=M);let Q=X;if(!u&&U.length>0){const M={r:X.r,g:X.g,b:X.b},Y=Ee(M,U);if(Dt==="tint"&&It){const J=It[Y.id];if(J!==void 0){const K=(Ht=n.colorGroups)==null?void 0:Ht.find(B=>B.id===Y.id),at=(K==null?void 0:K.baseHue)??0;Q={...ue(X.r,X.g,X.b,at,J),a:X.a}}}else if(Y.targetHex){const J=he(Y.targetHex);J&&(Q={...J,a:X.a})}else Q={r:Y.r,g:Y.g,b:Y.b,a:X.a}}const S=(x*A+Z)*4;tt.data[S]=Q.r,tt.data[S+1]=Q.g,tt.data[S+2]=Q.b,tt.data[S+3]=_?Q.a:255}rt.putImageData(tt,0,0);let et=1;if(!w){let x,Z;if(c==="NS"){const q=i>=h;x=q?535:321,Z=q?355:568}else{const q=c;x=i*q,Z=h*q}const p=Math.floor(x/A),N=Math.floor(Z/H);et=Math.max(1,Math.min(p,N))}const ot=A*et,nt=H*et,st=new OffscreenCanvas(ot,nt),dt=st.getContext("2d");if(!dt)throw new Error("Could not get final context");dt.imageSmoothingEnabled=!1,dt.drawImage(P,0,0,ot,nt);const Ot=await ne(st,c==="NS");self.postMessage({type:"complete",result:Ot});return}let ft=1;w||(c==="NS"?i>=h?ft=Math.min(535/i,355/h):ft=Math.min(321/i,568/h):ft=c);const Tt=new OffscreenCanvas(i,h),gt=Tt.getContext("2d",{willReadFrequently:!0,alpha:!0});if(!gt)throw new Error("Could not get native context");if(gt.drawImage(o,0,0),!d&&r>0){const t=gt.getImageData(0,0,i,h),s=De(t,r);gt.putImageData(s,0,0)}if(u){const t=Math.round(i*ft),s=Math.round(h*ft),I=new OffscreenCanvas(t,s),m=I.getContext("2d");if(!m)throw new Error("Could not get final context");m.imageSmoothingEnabled=!0,m.imageSmoothingQuality="high",m.drawImage(Tt,0,0,t,s);const A=await ne(I,c==="NS");self.postMessage({type:"complete",result:A});return}const vt=U,ut=gt.getImageData(0,0,i,h).data;let At=new Int16Array(i*h),zt=null;if(_){zt=new Uint8ClampedArray(i*h);for(let t=0;t<ut.length;t+=4)zt[t/4]=ut[t+3]}const Yt=new Map,pe=new Map,j=vt.length,T=new Uint8Array(j),G=new Uint8Array(j),E=new Uint8Array(j),Oe=new Array(j);for(let t=0;t<j;t++){const s=vt[t];pe.set(s.id,t),T[t]=s.r,G[t]=s.g,E[t]=s.b,Oe[t]=s.id}if(n.colorGroups)for(let t=0;t<n.colorGroups.length;t++){const s=n.colorGroups[t],I=pe.get(s.id);if(I!==void 0)for(let m=0;m<s.members.length;m++)Yt.set(s.members[m].hex.toLowerCase(),I)}for(let t=0;t<j;t++){const s=vt[t].hex.toLowerCase();Yt.has(s)||Yt.set(s,t)}for(let t=0;t<ut.length;t+=4){const s=ut[t],I=ut[t+1],m=ut[t+2],A=Be(s,I,m);let H=Yt.get(A);if(H===void 0){let W=1/0,z=0;for(let k=0;k<j;k++){const P=s-T[k],rt=I-G[k],tt=m-E[k],et=P*P+rt*rt+tt*tt;et<W&&(W=et,z=k)}H=z}At[t/4]=H}const Ft=d?0:f,xe=d?0:ct;if(Ft>0){let t=Math.max(1,Math.round(Ft/100*3)),s=Math.max(1,Math.round(Ft/100*4));Ft>66&&(t=3,s=3),Ft>85&&(t=5,s=5);const I=new Int16Array(At.length),m=new Uint32Array(j);for(let A=0;A<s;A++){for(let H=0;H<h;H++){const W=Math.max(0,H-t),z=Math.min(h-1,H+t),k=H*i;for(let P=0;P<i;P++){const rt=Math.max(0,P-t),tt=Math.min(i-1,P+t),et=k+P,ot=At[et],nt=et*4,st=ut[nt],dt=ut[nt+1],Ot=ut[nt+2];m.fill(0);for(let y=W;y<=z;y++){const B=y*i;for(let e=rt;e<=tt;e++){const l=At[B+e];m[l]++}}let x=0,Z=0,p=0,N=0,q=0,it=0;for(let y=0;y<j;y++){const B=m[y];B>Z?(q=p,it=N,p=x,N=Z,x=y,Z=B):B>N?(q=p,it=N,p=y,N=B):B>it&&(q=y,it=B)}if(x!==p&&p!==q){const y=T[x],B=G[x],e=E[x],l=T[p],b=G[p],v=E[p],O=T[q],D=G[q],C=E[q],R=Math.sqrt((y-O)**2+(B-D)**2+(e-C)**2),L=Math.sqrt((y-l)**2+(B-b)**2+(e-v)**2),$=Math.sqrt((O-l)**2+(D-b)**2+(C-v)**2);L+$<R*1.1&&(p=q,N=it)}const ht=(z-W+1)*(tt-rt+1);if(N<ht*.1&&(p=x),ot!==x&&ot!==p){const y=T[ot],B=G[ot],e=E[ot],l=T[x],b=G[x],v=E[x],O=T[p],D=G[p],C=E[p],R=(y-l)**2+(B-b)**2+(e-v)**2,L=(y-O)**2+(B-D)**2+(e-C)**2;I[et]=R<L?x:p;continue}const bt=T[x],X=G[x],Q=E[x],S=T[p],M=G[p],Y=E[p];let J=(st-bt)**2+(dt-X)**2+(Ot-Q)**2,K=(st-S)**2+(dt-M)**2+(Ot-Y)**2;const at=1-g/100*.8;ot===x&&(J*=at),ot===p&&(K*=at),I[et]=J<K?x:p}}At.set(I)}}const oe=ft*4,Fe=Math.round(i*oe),ke=Math.round(h*oe),me=1e7,Me=Fe*ke>me?Math.sqrt(me/(i*h)):oe,pt=Math.round(i*Me),Gt=Math.round(h*Me),be=new OffscreenCanvas(pt,Gt),qt=be.getContext("2d",{willReadFrequently:!0,alpha:!0});if(!qt)throw new Error("Could not get workspace context");qt.imageSmoothingEnabled=!0,qt.imageSmoothingQuality="high",qt.drawImage(Tt,0,0,pt,Gt);const Bt=qt.getImageData(0,0,pt,Gt).data,kt=new Uint8ClampedArray(Bt.length),Le=pt/i,Ue=Gt/h,xt=new Uint8Array(j),mt=new Uint8Array(j),Mt=new Uint8Array(j),je=Dt==="tint"&&It;for(let t=0;t<j;t++){const s=vt[t];if(je){const I=It[s.id];if(I!==void 0){const m=(St=n.colorGroups)==null?void 0:St.find(W=>W.id===s.id),A=(m==null?void 0:m.baseHue)??0,H=ue(s.r,s.g,s.b,A,I);xt[t]=H.r,mt[t]=H.g,Mt[t]=H.b}else xt[t]=T[t],mt[t]=G[t],Mt[t]=E[t]}else if(s.targetHex){const I=he(s.targetHex);I?(xt[t]=I.r,mt[t]=I.g,Mt[t]=I.b):(xt[t]=T[t],mt[t]=G[t],Mt[t]=E[t])}else xt[t]=T[t],mt[t]=G[t],Mt[t]=E[t]}const Rt=new Float32Array(j),se=new Uint8Array(j),ae=new Float32Array(j);for(let t=0;t<Gt;t++){const s=Math.min(h-1,Math.floor(t/Ue)),I=s*i;for(let m=0;m<pt;m++){const A=Math.min(i-1,Math.floor(m/Le)),W=(t*pt+m)*4,z=Bt[W],k=Bt[W+1],P=Bt[W+2],rt=Math.max(0,s-2),tt=Math.min(h-1,s+2),et=Math.max(0,A-2),ot=Math.min(i-1,A+2);Rt.fill(0);for(let e=rt;e<=tt;e++){const l=Math.abs(e-s),b=e*i;for(let v=et;v<=ot;v++){const O=Math.abs(v-A),D=At[b+v];let C=1;(O>0||l>0)&&(C=.5),(O>1||l>1)&&(C=.2),Rt[D]+=C}}const nt=[];for(let e=0;e<j;e++)Rt[e]>0&&nt.push(e);const st=[],dt=nt.length;t:for(let e=0;e<dt;e++){const l=nt[e],b=T[l],v=G[l],O=E[l],D=Rt[l];for(let C=0;C<dt;C++){const R=nt[C];if(R!==l)for(let L=0;L<dt;L++){const $=nt[L];if($===l||R===$)continue;const wt=T[R],lt=G[R],Et=E[R],F=T[$],V=G[$],Lt=E[$],Qt=Rt[R],Ut=Rt[$],jt=Math.sqrt((wt-F)**2+(lt-V)**2+(Et-Lt)**2),ce=Math.sqrt((wt-b)**2+(lt-v)**2+(Et-O)**2),we=Math.sqrt((F-b)**2+(V-v)**2+(Lt-O)**2);if(ce+we<jt*1.1&&jt>10&&Qt>D&&Ut>D)continue t}}st.push(l)}se.fill(0);const Ot=Math.max(0,s-1),x=Math.min(h-1,s+1),Z=Math.max(0,A-1),p=Math.min(i-1,A+1);for(let e=Ot;e<=x;e++){const l=e*i;for(let b=Z;b<=p;b++)se[At[l+b]]=1}const N=st.length;let q=-1/0,it=0;for(let e=0;e<N;e++){const l=st[e],b=T[l],v=G[l],O=E[l],D=Rt[l],C=z-b,R=k-v,L=P-O,$=C*C+R*R+L*L,wt=se[l]?0:-1e3,lt=D*10+wt-Math.sqrt($);ae[e]=lt,lt>q&&(q=lt,it=e)}let ht=N>0?st[it]:nt[0],bt=ht,X=-1/0;for(let e=0;e<N;e++)e!==it&&ae[e]>X&&(X=ae[e],bt=st[e]);X<=-500&&(bt=ht);const Q=At[I+A];let S=Q,M=ht,Y=!1;for(let e=0;e<N;e++)if(st[e]===Q){Y=!0;break}Y?(S=Q,M=Q===ht?bt:ht):(S=ht,M=bt),Rt[M]<.3&&(M=S);let K,at,y;if(S===M)K=xt[S],at=mt[S],y=Mt[S];else if(xe===0){const e=T[S],l=G[S],b=E[S],v=T[M],O=G[M],D=E[M],C=z-e,R=k-l,L=P-b,$=z-v,wt=k-O,lt=P-D,Et=C*C+R*R+L*L,F=$*$+wt*wt+lt*lt,V=Et<F?S:M;K=xt[V],at=mt[V],y=Mt[V]}else{const e=T[S],l=G[S],b=E[S],v=T[M],O=G[M],D=E[M],C=v-e,R=O-l,L=D-b,$=z-e,wt=k-l,lt=P-b,Et=C*C+R*R+L*L;let F=0;Et>0&&(F=Math.max(0,Math.min(1,($*C+wt*R+lt*L)/Et)));const V=xe/100;let Lt=!1;if(F>0&&F<1){const Wt=.4*(1-V*.5);if(F<Wt||F>1-Wt){const Pt=(e+v)/2,Nt=(l+O)/2,Xt=(b+D)/2,$t=e-Pt,Jt=l-Nt,Kt=b-Xt,le=$t*$t+Jt*Jt+Kt*Kt;let fe=!1;const Vt=V>.7?3:2;for(let te=-Vt;te<=Vt;te+=1){for(let ee=-Vt;ee<=Vt;ee+=1){if(ee===0&&te===0)continue;const $e=Math.max(0,Math.min(Gt-1,t+te)),ze=Math.max(0,Math.min(pt-1,m+ee)),de=($e*pt+ze)*4,Ye=Bt[de],_e=Bt[de+1],Ze=Bt[de+2],Se=Ye-Pt,ve=_e-Nt,Ae=Ze-Xt,Qe=Se*Se+ve*ve+Ae*Ae,Je=.6+V*.2;if(Qe<le*Je){fe=!0;break}}if(fe)break}fe||(Lt=!0)}}if(Lt&&(F=F<.5?0:1),F>0&&F<.25){const Wt=z-e,ie=k-l,Pt=P-b,Nt=e-v,Xt=l-O,$t=b-D,Jt=Wt*Wt+ie*ie+Pt*Pt,Kt=Nt*Nt+Xt*Xt+$t*$t,le=.05*(1-V);Jt<Kt*le&&(F=0)}const Qt=.15*(1-V);F<Qt&&(F=0),F>1-Qt&&(F=1);const Ut=28*(1-V)+8*V,jt=1/(1+Math.exp(-Ut*-.5)),ce=1/(1+Math.exp(-Ut*.5)),re=(1/(1+Math.exp(-Ut*(F-.5)))-jt)/(ce-jt),ye=xt[S],Ce=mt[S],Ie=Mt[S],Pe=xt[M],Ne=mt[M],Xe=Mt[M];K=Math.round(ye+re*(Pe-ye)),at=Math.round(Ce+re*(Ne-Ce)),y=Math.round(Ie+re*(Xe-Ie))}let B=255;if(_&&zt){const e=s*i+A,l=zt[e],b=Bt[W+3],v=(yt||0)/100;if(v===0)B=l;else{const O=b/255,D=20*(1-v)+2*v,C=1/(1+Math.exp(-D*-.5)),R=1/(1+Math.exp(-D*.5)),$=(1/(1+Math.exp(-D*(O-.5)))-C)/(R-C);B=Math.round($*255)}}kt[W]=K,kt[W+1]=at,kt[W+2]=y,kt[W+3]=B}}qt.putImageData(new ImageData(kt,pt,Gt),0,0);const _t=new OffscreenCanvas(Math.round(i*ft),Math.round(h*ft)),Zt=_t.getContext("2d",{alpha:!0});if(!Zt)throw new Error("Could not get final context");Zt.imageSmoothingEnabled=!0,Zt.imageSmoothingQuality="high",Zt.drawImage(be,0,0,_t.width,_t.height);const We=await ne(_t,c==="NS");self.postMessage({type:"complete",result:We})}catch(i){self.postMessage({type:"complete",error:i.message})}}})();
