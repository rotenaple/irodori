(function(){"use strict";const Xt=(B,i,M)=>{const w=y=>Math.max(0,Math.min(255,Math.round(y))).toString(16).padStart(2,"0");return`#${w(B)}${w(i)}${w(M)}`.toLowerCase()},pt=B=>{const i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(B);return i?{r:parseInt(i[1],16),g:parseInt(i[2],16),b:parseInt(i[3],16)}:null},zt=(B,i,M=1)=>{if(i.length===0)return{r:0,g:0,b:0,hex:"#000000",id:"default"};let w=1/0,y=i[0];const{r:Y,g:G,b:W}=B;for(let X=0;X<i.length;X++){const P=i[X];let z=(Y-P.r)**2+(G-P.g)**2+(W-P.b)**2;P.id.startsWith("group-")&&(z*=M*M),z<w&&(w=z,y=P)}return y},Qt=(B,i=1)=>{const{width:M,height:w,data:y}=B,Y=new ImageData(new Uint8ClampedArray(y),M,w),G=Y.data,W=(2*i+1)**2,X=new Uint8Array(W),P=new Uint8Array(W),z=new Uint8Array(W);for(let et=0;et<w;et++)for(let _=0;_<M;_++){let e=0;for(let H=-i;H<=i;H++){const v=et+H;if(v<0||v>=w)continue;const ot=v*M;for(let J=-i;J<=i;J++){const T=_+J;if(T<0||T>=M)continue;const st=(ot+T)*4;X[e]=y[st],P[e]=y[st+1],z[e]=y[st+2],e++}}const c=X.subarray(0,e).sort(),k=P.subarray(0,e).sort(),ft=z.subarray(0,e).sort(),O=Math.floor(e/2),s=(et*M+_)*4;G[s]=c[O],G[s+1]=k[O],G[s+2]=ft[O],G[s+3]=y[s+3]}return Y};self.onmessage=async B=>{var _;if(B.data.type!=="process")return;const{imageBitmap:i,parameters:M}=B.data,{upscaleFactor:w,denoiseRadius:y,edgeProtection:Y,vertexInertia:G,disablePostProcessing:W,disableRecoloring:X,disableScaling:P,palette:z,smoothingLevels:et}=M;try{const e=i.width,c=i.height;let k=1;P||(w==="NS"?e>=c?k=Math.min(535/e,355/c):k=Math.min(321/e,568/c):k=w);const ft=new OffscreenCanvas(e,c),O=ft.getContext("2d",{willReadFrequently:!0});if(!O)throw new Error("Could not get native context");if(O.drawImage(i,0,0),!W&&y>0){const o=O.getImageData(0,0,e,c),a=Qt(o,y);O.putImageData(a,0,0)}if(X){const o=Math.round(e*k),a=Math.round(c*k),u=new OffscreenCanvas(o,a),F=u.getContext("2d");if(!F)throw new Error("Could not get final context");F.imageSmoothingEnabled=!0,F.imageSmoothingQuality="high",F.drawImage(ft,0,0,o,a);const q=await u.convertToBlob({type:"image/png"});self.postMessage({type:"complete",result:q});return}const s=z,H=O.getImageData(0,0,e,c).data;let v=new Int16Array(e*c);const ot=new Map,J=new Map;s.forEach((o,a)=>J.set(o.id,a)),M.colorGroups&&M.colorGroups.forEach(o=>{const a=J.get(o.id);a!==void 0&&o.members.forEach(u=>{ot.set(u.hex.toLowerCase(),a)})}),s.forEach((o,a)=>{const u=o.hex.toLowerCase();ot.has(u)||ot.set(u,a)});for(let o=0;o<H.length;o+=4){const a=H[o],u=H[o+1],F=H[o+2],q=Xt(a,u,F);let b=ot.get(q);if(b===void 0){const D=zt({r:a,g:u,b:F},s),r=J.get(D.id);b=r!==void 0?r:0}v[o/4]=b}const T=W?0:Y,st=W?0:et;if(T>0){let o=Math.max(1,Math.round(T/100*3)),a=Math.max(1,Math.round(T/100*4));T>66&&(o=3,a=3),T>85&&(o=5,a=5);const u=new Int16Array(v.length),F=s.length;for(let q=0;q<a;q++){for(let b=0;b<c;b++){const Mt=Math.max(0,b-o),D=Math.min(c-1,b+o);for(let r=0;r<e;r++){const wt=Math.max(0,r-o),yt=Math.min(e-1,r+o),ct=b*e+r,Z=v[ct],A=ct*4,R={r:H[A],g:H[A+1],b:H[A+2]},tt=new Map;for(let l=Mt;l<=D;l++)for(let f=wt;f<=yt;f++){const g=v[l*e+f];tt.set(g,(tt.get(g)||0)+1)}const Q=Array.from(tt.entries()).sort((l,f)=>f[1]-l[1]);let E=Q[0][0],m=Q.length>1?Q[1][0]:E,bt=Q.length>2?Q[2][0]:m;if(E!==m&&m!==bt){const l=s[E],f=s[m],g=s[bt],t=Math.sqrt((l.r-g.r)**2+(l.g-g.g)**2+(l.b-g.b)**2),n=Math.sqrt((l.r-f.r)**2+(l.g-f.g)**2+(l.b-f.b)**2),x=Math.sqrt((g.r-f.r)**2+(g.g-f.g)**2+(g.b-f.b)**2);n+x<t*1.1&&(m=bt)}const Et=(D-Mt+1)*(yt-wt+1);if((tt.get(m)||0)<Et*.1&&(m=E),Z!==E&&Z!==m){const l=s[Z],f=s[E],g=s[m],t=(l.r-f.r)**2+(l.g-f.g)**2+(l.b-f.b)**2,n=(l.r-g.r)**2+(l.g-g.g)**2+(l.b-g.b)**2;u[ct]=t<n?E:m;continue}const U=s[E],lt=s[m];let nt=(R.r-U.r)**2+(R.g-U.g)**2+(R.b-U.b)**2,C=(R.r-lt.r)**2+(R.g-lt.g)**2+(R.b-lt.b)**2;const I=1-G/100*.8;Z===E&&(nt*=I),Z===m&&(C*=I),u[ct]=nt<C?E:m}}v.set(u)}}const At=k*4,Nt=Math.round(e*At),Yt=Math.round(c*At),Lt=1e7,Ft=Nt*Yt>Lt?Math.sqrt(Lt/(e*c)):At,L=Math.round(e*Ft),K=Math.round(c*Ft),Ut=new OffscreenCanvas(L,K),at=Ut.getContext("2d",{willReadFrequently:!0});if(!at)throw new Error("Could not get workspace context");at.imageSmoothingEnabled=!0,at.imageSmoothingQuality="high",at.drawImage(ft,0,0,L,K);const V=at.getImageData(0,0,L,K).data,xt=new Uint8ClampedArray(V.length),_t=L/e,Jt=K/c;for(let o=0;o<K;o++){const a=Math.min(c-1,Math.floor(o/Jt)),u=Math.max(0,a-1),F=Math.min(c-1,a+1);for(let q=0;q<L;q++){const b=Math.min(e-1,Math.floor(q/_t)),D=(o*L+q)*4,r={r:V[D],g:V[D+1],b:V[D+2]},wt=Math.max(0,a-2),yt=Math.min(c-1,a+2),ct=Math.max(0,b-2),Z=Math.min(e-1,b+2);let A=new Map;for(let t=wt;t<=yt;t++){const n=Math.abs(t-a);for(let x=ct;x<=Z;x++){const p=Math.abs(x-b),d=v[t*e+x];let S=1;(p>0||n>0)&&(S=.5),(p>1||n>1)&&(S=.2),A.set(d,(A.get(d)||0)+S)}}const R=Array.from(A.keys()),tt=R.filter(t=>{const n=s[t],x=A.get(t)||0;for(const p of R)for(const d of R){if(p===t||d===t||p===d)continue;const S=s[p],N=s[d],Ht=A.get(p)||0,Ct=A.get(d)||0,h=Math.sqrt((S.r-N.r)**2+(S.g-N.g)**2+(S.b-N.b)**2),$=Math.sqrt((S.r-n.r)**2+(S.g-n.g)**2+(S.b-n.b)**2),It=Math.sqrt((N.r-n.r)**2+(N.g-n.g)**2+(N.b-n.b)**2);if($+It<h*1.1&&h>10&&Ht>x&&Ct>x)return!1}return!0}),Q=new Set,E=Math.max(0,a-1),m=Math.min(c-1,a+1),bt=Math.max(0,b-1),Et=Math.min(e-1,b+1);for(let t=E;t<=m;t++)for(let n=bt;n<=Et;n++)Q.add(v[t*e+n]);const ut=tt.map(t=>{const n=s[t],x=A.get(t)||0,p=(r.r-n.r)**2+(r.g-n.g)**2+(r.b-n.b)**2,d=Q.has(t)?0:-1e3;return{id:t,score:x*10+d-Math.sqrt(p)}}).sort((t,n)=>n.score-t.score),U=((_=ut[0])==null?void 0:_.id)??R[0],lt=ut.length>1&&ut[1].score>-500?ut[1].id:U,nt=v[a*e+b];let C=nt,I=U;tt.includes(nt)?(C=nt,I=nt===U?lt:U):(C=U,I=lt),(A.get(I)||0)<.3&&(I=C);let g;if(C===I){const t=s[C];g={...t.targetHex?pt(t.targetHex):{r:t.r,g:t.g,b:t.b},id:t.id}}else if(st===0){const t=s[C],n=s[I],x=(r.r-t.r)**2+(r.g-t.g)**2+(r.b-t.b)**2,p=(r.r-n.r)**2+(r.g-n.g)**2+(r.b-n.b)**2,d=x<p?t:n;g={...d.targetHex?pt(d.targetHex):{r:d.r,g:d.g,b:d.b},id:d.id}}else{const t=s[C],n=s[I],x=n.r-t.r,p=n.g-t.g,d=n.b-t.b,S=r.r-t.r,N=r.g-t.g,Ht=r.b-t.b,Ct=x*x+p*p+d*d;let h=0;Ct>0&&(h=Math.max(0,Math.min(1,(S*x+N*p+Ht*d)/Ct)));const $=st/100;let It=!1;if(h>0&&h<1){const St=.4*(1-$*.5);if(h<St||h>1-St){const vt=(t.r+n.r)/2,j=(t.g+n.g)/2,dt=(t.b+n.b)/2,Ot=(t.r-vt)**2+(t.g-j)**2+(t.b-dt)**2;let mt=!1;const ht=$>.7?3:2;for(let qt=-ht;qt<=ht;qt+=1){for(let Dt=-ht;Dt<=ht;Dt+=1){if(Dt===0&&qt===0)continue;const Zt=Math.max(0,Math.min(K-1,o+qt)),tn=Math.max(0,Math.min(L-1,q+Dt)),Tt=(Zt*L+tn)*4,nn=V[Tt],en=V[Tt+1],on=V[Tt+2],sn=(nn-vt)**2+(en-j)**2+(on-dt)**2,an=.6+$*.2;if(sn<Ot*an){mt=!0;break}}if(mt)break}mt||(It=!0)}}if(It&&(h=h<.5?0:1),h>0&&h<.25){const St=r.r,Gt=r.g,vt=r.b,j=s[C],dt=s[I],Ot=(St-j.r)**2+(Gt-j.g)**2+(vt-j.b)**2,mt=(j.r-dt.r)**2+(j.g-dt.g)**2+(j.b-dt.b)**2,ht=.05*(1-$);Ot<mt*ht&&(h=0)}const $t=.15*(1-$);h<$t&&(h=0),h>1-$t&&(h=1);const Rt=28*(1-$)+8*$,jt=1/(1+Math.exp(-Rt*-.5)),Vt=1/(1+Math.exp(-Rt*.5)),Bt=(1/(1+Math.exp(-Rt*(h-.5)))-jt)/(Vt-jt),Pt=s[C],kt=s[I],gt=Pt.targetHex?pt(Pt.targetHex):Pt,Wt=kt.targetHex?pt(kt.targetHex):kt;g={r:Math.round(gt.r+Bt*(Wt.r-gt.r)),g:Math.round(gt.g+Bt*(Wt.g-gt.g)),b:Math.round(gt.b+Bt*(Wt.b-gt.b)),id:`blend-${C}-${I}`}}xt[D]=g.r,xt[D+1]=g.g,xt[D+2]=g.b,xt[D+3]=255}}at.putImageData(new ImageData(xt,L,K),0,0);const rt=new OffscreenCanvas(Math.round(e*k),Math.round(c*k)),it=rt.getContext("2d");if(!it)throw new Error("Could not get final context");it.fillStyle="#000000",it.fillRect(0,0,rt.width,rt.height),it.imageSmoothingEnabled=!0,it.imageSmoothingQuality="high",it.drawImage(Ut,0,0,rt.width,rt.height);const Kt=await rt.convertToBlob({type:"image/png"});self.postMessage({type:"complete",result:Kt})}catch(e){self.postMessage({type:"complete",error:e.message})}}})();
